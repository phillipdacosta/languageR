<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>My Lessons</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="loadLessons()">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="lessons-container">
    <!-- Loading state -->
    <div *ngIf="isLoading" class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading your lessons...</p>
    </div>

    <!-- Empty state -->
    <div *ngIf="!isLoading && lessons.length === 0" class="empty-state">
      <ion-icon name="calendar-outline"></ion-icon>
      <h2>No lessons scheduled</h2>
      <p>Book a lesson with a tutor to get started!</p>
      <ion-button routerLink="/tabs/tutor-search" fill="solid" color="primary">
        Find Tutors
      </ion-button>
    </div>

    <!-- Lessons list -->
    <div *ngIf="!isLoading && lessons.length > 0" class="lessons-list">
      <ion-card *ngFor="let lesson of lessons; trackBy: trackByLessonId" class="lesson-card">
        <ion-card-header>
          <div class="lesson-header">
            <div class="lesson-info">
              <ion-card-title>{{ lesson.subject }}</ion-card-title>
              <ion-card-subtitle>
                {{ formatLessonTime(lesson) }}
              </ion-card-subtitle>
            </div>
            <ion-chip [color]="getStatusColor(lesson)" class="status-chip">
              {{ getStatusText(lesson) }}
            </ion-chip>
          </div>
        </ion-card-header>

        <ion-card-content>
          <div class="participant-info">
            <ion-avatar>
              <img [src]="getOtherParticipant(lesson).picture || '/assets/default-avatar.png'" 
                   [alt]="getOtherParticipant(lesson).name">
            </ion-avatar>
            <div class="participant-details">
              <h3>{{ getUserRole(lesson) === 'student' ? 'Tutor' : 'Student' }}: {{ getOtherParticipant(lesson).name }}</h3>
              <p>{{ lesson.duration }} minutes â€¢ ${{ lesson.price }}</p>
            </div>
          </div>

          <!-- Join button for scheduled lessons -->
          <div *ngIf="lesson.status === 'scheduled'" class="lesson-actions">
            <div *ngIf="canJoinLesson(lesson); else waitingToJoin" class="join-ready">
              <ion-button 
                expand="block" 
                color="success" 
                size="large"
                (click)="joinLesson(lesson)">
                <ion-icon name="videocam" slot="start"></ion-icon>
                Join Lesson
              </ion-button>
            </div>
            
            <ng-template #waitingToJoin>
              <div class="waiting-info">
                <ion-icon name="time-outline"></ion-icon>
                <p>Available in {{ getTimeUntilJoin(lesson) }}</p>
                <ion-button 
                  fill="outline" 
                  color="medium" 
                  size="small"
                  (click)="cancelLesson(lesson)">
                  Cancel
                </ion-button>
              </div>
            </ng-template>
          </div>

          <!-- In progress indicator -->
          <div *ngIf="lesson.status === 'in_progress'" class="lesson-actions">
            <ion-button 
              expand="block" 
              color="warning" 
              size="large"
              (click)="joinLesson(lesson)">
              <ion-icon name="videocam" slot="start"></ion-icon>
              Rejoin Lesson
            </ion-button>
          </div>

          <!-- Completed lesson info -->
          <div *ngIf="lesson.status === 'completed'" class="completed-info">
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
            <span>Lesson completed</span>
          </div>

          <!-- Cancelled lesson info -->
          <div *ngIf="lesson.status === 'cancelled'" class="cancelled-info">
            <ion-icon name="close-circle" color="danger"></ion-icon>
            <span>Lesson cancelled</span>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
