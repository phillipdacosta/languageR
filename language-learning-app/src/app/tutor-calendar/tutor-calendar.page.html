<ion-content [fullscreen]="true" class="tutor-calendar-page" [class.disable-scroll]="isScreenLocked()">
  
  <!-- ðŸ§ª DEV TEST: Auto-Cancel Button -->
  <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
    <ion-button color="danger" (click)="testAutoCancelClass()" size="small" style="--box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
      <ion-icon name="warning" slot="start"></ion-icon>
      TEST Auto-Cancel
    </ion-button>
  </div>
  
  <!-- Reschedule Mode Banner -->
  <div class="reschedule-banner" *ngIf="rescheduleMode">
    <div class="reschedule-banner-content">
      <ion-icon name="calendar-outline"></ion-icon>
      <div class="reschedule-text">
        <strong>Reschedule Mode</strong>
        <p>Select a time that works for both you and your student</p>
      </div>
    </div>
    <ion-button fill="clear" size="small" (click)="router.navigate(['/tabs/home'])">
      <ion-icon name="close" slot="icon-only"></ion-icon>
    </ion-button>
  </div>
  
  <ng-container *ngIf="isMobileView; else desktopCalendar">
    <div class="mobile-header">
      <!-- <ion-button fill="clear" class="mobile-back-button" (click)="goBack()">
        <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
        Calendar
      </ion-button> -->
      <div class="mobile-header-actions">
        <ion-button fill="clear" class="mobile-settings-button" (click)="toggleMobileSettings()">
          <ion-icon [name]="showMobileSettings ? 'close-outline' : 'options-outline'"></ion-icon>
        </ion-button>
      </div>
    </div>

    <div class="mobile-settings-wrapper" [class.open]="showMobileSettings">
      <div class="mobile-settings-panel" *ngIf="showMobileSettings || panelAnimating">
        <div class="panel-section">
          <h3>Settings</h3>
          <ion-list lines="none">
            <ion-item button detail="false" (click)="setActiveTab('availability'); toggleMobileSettings()">
              <ion-icon name="time-outline" slot="start"></ion-icon>
              <ion-label>Availability</ion-label>
            </ion-item>
            <ion-item button detail="false" (click)="setActiveTab('booking'); toggleMobileSettings()">
              <ion-icon name="calendar-outline" slot="start"></ion-icon>
              <ion-label>Lesson booking settings</ion-label>
            </ion-item>
            <ion-item button detail="false" (click)="setActiveTab('calendar'); toggleMobileSettings()">
              <ion-icon name="settings-outline" slot="start"></ion-icon>
              <ion-label>Calendar settings</ion-label>
            </ion-item>
            <ion-item button detail="false" (click)="setActiveTab('google'); toggleMobileSettings()">
              <ion-icon name="logo-google" slot="start"></ion-icon>
              <ion-label>Google Calendar settings</ion-label>
            </ion-item>
          </ion-list>
        </div>

        <div class="panel-section">
          <h3>View Options</h3>
          <div class="option-item">
            <ion-checkbox [(ngModel)]="showPopularSlots" (ionChange)="togglePopularSlots()"></ion-checkbox>
            <label>Popular slots</label>
          </div>
        </div>

        <div class="panel-section">
          <h3>Quick Actions</h3>
            <ion-button expand="block" class="schedule-lesson-btn" (click)="onScheduleLesson(); toggleMobileSettings()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Schedule Class
            </ion-button>
            <ion-button expand="block" fill="outline" (click)="onAddTimeOff(); toggleMobileSettings()">
              <ion-icon name="time-outline" slot="start"></ion-icon>
              Add time off
            </ion-button>
            <ion-button expand="block" fill="outline" (click)="onAddExtraSlots(); toggleMobileSettings()">
              <ion-icon name="add-circle-outline" slot="start"></ion-icon>
              Add extra slots
            </ion-button>
            <ion-button expand="block" fill="outline" (click)="onSetUpAvailability(); toggleMobileSettings()">
              <ion-icon name="settings-outline" slot="start"></ion-icon>
              Set up availability
            </ion-button>
          </div>

          <div class="panel-section">
            <ion-button expand="block" class="google-btn" (click)="connectGoogleCalendar(); toggleMobileSettings()">
              <ion-icon name="logo-google" slot="start"></ion-icon>
              Connect calendar
            </ion-button>
          </div>
        </div>
    </div>

    <div class="mobile-calendar-wrapper">
      <div class="mobile-view-toggle">
        <button type="button" [class.active]="mobileViewMode === 'day'" (click)="setMobileViewMode('day')" [disabled]="isScreenLocked()">Day</button>
        <button type="button" [class.active]="mobileViewMode === 'agenda'" (click)="setMobileViewMode('agenda')" [disabled]="isScreenLocked()">Agenda</button>
      </div>

      <!-- Temporarily commented out schedule legend -->
      <!-- <div class="schedule-legend">
        <h4>Your Schedule</h4>
        <div class="legend-items">
          <div class="legend-item">
            <span class="legend-dot available"></span>
            <span>Available for booking</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot open"></span>
            <span>Open time slot</span>
          </div>
          <div class="legend-item">
            <span class="legend-dot booked"></span>
            <span>Booked lesson</span>
          </div>
        </div>
      </div> -->

      <ng-container [ngSwitch]="mobileViewMode">
        <ng-container *ngSwitchCase="'day'">
          <div class="mobile-day-strip">
            <ion-button fill="clear" size="small" class="day-nav-btn" (click)="shiftMobileDays(-4)" [disabled]="isScreenLocked()">
              <ion-icon name="chevron-back-outline"></ion-icon>
            </ion-button>
            <div class="day-chip-list">
              <button
                type="button"
                *ngFor="let day of mobileDays; let i = index"
                class="day-chip"
                [class.active]="i === selectedMobileDayIndex"
                (click)="selectMobileDay(i)"
                [disabled]="isScreenLocked()">
                <span class="chip-short">{{ day.shortDay }}</span>
                <span class="chip-number">{{ day.dayNumber }}</span>
              </button>
            </div>
            <ion-button fill="clear" size="small" class="day-nav-btn" (click)="shiftMobileDays(4)" [disabled]="isScreenLocked()">
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small" class="today-link" (click)="goToMobileToday()" [disabled]="isScreenLocked()">Today</ion-button>
          </div>

          <div class="mobile-date-header" *ngIf="selectedMobileDay as activeDay">
            <div class="date-day">{{ activeDay.isToday ? 'Today' : activeDay.dayName }}</div>
            <div class="date-month">{{ activeDay.monthLabel }} {{ activeDay.dayNumber }}</div>
          </div>

          <div class="schedule-legend">
            <h4>Your Schedule</h4>
            <div class="legend-items">
              <div class="legend-item">
                <span class="legend-dot cancelled"></span>
                <span>Cancelled lesson</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot booked"></span>
                <span>Booked lesson</span>
              </div>
            </div>
          </div>

          <!-- Show nothing while loading -->
          <ng-container *ngIf="!isLoadingMobileData">
            <div class="mobile-timeline-simple" *ngIf="mobileTimelineEvents.length > 0; else emptyTimeline">
              <!-- Timeline events -->
              <div *ngFor="let item of mobileTimelineEvents" class="timeline-row" [class.past]="item.isPast" [class.happening-now]="item.isHappeningNow" [class.is-cancelled]="item.isCancelled" [@slideInUp]="item.isPast ? 'void' : 'in'">
                <div class="time-column">
                  <div class="time-display" [class.now]="item.isHappeningNow">
                    <span *ngIf="item.isHappeningNow" class="now-badge">Now</span>
                    <span>{{ formatTime(item.start) }} ({{ formatDurationShort(item.durationMinutes) }})</span>
                  </div>
                </div>
                <div class="event-column">
                  <div class="timeline-entry">
                    <div class="timeline-marker" [style.background]="item.color || '#667eea'"></div>
                    <div class="timeline-card" 
                         [class.past]="item.isPast" 
                         [class.happening-now]="item.isHappeningNow"
                         [class.is-cancelled]="item.isCancelled"
                         [class.trial-lesson]="item.isTrialLesson"
                         [class.office-hours]="item.isOfficeHours"
                         [class.clickable]="item.id"
                         (click)="item.id && onEventClick(item)">
                      <!-- Trial Badge -->
                      <div class="trial-corner-badge" *ngIf="item.isTrialLesson">
                        <ion-icon name="star"></ion-icon>
                      </div>
                      <!-- Office Hours Badge -->
                      <div class="office-hours-corner-badge" *ngIf="item.isOfficeHours">
                        <ion-icon name="flash"></ion-icon>
                      </div>
                      <div class="card-header" [class.has-avatar]="(item.avatarUrl && !item.isClass) || (item.isClass && item.thumbnail)">
                        <ng-container *ngIf="item.avatarUrl && !item.isClass">
                          <img [src]="item.avatarUrl" alt="" class="card-avatar" />
                        </ng-container>
                        <ng-container *ngIf="item.isClass">
                          <img *ngIf="item.thumbnail" [src]="item.thumbnail" alt="" class="card-avatar class-thumbnail" />
                          <ion-icon *ngIf="!item.thumbnail" name="people" class="card-avatar class-icon"></ion-icon>
                        </ng-container>
                        <div class="card-text">
                          <div class="title">{{ item.title }}</div>
                          <div class="subtitle" *ngIf="item.subtitle">{{ item.subtitle }}</div>
                        </div>
                      </div>
                      <!-- Class Attendees (if it's a class) -->
                      <app-class-attendees 
                        *ngIf="item.isClass && item.attendees"
                        [attendees]="item.attendees"
                        [capacity]="item.capacity"
                        [maxDisplay]="3">
                      </app-class-attendees>
                      <div class="location" *ngIf="item.location">{{ item.location }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <ng-template #emptyTimeline>
              <div class="timeline-empty">
                <ion-icon name="calendar-outline"></ion-icon>
                <p>No lessons</p>
              </div>
            </ng-template>
          </ng-container>

          <!-- <ion-fab vertical="bottom" horizontal="end" slot="fixed">
            <ion-fab-button color="primary" (click)="onScheduleLesson()" [disabled]="isScreenLocked()">
              <ion-icon name="add-outline"></ion-icon>
            </ion-fab-button>
          </ion-fab> -->
        </ng-container>

        <ng-container *ngSwitchCase="'agenda'">
          <div class="mobile-day-strip agenda-strip">
            <ion-button fill="clear" size="small" class="day-nav-btn" (click)="shiftMobileDays(-agendaDaysToShow)" [disabled]="isScreenLocked()">
              <ion-icon name="chevron-back-outline"></ion-icon>
            </ion-button>
            <div class="agenda-range-label">{{ agendaRangeLabel }}</div>
            <ion-button fill="clear" size="small" class="day-nav-btn" (click)="shiftMobileDays(agendaDaysToShow)" [disabled]="isScreenLocked()">
              <ion-icon name="chevron-forward-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small" class="today-link" (click)="goToMobileToday()" [disabled]="isScreenLocked()">Current Week</ion-button>
          </div>
          
          <div class="schedule-legend">
            <h4>Your Schedule</h4>
            <div class="legend-items">
              <div class="legend-item">
                <span class="legend-dot available"></span>
                <span>Available for booking</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot open"></span>
                <span>Open time slot</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot cancelled"></span>
                <span>Cancelled lesson</span>
              </div>
              <div class="legend-item">
                <span class="legend-dot booked"></span>
                <span>Booked lesson</span>
              </div>
            </div>
          </div>
          
          <!-- Show nothing while loading -->
          <ng-container *ngIf="!isLoadingMobileData">
            <div class="mobile-agenda" *ngIf="mobileAgendaSections.length > 0; else agendaEmpty">
              <div class="agenda-section" *ngFor="let section of mobileAgendaSections">
                <div class="agenda-header">
                  <div class="agenda-label-group">
                    <div class="agenda-label" [class.is-today]="section.isToday">{{ section.isToday ? 'Today' : section.dayLabel }}</div>
                    <div class="agenda-date">{{ section.dateLabel }}</div>
                  </div>
                  <div class="agenda-relative" *ngIf="section.relativeLabel">{{ section.relativeLabel }}</div>
                </div>
                <div class="agenda-items" *ngIf="section.events.length > 0; else noAgendaEvents">
                  <div class="agenda-item" *ngFor="let item of section.events" [class.is-cancelled]="item.isCancelled">
                    <div class="timeline-entry" [class.free]="item.type === 'free'" [class.past]="item.isPast" [class.is-cancelled]="item.isCancelled">
                      <div class="timeline-marker" [style.background]="item.type === 'event' ? (item.color || '#667eea') : null"></div>
                      <div class="timeline-card" 
                           [class.free]="item.type === 'free'" 
                           [class.past]="item.isPast" 
                           [class.is-cancelled]="item.isCancelled"
                           [class.trial-lesson]="item.isTrialLesson"
                           [class.office-hours]="item.isOfficeHours"
                           [class.clickable]="item.type === 'event' && item.id"
                           (click)="item.type === 'event' && item.id && onEventClick(item)">
                        <!-- Trial Badge -->
                        <div class="trial-corner-badge" *ngIf="item.isTrialLesson">
                          <ion-icon name="star"></ion-icon>
                        </div>
                        <!-- Office Hours Badge -->
                        <div class="office-hours-corner-badge" *ngIf="item.isOfficeHours">
                          <ion-icon name="flash"></ion-icon>
                        </div>
                        <div class="time-range" *ngIf="item.type !== 'free'">{{ formatTime(item.start) }} â€¢ {{ formatTime(item.end) }}</div>
                        <ng-container *ngIf="item.type === 'event'; else agendaFreeBlock">
                          <div class="card-header" [class.has-avatar]="(item.avatarUrl && !item.isClass) || (item.isClass && item.thumbnail)">
                            <ng-container *ngIf="item.avatarUrl && !item.isClass">
                              <img [src]="item.avatarUrl" alt="" class="card-avatar" />
                            </ng-container>
                            <ng-container *ngIf="item.isClass">
                              <img *ngIf="item.thumbnail" [src]="item.thumbnail" alt="" class="card-avatar class-thumbnail" />
                              <ion-icon *ngIf="!item.thumbnail" name="people" class="card-avatar class-icon"></ion-icon>
                            </ng-container>
                            <div class="card-text">
                              <div class="title">{{ item.title }}</div>
                              <div class="subtitle" *ngIf="item.subtitle">{{ item.subtitle }}</div>
                            </div>
                          </div>
                          <!-- Class Attendees (if it's a class) -->
                          <app-class-attendees 
                            *ngIf="item.isClass && item.attendees"
                            [attendees]="item.attendees"
                            [capacity]="item.capacity"
                            [maxDisplay]="3">
                          </app-class-attendees>
                          <div class="meta" *ngIf="item.meta">{{ item.meta }}</div>
                          <div class="location" *ngIf="item.location">{{ item.location }}</div>
                        </ng-container>
                        <ng-template #agendaFreeBlock>
                          <div class="free-slot-content" (click)="onFreeSlotClick(section.date, item); $event.stopPropagation()">
                            <span class="free-duration">{{ formatDurationShort(item.durationMinutes) }} open</span>
                            <button type="button" class="free-add-icon" aria-label="Add availability">
                              <ion-icon name="add-outline"></ion-icon>
                            </button>
                          </div>
                        </ng-template>
                      </div>
                    </div>
                  </div>
                </div>
                <ng-template #noAgendaEvents>
                  <div class="agenda-empty">No events scheduled.</div>
                </ng-template>
              </div>
            </div>
            <ng-template #agendaEmpty>
              <div class="timeline-empty">
                <ion-icon name="sunny-outline"></ion-icon>
                <p>No upcoming events.</p>
              </div>
            </ng-template>
          </ng-container>
          
          <!-- <ion-fab vertical="bottom" horizontal="end" slot="fixed">
            <ion-fab-button color="primary" (click)="onScheduleLesson()" [disabled]="isScreenLocked()">
              <ion-icon name="add-outline"></ion-icon>
            </ion-fab-button>
          </ion-fab> -->
        </ng-container>
      </ng-container>
    </div>

  </ng-container>

  <ng-template #desktopCalendar>
    <div class="calendar-layout">
      <!-- Left Sidebar -->
      <div class="calendar-sidebar">
        <!-- Mobile Sidebar Header -->
        <div class="sidebar-header" (click)="toggleSidebar()">
          <h3>Calendar Tools</h3>
          <ion-icon
            name="chevron-down-outline"
            class="sidebar-expand-icon"
            [class.expanded]="sidebarExpanded">
          </ion-icon>
        </div>

        <!-- Sidebar Content -->
        <div class="sidebar-content" [class.expanded]="sidebarExpanded">
          <!-- Action Buttons -->
          <div class="action-buttons">
            <ion-button size="small" class="schedule-lesson-btn" (click)="onScheduleLesson()">
              <ion-icon name="add-outline" slot="start"></ion-icon>
              Schedule Class
            </ion-button>

            <ion-button expand="block" fill="outline" class="action-btn" (click)="onAddTimeOff()" [disabled]="isScreenLocked()">
              <ion-icon name="time-outline" slot="start"></ion-icon>
              Add time off
            </ion-button>

            <ion-button expand="block" fill="outline" class="action-btn" (click)="onAddExtraSlots()" [disabled]="isScreenLocked()">
              <ion-icon name="add-circle-outline" slot="start"></ion-icon>
              Add extra slots
            </ion-button>

            <ion-button expand="block" fill="outline" class="action-btn" (click)="onSetUpAvailability()" [disabled]="isScreenLocked()">
              <ion-icon name="settings-outline" slot="start"></ion-icon>
              Set up availability
            </ion-button>
          </div>

          <!-- Tags Section -->
          <div class="tags-section">
            <div class="section-header" (click)="toggleTags()">
              <h4>Keys</h4>
              <ion-icon
                name="chevron-down-outline"
                class="expand-icon"
                [class.expanded]="tagsExpanded">
              </ion-icon>
            </div>
            <div class="tag-list" [class.expanded]="tagsExpanded">
              <div class="tag-item" [style.border-left-color]="'#10b981'">
                <div class="tag-color" style="background-color: #10b981;"></div>
                <span>Your availability</span>
              </div>
              <div class="tag-item" [style.border-left-color]="'#3b82f6'">
                <div class="tag-color" style="background-color: #3b82f6;"></div>
                <span>Single lesson</span>
              </div>
              <div class="tag-item" [style.border-left-color]="'#8b5cf6'">
                <div class="tag-color" style="background-color: #8b5cf6;"></div>
                <span>Class</span>
              </div>
              <div class="tag-item" [style.border-left-color]="'#ec4899'">
                <div class="tag-color" style="background-color: #ec4899;"></div>
                <span>Weekly lesson</span>
              </div>
              <div class="tag-item" [style.border-left-color]="'#f59e0b'">
                <div class="tag-color" style="background-color: #f59e0b;"></div>
                <span>Time off</span>
              </div>
              <div class="tag-item" [style.border-left-color]="'#6b7280'">
                <div class="tag-color" style="background-color: #6b7280;"></div>
                <span>Google Calendar</span>
              </div>
            </div>
          </div>

          <!-- Lesson Status Section -->
          <div class="lesson-status-section">
            <div class="section-header" (click)="toggleLessonStatus()">
              <h4>Lesson status</h4>
              <ion-icon
                name="chevron-down-outline"
                class="expand-icon"
                [class.expanded]="lessonStatusExpanded">
              </ion-icon>
            </div>
            <div class="status-list" [class.expanded]="lessonStatusExpanded">
              <div class="status-item">
                <ion-icon name="time-outline" class="status-icon"></ion-icon>
                <span>Awaiting confirmation</span>
              </div>
              <div class="status-item">
                <ion-icon name="checkmark-circle-outline" class="status-icon"></ion-icon>
                <span>Confirmed lesson</span>
              </div>
              <div class="status-item">
                <ion-icon name="calendar-outline" class="status-icon"></ion-icon>
                <span>Requested time</span>
              </div>
            </div>
          </div>
        </div> <!-- Close sidebar-content -->
      </div>

      <!-- Main Calendar Area -->
      <div class="main-calendar">
        <!-- Loading State for Desktop Calendar -->
        <div class="calendar-loading-overlay" *ngIf="!isDesktopCalendarReady">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Loading calendar...</p>
        </div>
        
        <!-- CUSTOM CALENDAR (NEW) -->
        <div class="custom-calendar-wrapper" [style.opacity]="isDesktopCalendarReady ? '1' : '0'" [style.transition]="'opacity 0.3s ease-in-out'">
          <!-- Calendar Toolbar -->
          <div class="custom-toolbar">
            <div class="toolbar-left">
              <button class="nav-btn" (click)="navigatePrevious()">
                <ion-icon name="chevron-back"></ion-icon>
              </button>
              <button class="nav-btn" (click)="navigateNext()">
                <ion-icon name="chevron-forward"></ion-icon>
              </button>
              <button class="today-btn" (click)="navigateToday()">Today</button>
            </div>
            <h2 class="calendar-title" *ngIf="customView === 'week'">{{ currentWeekTitle }}</h2>
            <h2 class="calendar-title" *ngIf="customView === 'day'">{{ selectedDayForDayView.monthLabel }} {{ selectedDayForDayView.year }}</h2>
            <div class="toolbar-right">
              <div class="view-switcher">
                <button [class.active]="customView === 'week'" (click)="switchView('week')">Week</button>
                <button [class.active]="customView === 'day'" (click)="switchView('day')">Day</button>
              </div>
            </div>
          </div>

          <!-- Week View Grid -->
          <div class="custom-week-grid" *ngIf="customView === 'week'">
            <!-- Day Headers -->
            <div class="week-header">
              <div class="time-gutter"></div>
              <div class="day-header" *ngFor="let day of weekDays" [class.today]="day.date | isToday">
                <div class="day-name">{{ day.shortDay }}</div>
                <div class="day-number">{{ day.dayNumber }}</div>
              </div>
            </div>

            <!-- Time Grid -->
            <div class="week-body" #weekBodyContainer>
              <div class="time-column">
                <div class="time-slot" *ngFor="let hour of timeSlots">
                  <span class="time-label">{{ hour }}</span>
                </div>
              </div>

              <!-- Day Columns -->
              <div class="day-columns">
                <div class="day-column" *ngFor="let day of weekDays">
                  <!-- Hour lines -->
                  <div class="hour-line" *ngFor="let hour of timeSlots"></div>
                  
                  <!-- Events for this day -->
                  <div class="event-container">
                    <div *ngFor="let event of events | eventsForDay:day" 
                         class="calendar-event"
                         style="border-radius: 5px;"
                         [class.availability-event]="event.isAvailability"
                         [class.class-event]="event.isClass"
                         [class.is-cancelled]="event.extendedProps?.isCancelled"
                         [style.top.px]="event | eventTop"
                         [style.height.px]="event | eventHeight"
                         [class.past]="event | isEventPast"
                         [class.short-event]="(event | eventHeight) < 45"
                         [class.compact-event]="(event | eventHeight) < 30"
                         (click)="handleEventClick(event)">
                      <div class="event-header">
                        <!-- First row: Time and duration (left aligned) -->
                        <div class="event-time-row">
                          <div class="event-time">{{ event | eventTime }}</div>
                        </div>
                        
                        <!-- Second row: Avatar and name (left aligned) -->
                        <div class="event-info-row">
                          <img *ngIf="event.studentAvatar && !event.isAvailability" 
                               [src]="event.studentAvatar" 
                               class="event-avatar" 
                               alt="Student avatar">
                          <div class="event-title" *ngIf="!event.isAvailability">{{ event.studentName }}</div>
                          <div class="event-title" *ngIf="event.isAvailability">{{ event.title }}</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Current time indicator -->
                  <div class="time-indicator" *ngIf="day.date | isToday" [style.top.px]="currentTimePosition"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Day View -->
          <div class="custom-day-view" *ngIf="customView === 'day'">
            <!-- Day Header -->
            <div class="day-view-header">
              <div class="day-view-date">
                <h3>{{ selectedDayForDayView.dayName }}</h3>
                <p>{{ selectedDayForDayView.monthLabel }} {{ selectedDayForDayView.dayNumber }}, {{ selectedDayForDayView.year }}</p>
              </div>
              <div class="day-view-free-hours" 
                   *ngIf="(events | freeHours:selectedDayForDayView) > 0">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ events | freeHours:selectedDayForDayView }}h available</span>
                <div class="hours-tooltip">
                  <div class="tooltip-row">
                    <span class="tooltip-label">Total availability:</span>
                    <span class="tooltip-value">{{ events | totalAvailability:selectedDayForDayView }}h</span>
                  </div>
                  <div class="tooltip-row">
                    <span class="tooltip-label">Booked lessons:</span>
                    <span class="tooltip-value">{{ events | bookedHours:selectedDayForDayView }}h</span>
                  </div>
                  <div class="tooltip-divider"></div>
                  <div class="tooltip-row total">
                    <span class="tooltip-label">Available:</span>
                    <span class="tooltip-value">{{ events | freeHours:selectedDayForDayView }}h</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Time Grid -->
            <div class="day-view-body" #dayViewBodyContainer>
              <div class="time-column">
                <div class="time-slot" *ngFor="let hour of timeSlots">
                  <span class="time-label">{{ hour }}</span>
                </div>
              </div>

              <div class="day-content">
                <!-- Hour lines -->
                <div class="hour-line" *ngFor="let hour of timeSlots"></div>
                
                <!-- Events for selected day -->
                <div class="event-container" *ngIf="(events | eventsForSelectedDay:selectedDayForDayView).length > 0; else noEventsTemplate">
                  <div *ngFor="let event of events | eventsForSelectedDay:selectedDayForDayView" 
                       class="calendar-event"
                       style="border-radius: 5px;"
                       [class.availability-event]="event.isAvailability"
                       [class.class-event]="event.isClass"
                       [class.is-cancelled]="event.extendedProps?.isCancelled"
                       [style.top.px]="event | eventTop"
                       [style.height.px]="event | eventHeight"
                       [class.past]="event | isEventPast"
                       [class.short-event]="(event | eventHeight) < 45"
                       [class.compact-event]="(event | eventHeight) < 30"
                       (click)="handleEventClick(event)">
                    <div class="event-header">
                      <!-- First row: Time and duration (left aligned) -->
                      <div class="event-time-row">
                        <div class="event-time">{{ event | eventTime }}</div>
                      </div>
                      
                      <!-- Second row: Avatar and name (left aligned) -->
                      <div class="event-info-row">
                        <img *ngIf="event.studentAvatar && !event.isAvailability" 
                             [src]="event.studentAvatar" 
                             class="event-avatar" 
                             alt="Student avatar">
                        <div class="event-title" *ngIf="!event.isAvailability">{{ event.studentName }}</div>
                        <div class="event-title" *ngIf="event.isAvailability">{{ event.title }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <ng-template #noEventsTemplate>
                  <div class="no-events-placeholder">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <h4>No events scheduled</h4>
                    <p>You don't have any lessons or availability blocks for this day</p>
                  </div>
                </ng-template>

                <!-- Current time indicator -->
                <div class="time-indicator" *ngIf="selectedDayForDayView.date | isToday" [style.top.px]="currentTimePosition"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- FULLCALENDAR (COMMENTED OUT - BACKUP) -->
        <!-- 
        <div id="tutor-calendar-container">
          <div
            *ngIf="customNowVisible"
            class="custom-now-indicator"
            [style.top.px]="customNowTop"
            [style.left.px]="customNowLeft"
            [style.width.px]="customNowWidth"
          >
            <span class="custom-now-dot"></span>
          </div>
          <div class="calendar-loading" *ngIf="!isInitialized">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Loading calendar...</p>
          </div>
        </div>
        -->

        <!-- Help Button -->
        <!-- <ion-button class="help-button" fill="clear" size="small" (click)="onHelpClick()">
          <ion-icon name="help-circle-outline"></ion-icon>
        </ion-button> -->
      </div>
    </div>
  </ng-template>
</ion-content>
