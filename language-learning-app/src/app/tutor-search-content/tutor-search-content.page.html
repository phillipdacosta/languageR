<!-- tutor-search-content.page.html -->
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start" *ngIf="showFiltersView">
      <ion-button (click)="closeFilters()">
        <ion-icon name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ showFiltersView ? 'Filters' : 'Find Tutors' }}</ion-title>
    <ion-buttons slot="end" *ngIf="showFiltersView">
      <ion-button (click)="clearFilters()">Clear</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Show message for tutors -->
  <div *ngIf="currentUser?.userType === 'tutor'" class="tutor-redirect-message">
    <ion-card>
      <ion-card-content>
        <h2>Redirecting...</h2>
        <p>Tutors should use the Calendar page to manage their schedule.</p>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Main content only for students -->
  <div *ngIf="currentUser?.userType === 'student'">
  <!-- Main Content View -->
  <div class="main-content-view" *ngIf="!showFiltersView">
    <div class="filters-container">
      <!-- Top Row Filters - Always visible -->
      <div class="top-filters">
        <!-- Language Search - Always visible -->
        <div class="filter-item language-filter" 
             [class.dropdown-open]="showLanguageDropdown"
             (click)="toggleLanguageDropdown(); $event.stopPropagation()">
          <label>I want to learn</label>
          <div class="filter-value-wrapper">
            <span class="filter-value">{{ getCurrentLanguageLabel() }}</span>
            <app-flag-icon *ngIf="filters.language && filters.language !== 'any'" [language]="filters.language" [size]="16" cssClass="filter-flag"></app-flag-icon>
            <ion-icon name="close-outline" class="clear-icon" *ngIf="filters.language && filters.language !== 'any'" (click)="selectLanguage('any'); $event.stopPropagation()"></ion-icon>
            <ion-icon name="chevron-down-outline" [class.rotated]="showLanguageDropdown" *ngIf="!filters.language || filters.language === 'any'"></ion-icon>
          </div>
          
          <!-- Language Dropdown -->
          <div class="language-dropdown" *ngIf="showLanguageDropdown" (click)="$event.stopPropagation()">
            <div class="dropdown-option" 
                 *ngFor="let lang of availableLanguages" 
                 [class.selected]="filters.language === lang.value"
                 (click)="selectLanguage(lang.value); $event.stopPropagation()">
              <span>{{ lang.label }}</span>
              <app-flag-icon *ngIf="lang.value !== 'any'" [language]="lang.value" [size]="14" cssClass="dropdown-flag"></app-flag-icon>
            </div>
          </div>
        </div>

        <!-- Desktop Filters - Hidden on mobile -->
        <div class="desktop-only-filters">
          <div class="filter-item price-filter">
            <label>Price per lesson</label>
            <div class="price-display">${{ filters.priceMin }} – ${{ filters.priceMax }}</div>
            <div class="price-slider-container">
              <ion-range 
                [value]="priceRange" 
                (ionChange)="onPriceRangeChange($event)" 
                dual-knobs="true" 
                min="0" 
                max="200" 
                pin="true"
                class="price-range-slider">
                <ion-label slot="start">$0</ion-label>
                <ion-label slot="end">$200+</ion-label>
              </ion-range>
            </div>
          </div>

          <div class="filter-item" (click)="openCountryFilter()">
            <label>Country of birth</label>
            <div class="filter-value-wrapper">
              <span class="filter-value">Any country</span>
              <ion-icon name="chevron-down-outline"></ion-icon>
            </div>
          </div>

          <div class="filter-item" (click)="openAvailabilityFilter()">
            <label>I'm available</label>
            <div class="filter-value-wrapper">
              <span class="filter-value">Any time</span>
              <ion-icon name="chevron-down-outline"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Mobile Filter Button - Only visible on mobile -->
        <ion-button class="mobile-filters-btn" fill="outline" (click)="openFiltersView()">
          <ion-icon slot="start" name="options-outline"></ion-icon>
          Filters
          <ion-badge *ngIf="getActiveFilterCount() > 0" class="filter-badge" color="primary">{{ getActiveFilterCount() }}</ion-badge>
        </ion-button>
      </div>

      <!-- Secondary Filters Row - Collapsible -->
      <div class="secondary-filters-toggle">
        <ion-button fill="clear" size="small" (click)="toggleSecondaryFilters()" class="more-filters-btn">
          <ion-icon [name]="showSecondaryFilters ? 'chevron-up-outline' : 'chevron-down-outline'" slot="start"></ion-icon>
          {{ showSecondaryFilters ? 'Less filters' : 'More filters' }}
          <ion-badge *ngIf="getActiveFilterCount() > 0" class="filter-badge" color="primary">{{ getActiveFilterCount() }}</ion-badge>
        </ion-button>
        
        <ion-button fill="clear" size="small" (click)="clearFilters()" class="clear-filters-btn" [disabled]="getActiveFilterCount() === 0">
          <ion-icon name="close-circle-outline" slot="start"></ion-icon>
          Clear Filters
        </ion-button>
      </div>

      <!-- Secondary Filters Row -->
      <div class="secondary-filters" *ngIf="showSecondaryFilters">
        <ion-button class="filter-chip" fill="outline" size="small" (click)="openSpecialtiesFilter()">
          Specialties
        </ion-button>

        <ion-button class="filter-chip" fill="outline" size="small" (click)="openGenderFilter()">
          Gender
        </ion-button>

        <ion-button class="filter-chip" fill="outline" size="small" (click)="openNativeSpeakerFilter()">
          Native
        </ion-button>

        <ion-button class="filter-chip" fill="outline" size="small" (click)="openSortFilter()">
          Sort
        </ion-button>

        <div class="search-input-wrapper">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input type="text" placeholder="Search by name" class="search-input">
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading && tutors.length === 0">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Finding tutors...</p>
    </div>

    <!-- Results Header with View Toggle -->
    <div class="results-header" *ngIf="searchResponse && !isLoading">
      <h2>{{ searchResponse.pagination.totalCount }} {{ filters.language !== 'any' ? filters.language : '' }} tutors available</h2>
      <div class="view-toggle desktop-only">
        <ion-button 
          [fill]="viewMode === 'grid' ? 'solid' : 'clear'" 
          size="small" 
          (click)="toggleViewMode('grid')">
          <ion-icon name="grid-outline"></ion-icon>
        </ion-button>
        <ion-button 
          [fill]="viewMode === 'list' ? 'solid' : 'clear'" 
          size="small" 
          (click)="toggleViewMode('list')">
          <ion-icon name="list-outline"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Tutors Container with Dynamic Layout -->
      <div class="tutors-container" 
         [class.grid-view]="viewMode === 'grid'" 
         [class.list-view]="viewMode === 'list'"
         [class.transitioning]="isTransitioning"
         *ngIf="!isLoading || tutors.length > 0" 
         [@fadeInOut]>
      
      <!-- Tutor Cards -->
      <div class="tutor-card-modern" 
           *ngFor="let tutor of tutors; trackBy: trackByTutorId; let i = index"
           [attr.data-tutor-id]="tutor.id"
           [class.highlighted]="highlightedTutorId === tutor.id"
           [class.no-animation]="isReturningFromProfile"
           [style.animation-delay]="isReturningFromProfile || isTransitioning ? '0s' : (i < 10 ? i * 0.04 : 0.4) + 's'"
           >
        
        <!-- Card Main Content -->
        <div class="card-main">
          <!-- Left: Avatar -->
          <div class="left-section">
            <div class="tutor-avatar-container" 
                 [class.has-video]="tutor.videoThumbnail || tutor.introductionVideo"
                 [class.video-watched]="hasWatchedVideo(tutor.id)"
                 [class.show-ring]="viewMode === 'grid'"
                 (click)="onAvatarClick(tutor, $event)">
              <img [src]="getTutorImageSrc(tutor)" [alt]="tutor.name" class="tutor-avatar-image" (error)="onImageError($event)">
              <div class="online-badge" *ngIf="tutor.isOnline"></div>
            </div>
          </div>
          
          <!-- Middle: Info & Bio -->
          <div class="middle-section">
            <!-- Header Row -->
            <div class="header-row">
              <div class="name-section">
                <h3 class="tutor-name-modern">{{ tutor.firstName | displayName:tutor.lastName:tutor.name }}</h3>
                <div class="tutor-meta-inline">
                  <div class="rating-badge" *ngIf="tutor.rating > 0">
                    <ion-icon name="star"></ion-icon>
                    <span>{{ tutor.rating.toFixed(1) }}</span>
                    <span class="lessons-count">({{ tutor.totalLessons }})</span>
                  </div>
                  <div class="language-badge-inline">
                    <app-flag-icon *ngIf="tutor.languages && tutor.languages[0]" [language]="tutor.languages[0]" [size]="14"></app-flag-icon>
                    <span>{{ tutor.languages && tutor.languages[0] }}</span>
                  </div>
                  <div class="tutor-country-inline" *ngIf="tutor.country">
                    <ion-icon name="location-outline"></ion-icon>
                    <span>{{ tutor.country }}</span>
                  </div>
                </div>
              </div>
              
              <div class="price-badge-compact">
                <div class="price-amount">${{ tutor.hourlyRate }}</div>
                <div class="price-label">per hour</div>
              </div>
            </div>
            
            <!-- Office Hours Badge -->
            <div class="office-hours-badge-modern" *ngIf="tutor.isActivelyAvailable">
              <ion-icon name="flash"></ion-icon>
              <span>Available Now - Book Instantly</span>
            </div>
            
            <!-- Bio Section - Center Priority -->
            <div class="bio-section-inline" *ngIf="tutor.bio">
              <p class="bio-text" 
                 [class.truncated]="tutor.bio.length > 200 && !isBioExpanded(tutor.id)"
                 [class.expanded]="isBioExpanded(tutor.id)">
                {{ tutor.bio }}
              </p>
              <button class="learn-more-btn" 
                      (click)="toggleBioExpansion(tutor.id, $event)" 
                      *ngIf="tutor.bio && tutor.bio.length > 200">
                {{ isBioExpanded(tutor.id) ? 'Show less' : 'Learn more' }}
                <ion-icon [name]="isBioExpanded(tutor.id) ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
              </button>
            </div>
            
            <!-- Quick Stats -->
            <div class="quick-stats-inline">
              <div class="stat-chip">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ tutor.totalHours || 0 }}h taught</span>
              </div>
              <div class="stat-chip" *ngIf="tutor.nativeSpeaker">
                <ion-icon name="checkmark-circle"></ion-icon>
                <span>Native</span>
              </div>
              <div class="stat-chip" *ngIf="tutor.specialties && tutor.specialties[0]">
                <span>{{ tutor.specialties[0] }}</span>
              </div>
            </div>
          </div>
          
          <!-- Right: Video Thumbnail (only show in list view) -->
          <div class="right-section" *ngIf="(tutor.videoThumbnail || tutor.introductionVideo) && viewMode === 'list'">
            <div class="video-thumbnail-wrapper" (click)="onVideoThumbnailClick(tutor, $event)">
              <!-- Show thumbnail if available, otherwise show video element -->
              <img *ngIf="tutor.videoThumbnail" [src]="tutor.videoThumbnail" alt="Video preview" class="video-thumbnail-image">
              <video *ngIf="!tutor.videoThumbnail && tutor.introductionVideo" 
                     src="{{tutor.introductionVideo}}#t=0.001" 
                     class="video-thumbnail-image"
                     preload="metadata"></video>
              <div class="video-play-overlay">
                <ion-icon name="play"></ion-icon>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="card-actions" (click)="$event.stopPropagation()">
          <ion-button class="action-btn secondary" fill="clear" size="small" (click)="saveTutor(tutor, $event)">
            <ion-icon name="heart-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button class="action-btn secondary" fill="clear" size="small" (click)="messageTutor(tutor)">
            <ion-icon name="chatbubble-outline" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button class="action-btn secondary" fill="outline" size="small" (click)="openTutorProfile(tutor, $event)">
            <ion-icon name="person-outline" slot="start"></ion-icon>
            View profile
          </ion-button>
          <ion-button 
            *ngIf="tutor.isActivelyAvailable" 
            class="action-btn office-hours" 
            fill="solid" 
            size="small" 
            (click)="bookOfficeHours(tutor, $event)">
            <ion-icon name="flash" slot="start"></ion-icon>
            Quick Session
          </ion-button>
          <ion-button class="action-btn primary" fill="solid" size="small" (click)="bookLesson(tutor, $event)">
            <ion-icon name="calendar" slot="start"></ion-icon>
            Book lesson
          </ion-button>
        </div>
      </div>

      <!-- Load More Button -->
      <div class="load-more-container" *ngIf="searchResponse && searchResponse.pagination.hasNext">
        <ion-button fill="outline" (click)="loadMoreTutors()" [disabled]="isLoading">
          <ion-icon name="chevron-down-outline" slot="start"></ion-icon>
          Load More Tutors
        </ion-button>
      </div>

      <!-- No Results -->
      <div class="no-results" 
           *ngIf="!isLoading && tutors.length === 0"
           [@fadeInOut]>
        <ion-icon name="search-outline" class="no-results-icon"></ion-icon>
        <h3>No tutors found</h3>
        <p>Try adjusting your filters to find more tutors.</p>
        <ion-button fill="outline" (click)="clearFilters()">
          Clear Filters
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Filters View (Mobile Only) -->
  <div class="filters-view" [class.visible]="showFiltersView">
    <div class="filters-content">
      <!-- Price Filter -->
      <div class="filter-section">
        <h3>Price per lesson</h3>
        <div class="price-display">${{ priceRange.lower }} – ${{ priceRange.upper }}</div>
        <div class="filter-option">
          <ion-range 
            [value]="priceRange" 
            (ionChange)="onPriceRangeChange($event)" 
            dual-knobs="true" 
            min="0" 
            max="200" 
            pin="true">
            <ion-label slot="start">$0</ion-label>
            <ion-label slot="end">$200+</ion-label>
          </ion-range>
        </div>
      </div>

      <!-- Country Filter -->
      <div class="filter-section">
        <h3>Country of birth</h3>
        <ion-select [(ngModel)]="filters.country" interface="action-sheet" placeholder="Select country">
          <ion-select-option value="any">Any country</ion-select-option>
          <ion-select-option value="spain">Spain</ion-select-option>
          <ion-select-option value="mexico">Mexico</ion-select-option>
          <ion-select-option value="argentina">Argentina</ion-select-option>
          <ion-select-option value="colombia">Colombia</ion-select-option>
        </ion-select>
      </div>

      <!-- Availability Filter -->
      <div class="filter-section">
        <h3>I'm available</h3>
        <ion-select [(ngModel)]="filters.availability" interface="action-sheet" placeholder="Select availability">
          <ion-select-option value="anytime">Any time</ion-select-option>
          <ion-select-option value="morning">Morning</ion-select-option>
          <ion-select-option value="afternoon">Afternoon</ion-select-option>
          <ion-select-option value="evening">Evening</ion-select-option>
        </ion-select>
      </div>

      <!-- Additional Filters -->
      <div class="filter-section">
        <h3>Specialties</h3>
        <ion-select [(ngModel)]="filters.specialties" interface="action-sheet" placeholder="Select specialties" multiple="true">
          <ion-select-option value="conversation">Conversation</ion-select-option>
          <ion-select-option value="business">Business</ion-select-option>
          <ion-select-option value="exam">Exam preparation</ion-select-option>
          <ion-select-option value="grammar">Grammar</ion-select-option>
        </ion-select>
      </div>

      <div class="filter-section">
        <h3>Gender</h3>
        <ion-select [(ngModel)]="filters.gender" interface="action-sheet" placeholder="Select gender">
          <ion-select-option value="any">Any</ion-select-option>
          <ion-select-option value="male">Male</ion-select-option>
          <ion-select-option value="female">Female</ion-select-option>
        </ion-select>
      </div>
    </div>

    <!-- Apply Button -->
    <div class="filters-footer">
      <ion-button expand="block" (click)="applyFilters()">
        Apply Filters
      </ion-button>
    </div>
  </div>
  </div> <!-- Close the student content div -->
</ion-content>

<!-- Inline Video Modal with Zoom Animation -->
<ion-modal 
  [isOpen]="isVideoModalOpen" 
  (didDismiss)="onVideoModalDismiss()"
  [enterAnimation]="createVideoModalEnterAnimation"
  [leaveAnimation]="createVideoModalLeaveAnimation"
  cssClass="video-player-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title *ngIf="currentVideoTutor">
          {{ formatDisplayName(currentVideoTutor.firstName, currentVideoTutor.lastName, currentVideoTutor.name) }}'s Introduction
        </ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeVideoModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    
    <ion-content class="video-modal-content" *ngIf="currentVideoTutor && currentVideoTutor.introductionVideo">
      <div class="video-container">
        <!-- External video (YouTube/Vimeo) -->
        <iframe 
          *ngIf="isExternalVideo(currentVideoTutor.introductionVideo)"
          [src]="getVideoEmbedUrl(currentVideoTutor.introductionVideo) | safeUrl"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
        
        <!-- Direct video file -->
        <video 
          *ngIf="!isExternalVideo(currentVideoTutor.introductionVideo)"
          #videoElement
          [src]="currentVideoTutor.introductionVideo"
          [poster]="currentVideoTutor.videoThumbnail || ''"
          controls
          autoplay
          playsinline>
        </video>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
