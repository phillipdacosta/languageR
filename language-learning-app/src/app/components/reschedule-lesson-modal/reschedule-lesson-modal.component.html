<ion-content class="ion-padding reschedule-modal-content">
  <!-- Back button (top-left, if opened from proposal modal) -->
  <ion-button *ngIf="showBackButton && !showConfirmation" class="floating-back-button" fill="clear" (click)="goBackToProposal()">
    <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
  </ion-button>

  <!-- Floating close button (always visible) -->
  <ion-button class="floating-close-button" fill="clear" (click)="dismiss()">
    <ion-icon name="close" slot="icon-only"></ion-icon>
  </ion-button>

  <!-- Calendar View -->
  <div class="view-container" *ngIf="!showConfirmation" [@slideInOut]="animationDirection">
    <!-- Original Lesson Time Info - Sticky Banner -->
    <div class="original-time-banner sticky-banner" *ngIf="originalLessonTime">
      <div class="banner-content">
        <div class="banner-icon">
          <ion-icon name="time-outline"></ion-icon>
        </div>
        <div class="banner-text">
          <span class="banner-label">Current lesson time:</span>
          <span class="banner-time">{{ originalLessonTime }}</span>
        </div>
      </div>
    </div>

    <!-- Participant Info -->
    <div class="participant-section">
      <ion-avatar class="participant-avatar">
        <img *ngIf="participantAvatar" [src]="participantAvatar" [alt]="participantName" referrerpolicy="no-referrer">
        <ion-icon *ngIf="!participantAvatar" name="person" class="avatar-placeholder"></ion-icon>
      </ion-avatar>
      <div class="participant-info">
        <h3>{{ formattedParticipantName }}</h3>
        <p *ngIf="!isLoadingMutualAvailability && studentBusySlots.size > 0">
          Only showing times when both you and {{ formattedParticipantName }} are available. 
          Timeslots may be excluded due to {{ formattedParticipantName }}'s availability.
        </p>
        <p *ngIf="!isLoadingMutualAvailability && studentBusySlots.size === 0">
          Select any available time slot to reschedule your lesson with {{ formattedParticipantName }}.
        </p>
        <p *ngIf="isLoadingMutualAvailability">Finding available times...</p>
      </div>
    </div>

    <!-- Availability Calendar (Inline) -->
    <div class="calendar-section" *ngIf="!isLoadingMutualAvailability">
      <app-tutor-availability-viewer
        [tutorId]="tutorId"
        [tutorName]="formattedParticipantName"
        [inline]="true"
        [selectionMode]="true"
        [refreshTrigger]="refreshTrigger"
        [studentBusySlots]="studentBusySlots"
        (slotSelected)="onTimeSlotSelected($event)">
      </app-tutor-availability-viewer>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoadingMutualAvailability">
      <ion-spinner name="crescent"></ion-spinner>
    </div>

    <!-- Info Message - REMOVED (now in participant section) -->
  </div>

  <!-- Confirmation View -->
  <div class="view-container confirmation-view" *ngIf="showConfirmation" [@slideInOut]="animationDirection">
    <!-- Large Calendar Icon -->
    <div class="icon-section">
      <div class="icon-wrapper">
        <ion-icon name="calendar" class="confirmation-icon"></ion-icon>
      </div>
    </div>

    <!-- Main Heading -->
    <h1 class="confirmation-heading">Confirm Reschedule</h1>

    <!-- Subheading -->
    <p class="confirmation-subheading">
      You're about to reschedule your lesson with <strong>{{ formattedParticipantName }}</strong>
    </p>

    <!-- Time Card -->
    <div class="confirmation-content">
      <div class="selected-time-card">
        <div class="time-display">
          <div class="date-display">{{ selectedDateFormatted }}</div>
          <div class="time-display-value">{{ selectedTimeFormatted }}</div>
        </div>
        
        <div class="participant-info-confirmation">
          <ion-avatar class="confirmation-avatar">
            <img *ngIf="participantAvatar" [src]="participantAvatar" [alt]="formattedParticipantName" referrerpolicy="no-referrer">
            <ion-icon *ngIf="!participantAvatar" name="person" class="avatar-placeholder"></ion-icon>
          </ion-avatar>
          <p>with {{ formattedParticipantName }}</p>
        </div>
      </div>

      <div class="confirmation-message">
        <p>{{ formattedParticipantName }} will be notified of this time change</p>
      </div>
    </div>
  </div>
</ion-content>

<ion-footer *ngIf="showConfirmation">
  <ion-toolbar>
    <div class="button-group">
      <ion-button 
        expand="block" 
        fill="outline"
        (click)="goBack()">
        Cancel
      </ion-button>
      <ion-button 
        expand="block"
        color="primary"
        (click)="confirmReschedule()">
        Reschedule
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>