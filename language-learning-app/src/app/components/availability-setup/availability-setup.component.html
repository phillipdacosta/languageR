<div class="availability-setup" [class.single-day-mode]="isSingleDayMode">
  <!-- Mobile Header -->
  <div class="mobile-header" *ngIf="!isSingleDayMode">
    <ion-button fill="clear" class="mobile-back-button" (click)="goBack()">
      <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
      Calendar
    </ion-button>
    <ion-button fill="clear" class="mobile-settings-button" (click)="toggleMobileSettings()">
      <ion-icon [name]="showMobileSettings ? 'close-outline' : 'options-outline'"></ion-icon>
    </ion-button>
  </div>

  <div class="mobile-settings-wrapper" [class.open]="showMobileSettings">
    <div class="mobile-settings-panel" *ngIf="showMobileSettings || panelAnimating">
    <div class="panel-section">
      <h3>Settings</h3>
      <ion-list lines="none">
        <ion-item button detail="false" (click)="setActiveTab('availability'); toggleMobileSettings()">
          <ion-icon name="time-outline" slot="start"></ion-icon>
          <ion-label>Availability</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="setActiveTab('booking'); toggleMobileSettings()">
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          <ion-label>Lesson booking settings</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="setActiveTab('calendar'); toggleMobileSettings()">
          <ion-icon name="settings-outline" slot="start"></ion-icon>
          <ion-label>Calendar settings</ion-label>
        </ion-item>
        <ion-item button detail="false" (click)="setActiveTab('google'); toggleMobileSettings()">
          <ion-icon name="logo-google" slot="start"></ion-icon>
          <ion-label>Google Calendar settings</ion-label>
        </ion-item>
      </ion-list>
    </div>

    <div class="panel-section">
      <h3>View Options</h3>
      <div class="option-item">
        <ion-checkbox [(ngModel)]="showPopularSlots" (ionChange)="togglePopularSlots()"></ion-checkbox>
        <label>Popular slots</label>
      </div>
    </div>

    <div class="panel-section">
      <h3>Quick Actions</h3>
      <ion-button expand="block" fill="outline" (click)="setBusinessHours(); toggleMobileSettings()">
        <ion-icon name="business-outline" slot="start"></ion-icon>
        Set business hours
      </ion-button>
      <ion-button expand="block" fill="outline" (click)="clearAll(); toggleMobileSettings()">
        <ion-icon name="trash-outline" slot="start"></ion-icon>
        Clear all
      </ion-button>
      <ion-button expand="block" fill="outline" (click)="copyWeek(); toggleMobileSettings()">
        <ion-icon name="copy-outline" slot="start"></ion-icon>
        Copy to all days
      </ion-button>
    </div>

    <div class="panel-section">
      <ion-button expand="block" class="google-btn" (click)="connectGoogleCalendar(); toggleMobileSettings()">
        <ion-icon name="logo-google" slot="start"></ion-icon>
        Connect calendar
      </ion-button>
    </div>
    </div>
  </div>

  <!-- Left Sidebar -->
  <div class="settings-sidebar">
    <!-- Back Navigation -->
    <div class="back-nav">
      <ion-button fill="clear" class="back-button" (click)="goBack()">
        <ion-icon name="chevron-back-outline" slot="start"></ion-icon>
        <span *ngIf="!isSingleDayMode">Calendar</span>
        <span *ngIf="isSingleDayMode">Availability Setup</span>
      </ion-button>
    </div>

    <!-- Settings Navigation -->
    <div class="settings-nav">
      <h3>SETTINGS</h3>
      <nav class="nav-menu">
        <a class="nav-item active" (click)="setActiveTab('availability')">
          <ion-icon name="time-outline"></ion-icon>
          Availability
        </a>
        <a class="nav-item" (click)="setActiveTab('booking')">
          <ion-icon name="calendar-outline"></ion-icon>
          Lesson booking settings
        </a>
        <a class="nav-item" (click)="setActiveTab('calendar')">
          <ion-icon name="settings-outline"></ion-icon>
          Calendar settings
        </a>
        <a class="nav-item" (click)="setActiveTab('google')">
          <ion-icon name="logo-google"></ion-icon>
          Google Calendar settings
        </a>
      </nav>
    </div>

    <!-- View Options -->
    <div class="view-options">
      <h3>VIEW OPTIONS</h3>
      <div class="option-item">
        <ion-checkbox [(ngModel)]="showPopularSlots" (ionChange)="togglePopularSlots()"></ion-checkbox>
        <label>Popular slots</label>
        <ion-button fill="clear" size="small" class="info-button">
          <ion-icon name="information-circle-outline"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
      <h3>QUICK ACTIONS</h3>
      <div class="action-buttons">
        <ion-button expand="block" fill="outline" class="action-btn" (click)="setBusinessHours()">
          <ion-icon name="business-outline" slot="start"></ion-icon>
          Set business hours
        </ion-button>
        <ion-button expand="block" fill="outline" class="action-btn" (click)="clearAll()">
          <ion-icon name="trash-outline" slot="start"></ion-icon>
          Clear all
        </ion-button>
        <ion-button expand="block" fill="outline" class="action-btn" (click)="copyWeek()">
          <ion-icon name="copy-outline" slot="start"></ion-icon>
          Copy to all days
        </ion-button>
      </div>
    </div>

    <!-- Google Calendar Integration -->
    <div class="google-integration">
      <ion-button expand="block" class="google-btn" (click)="connectGoogleCalendar()">
        <ion-icon name="logo-google" slot="start"></ion-icon>
        Connect calendar
      </ion-button>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Header -->
    <div class="content-header" *ngIf="!isSingleDayMode">
      <div class="header-card">
        <!-- Mobile Header Buttons Overlay -->
        <div class="header-overlay-buttons">
          <ion-button fill="clear" class="overlay-back-button" (click)="goBack()">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" class="overlay-settings-button" (click)="toggleMobileSettings()">
            <ion-icon [name]="showMobileSettings ? 'close-outline' : 'options-outline'"></ion-icon>
          </ion-button>
        </div>
        
        <div class="header-icon">
          <ion-icon name="calendar-outline"></ion-icon>
        </div>
        <div class="header-info">
          <h1>Set your weekly availability</h1>
          <p>Click and drag to select your available times. Students can only book during these slots.</p>
        </div>
      </div>
    </div>

    <!-- Week Navigation (shown in both week and day mode) -->
    <div class="week-navigation">
      <div class="nav-controls">
        <div class="nav-left">
          <ion-button fill="solid" size="small" (click)="navigateWeek('prev')" [disabled]="isSingleDayMode">
            <ion-icon name="chevron-back-outline"></ion-icon>
          </ion-button>
          <ion-button fill="solid" size="small" (click)="navigateWeek('next')" [disabled]="isSingleDayMode">
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </ion-button>
          <ion-button fill="solid" size="small" (click)="goToToday()" class="today-btn" [disabled]="isSingleDayMode">
            Today
          </ion-button>
        </div>
        <div class="week-display">
          <span class="week-range">{{ getWeekRange() }}</span>
        </div>
        <div class="nav-right">
          <p class="timezone-info" *ngIf="tutorTimezone">
            <ion-icon name="globe-outline"></ion-icon>
            {{ getTimezoneLabel(tutorTimezone) }}
          </p>
          <div class="view-toggle">
            <ion-button fill="solid" class="view-btn" [class.active]="!isSingleDayMode" (click)="switchToWeekView()">Week</ion-button>
            <ion-button fill="solid" class="view-btn" [class.active]="isSingleDayMode" (click)="switchToDayView()">Day</ion-button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Single Day Header (REMOVED - using navigation bar instead) -->

    <!-- Time Slot Grid -->
    <div class="time-grid-container">
      <div class="time-grid">
        <!-- Day Headers -->
        <div class="day-headers" *ngIf="!isSingleDayMode">
          <div class="time-column-header"></div>
          <div class="day-header" *ngFor="let day of displayedWeekDays" [class.today]="isToday(day)" (click)="selectDate(day)">
            <div class="day-name">{{ day.name }}</div>
            <div class="day-date">
              <span class="day-number">{{ day.displayDate }}</span>
              <span class="day-month">{{ day.displayMonth }}</span>
            </div>
          </div>
        </div>

        <!-- Time Slots -->
        <div class="time-slots" #timeSlotsContainer>
          <!-- Wrapper for time labels column -->
          <div class="time-labels-column">
            <div class="time-slot-row" *ngFor="let hour of timeSlots">
              <div class="time-label">{{ hour.display }}</div>
            </div>
          </div>
          
          <!-- Day columns (one per day, spanning all time slots) -->
          <div class="all-day-columns">
            <div class="day-column-wrapper" *ngFor="let day of displayedWeekDays">
              <!-- Time slots for this day -->
              <div class="day-time-slot" 
                   *ngFor="let hour of timeSlots; let i = index"
                   [class.selected]="isSlotSelected(day.index, i)"
                   [class.popular]="isPopularSlot(day.index, i)"
                   [class.night]="isNightSlot(i)"
                   [class.past]="isPastSlot(day.index, i)"
                   [class.booked]="isSlotBooked(day.index, i)"
                   (mousedown)="startSelection(day.index, i, $event)"
                   (mouseenter)="continueSelection(day.index, i)"
                   (mouseup)="endSelection()">
                <div class="slot-indicator" *ngIf="isSlotSelected(day.index, i)"></div>
                <ion-icon *ngIf="isSlotBooked(day.index, i)" name="lock-closed" class="booked-icon"></ion-icon>
              </div>
              
              <!-- Current time indicator - positioned absolutely within this day's wrapper -->
              <div class="time-indicator" *ngIf="isToday(day)" [style.top.px]="currentTimePosition"></div>
            </div>
          </div>
        </div>

        <!-- Night Time Label -->
        <!-- <div class="night-time-label">
          <span>Night time</span>
        </div> -->
      </div>
    </div>
  </div>

  <!-- Action Bar -->
  <div class="action-bar" *ngIf="hasUnsavedChanges" [@slideUp]>
    <div class="selected-info">
      <span *ngIf="newHoursCount > 0" class="new-hours">
        +{{ newHoursCount }} {{ newHoursCount === 1 ? 'hour' : 'hours' }}
      </span>
      <span class="total-weekly-hours">
        {{ totalWeeklyHours }} {{ totalWeeklyHours === 1 ? 'hour' : 'hours' }} {{ weekRangeDisplay }}
      </span>
    </div>
    <div class="action-buttons">
      <ion-button fill="outline" (click)="previewSchedule()">
        <ion-icon name="eye-outline" slot="start"></ion-icon>
        Preview
      </ion-button>
      <ion-button (click)="saveAvailability()" [disabled]="!hasUnsavedChanges">
        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
        Save availability
      </ion-button>
    </div>
  </div>
</div>