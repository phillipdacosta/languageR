<ion-content [fullscreen]="true" class="messages-content">
  <div class="messages-container" [class.desktop-layout]="isDesktop">
    
    <!-- Desktop Two-Column Layout -->
    <div class="desktop-messages-wrapper" *ngIf="isDesktop">
      <!-- Left Column: Conversation List -->
      <div class="conversations-panel">
        <div class="conversations-header">
          <h2>Messages</h2>
          <div class="header-actions">
            <ion-button fill="clear" size="small">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small">
              <ion-icon name="search-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <!-- Loading State (only on initial load) -->
        <div *ngIf="isInitialLoad && isLoading" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>

        <!-- Conversations Search Header -->
        <div class="conversations-search-header">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input
            type="text"
            class="search-input"
            placeholder="Search by name"
            [value]="searchTerm"
            (input)="onSearchChange($any($event.target).value)"
          />
          <ion-icon 
            *ngIf="searchTerm" 
            name="close-circle" 
            class="clear-icon"
            (click)="clearSearch()">
          </ion-icon>
        </div>

        <!-- Conversations List (stays visible after first load) -->
        <div class="conversations-list" *ngIf="!isInitialLoad || !isLoading">
          <div 
            *ngFor="let conversation of filteredConversations; trackBy: trackByConversationId" 
            class="conversation-item"
            [class.active]="selectedConversation?.conversationId === conversation.conversationId"
            (click)="selectConversation(conversation)">
            <ion-avatar class="conversation-avatar">
              <img [src]="conversation.otherUser?.picture" *ngIf="conversation.otherUser?.picture" />
              <div class="avatar-fallback" *ngIf="!conversation.otherUser?.picture">
                {{ conversation.otherUser?.name?.charAt(0) || '?' }}
              </div>
            </ion-avatar>
            <div class="conversation-info">
              <div class="conversation-header-row">
                <h3>{{ conversation.otherUser?.name || 'Unknown User' }}</h3>
                <span class="timestamp">
                  {{ formatTime(conversation.lastMessage.createdAt) }}
                  <span class="timestamp-day">‚Ä¢ {{ formatRelativeDay(conversation.lastMessage.createdAt) }}</span>
                </span>
              </div>
              <div class="conversation-preview-row">
                <p class="preview-text" 
                   [class.sent-by-me]="conversation.lastMessage.senderId === getCurrentUserId()">
                  <span *ngIf="conversation.lastMessage.senderId === getCurrentUserId()">You: </span>
                  {{ conversation.lastMessage.content }}
                </p>
                <ion-badge *ngIf="conversation.unreadCount > 0" color="primary" class="unread-badge">
                  {{ conversation.unreadCount }}
                </ion-badge>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isInitialLoad && conversations.length === 0" class="empty-state">
          <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
          <p>No conversations yet</p>
          <p class="empty-hint" *ngIf="currentUserType === 'student'">Start messaging from a tutor's profile</p>
          <p class="empty-hint" *ngIf="currentUserType === 'tutor'">Student messages will appear here.</p>
        </div>
      </div>

      <!-- Right Column: Chat View -->
      <div class="chat-panel" *ngIf="selectedConversation">
        <div class="chat-header">
          <div class="chat-header-info" (click)="openOtherUserProfile()" style="cursor: pointer;">
            <ion-avatar class="chat-avatar">
              <img [src]="selectedConversation.otherUser?.picture" *ngIf="selectedConversation.otherUser?.picture" />
              <div class="avatar-fallback" *ngIf="!selectedConversation.otherUser?.picture">
                {{ selectedConversation.otherUser?.name?.charAt(0) || '?' }}
              </div>
            </ion-avatar>
            <div class="chat-user-info">
              <h3>{{ selectedConversation.otherUser?.name || 'Unknown User' }}</h3>
              <p class="typing-indicator" *ngIf="otherUserTyping">Typing...</p>
              <div class="user-details" *ngIf="!otherUserTyping && selectedConversation.otherUser">
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType === 'tutor' && selectedConversation.otherUser.languages && selectedConversation.otherUser.languages.length">
                  <ion-icon name="language-outline"></ion-icon>
                  {{ selectedConversation.otherUser.languages.join(', ') }}
                  <span *ngIf="selectedConversation.otherUser.hourlyRate" class="rate">
                    ‚Ä¢ ${{ selectedConversation.otherUser.hourlyRate }}/hr
                  </span>
                  <span *ngIf="selectedConversation.otherUser.rating" class="rating">
                    ‚Ä¢ ‚≠ê {{ selectedConversation.otherUser.rating.toFixed(1) }}
                  </span>
                </p>
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType === 'tutor' && (!selectedConversation.otherUser.languages || !selectedConversation.otherUser.languages.length)">
                  Tutor
                </p>
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType !== 'tutor'">
                  {{ selectedConversation.otherUser.userType || 'User' }}
                </p>
              </div>
            </div>
          </div>
          <div class="chat-header-actions">
            <ion-button fill="clear" size="small">
              <ion-icon name="videocam-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small">
              <ion-icon name="call-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small">
              <ion-icon name="ellipsis-vertical-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <div class="chat-messages" #chatContainer>
          <!-- Loading State -->
          <div *ngIf="isLoadingMessages" class="loading-container">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Loading messages...</p>
          </div>

          <!-- Tutor Info Card (shown when starting a new conversation with a tutor) -->
          <ng-container *ngIf="!isLoadingMessages && messages.length === 0 && selectedConversation?.otherUser?.userType === 'tutor' && selectedConversation?.otherUser?.languages && (selectedConversation?.otherUser?.languages?.length ?? 0) > 0">
            <div class="tutor-info-card">
              <div class="tutor-info-header">
                <ion-avatar class="tutor-info-avatar">
                  <img [src]="selectedConversation.otherUser!.picture" *ngIf="selectedConversation.otherUser!.picture" />
                  <div class="avatar-fallback" *ngIf="!selectedConversation.otherUser!.picture">
                    {{ selectedConversation.otherUser!.name?.charAt(0) || '?' }}
                  </div>
                </ion-avatar>
                <div class="tutor-info-main">
                  <h4>{{ selectedConversation.otherUser!.name }}</h4>
                  <div class="tutor-info-badges">
                    <span class="info-badge" *ngIf="selectedConversation.otherUser!.rating">
                      <ion-icon name="star"></ion-icon>
                      {{ selectedConversation.otherUser!.rating.toFixed(1) }}
                    </span>
                    <span class="info-badge" *ngIf="selectedConversation.otherUser!.hourlyRate">
                      ${{ selectedConversation.otherUser!.hourlyRate }}/hr
                    </span>
                  </div>
                </div>
              </div>
              <div class="tutor-info-details">
                <div class="info-row" *ngIf="selectedConversation.otherUser!.languages && selectedConversation.otherUser!.languages.length">
                  <ion-icon name="language-outline"></ion-icon>
                  <span><strong>Languages:</strong> {{ selectedConversation.otherUser!.languages.join(', ') }}</span>
                </div>
                <div class="info-row" *ngIf="selectedConversation.otherUser!.bio">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  <span>{{ selectedConversation.otherUser!.bio }}</span>
                </div>
              </div>
            </div>
          </ng-container>

          <!-- Messages -->
          <div *ngIf="!isLoadingMessages" class="messages-list">
            <div *ngFor="let message of messages; let i = index; trackBy: trackByMessageId" 
                 class="message-wrapper"
                 [attr.data-message-id]="message.id">
              <!-- Date Separator -->
              <div *ngIf="shouldShowDateSeparator(message, messages[i - 1])" class="date-separator">
                {{ formatDate(message.createdAt) }}
              </div>

              <!-- Message Bubble -->
              <div class="message-bubble" 
                   [class.sent]="message.senderId === getCurrentUserId()"
                   [class.received]="message.senderId !== getCurrentUserId()"
                   [class.highlighted]="highlightedMessageId === message.id"
                   (mousedown)="onMessageMouseDown(message, $event)"
                   (mouseup)="onMessageMouseUp()"
                   (mouseleave)="onMessageMouseUp()"
                   (dblclick)="onMessageDoubleClick(message)">
                
                <!-- Replied-to message preview (if this is a reply) -->
                <div *ngIf="message.replyTo" 
                     class="reply-to-preview" 
                     (click)="scrollToMessageById(message.replyTo.messageId, $event)">
                  <div class="reply-to-line"></div>
                  <div class="reply-to-content">
                    <span class="reply-to-sender">{{ message.replyTo.senderName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'text'">{{ message.replyTo.content }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'image'">üì∑ Photo</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'file'">üìÑ {{ message.replyTo.fileName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'voice'">üé§ Voice message</span>
                  </div>
                </div>
                
                <!-- Text message -->
                <div *ngIf="message.type === 'text'" class="message-content">
                  {{ message.content }}
                </div>
                
                <!-- Image message -->
                <div *ngIf="message.type === 'image'" class="message-image">
                  <img [src]="message.fileUrl" [alt]="message.fileName" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)" />
                  <p *ngIf="message.content" class="image-caption">{{ message.content }}</p>
                </div>
                
                <!-- Document message -->
                <div *ngIf="message.type === 'file'" class="message-file">
                  <div class="file-info" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)">
                    <ion-icon [name]="getFileIcon(message.fileType!)" class="file-icon"></ion-icon>
                    <div class="file-details">
                      <p class="file-name">{{ message.fileName }}</p>
                      <p class="file-size">{{ formatFileSize(message.fileSize!) }}</p>
                    </div>
                    <ion-icon name="download-outline" class="download-icon"></ion-icon>
                  </div>
                  <p *ngIf="message.content" class="file-caption">{{ message.content }}</p>
                </div>
                
                <!-- Voice note message -->
                <div *ngIf="message.type === 'voice'" class="message-voice">
                  <ion-icon name="play-circle" class="voice-icon"></ion-icon>
                  <audio [src]="message.fileUrl" controls class="voice-player"></audio>
                  <span class="voice-duration" *ngIf="message.duration">{{ message.duration }}s</span>
                </div>
                
                <div class="message-time">
                  {{ formatTime(message.createdAt) }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Reply Preview -->
        <div *ngIf="replyingToMessage" class="replying-to-container">
          <div class="replying-to-header">
            <ion-icon name="arrow-undo-outline" class="reply-icon"></ion-icon>
            <span class="replying-to-label">Replying to {{ isMyMessage(replyingToMessage) ? 'yourself' : selectedConversation?.otherUser.name }}</span>
            <ion-icon name="close-outline" class="close-reply-icon" (click)="clearReply()"></ion-icon>
          </div>
          <button 
            class="replying-to-preview-button" 
            (click)="scrollToRepliedMessage($event)"
            type="button">
            {{ getReplyPreviewContent() }}
          </button>
        </div>

        <!-- Message Input -->
        <div class="message-input-container">
          <!-- Hidden file inputs -->
          <input type="file" #imageInput accept="image/*" (change)="onFileSelected($event, 'image')" style="display: none;">
          <input type="file" #documentInput accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" (change)="onFileSelected($event, 'file')" style="display: none;">
          
          <ion-button fill="clear" size="small" (click)="imageInput.click()" [disabled]="isUploading">
            <ion-icon name="image-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="documentInput.click()" [disabled]="isUploading">
            <ion-icon name="attach-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="toggleVoiceRecording()" [disabled]="isUploading">
            <ion-icon [name]="isRecording ? 'stop-circle' : 'mic-outline'" [color]="isRecording ? 'danger' : ''"></ion-icon>
          </ion-button>
          <ion-input
            #messageInput
            [(ngModel)]="newMessage"
            placeholder="Type a message"
            (ionInput)="onInputChange()"
            (keydown.enter)="sendMessage()"
            class="message-input"
            [disabled]="isUploading || isRecording">
          </ion-input>
          <ion-button fill="clear" size="small" (click)="sendMessage()" [disabled]="!newMessage.trim() || isSending || isUploading || isRecording">
            <ion-icon name="send-outline"></ion-icon>
          </ion-button>
          
          <!-- Upload progress indicator -->
          <div *ngIf="isUploading" class="upload-progress">
            <ion-spinner name="crescent"></ion-spinner>
            <span>Uploading...</span>
          </div>
          
          <!-- Recording indicator -->
          <div *ngIf="isRecording" class="recording-indicator">
            <ion-icon name="radio-button-on" color="danger"></ion-icon>
            <span>Recording... {{ recordingDuration }}s</span>
          </div>
        </div>
      </div>

      <!-- No Conversation Selected -->
      <div class="chat-panel-empty" *ngIf="!selectedConversation">
        <div class="empty-chat">
          <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
          <h2>Select a conversation</h2>
          <p>Choose a conversation from the list to start messaging</p>
        </div>
      </div>
    </div>

    <!-- Mobile Single Column Layout -->
    <div class="mobile-messages-wrapper" *ngIf="!isDesktop">
      <!-- Conversation List View (Mobile) -->
      <div class="conversations-panel" *ngIf="!selectedConversation">
        <div class="conversations-header">
          <h2>Messages</h2>
        </div>

        <!-- Mobile: Conversations Search Header -->
        <div class="conversations-search-header">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input
            type="text"
            class="search-input"
            placeholder="Search by name"
            [value]="searchTerm"
            (input)="onSearchChange($any($event.target).value)"
          />
          <ion-icon 
            *ngIf="searchTerm" 
            name="close-circle" 
            class="clear-icon"
            (click)="clearSearch()">
          </ion-icon>
        </div>

        <div *ngIf="isInitialLoad && isLoading" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>

        <div class="conversations-list" *ngIf="(!isInitialLoad || !isLoading) && filteredConversations.length > 0">
          <div 
            *ngFor="let conversation of filteredConversations; trackBy: trackByConversationId" 
            class="conversation-item"
            (click)="selectConversation(conversation)">
            <ion-avatar class="conversation-avatar">
              <img [src]="conversation.otherUser?.picture" *ngIf="conversation.otherUser?.picture" />
              <div class="avatar-fallback" *ngIf="!conversation.otherUser?.picture">
                {{ conversation.otherUser?.name?.charAt(0) || '?' }}
              </div>
            </ion-avatar>
            <div class="conversation-info">
              <div class="conversation-header-row">
                <h3>{{ conversation.otherUser?.name || 'Unknown User' }}</h3>
                <span class="timestamp">
                  {{ formatTime(conversation.lastMessage.createdAt) }}
                  <span class="timestamp-day">‚Ä¢ {{ formatRelativeDay(conversation.lastMessage.createdAt) }}</span>
                </span>
              </div>
              <div class="conversation-preview-row">
                <p class="preview-text">{{ conversation.lastMessage.content }}</p>
                <ion-badge *ngIf="conversation.unreadCount > 0" color="primary" class="unread-badge">
                  {{ conversation.unreadCount }}
                </ion-badge>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!isInitialLoad && conversations.length === 0" class="empty-state">
          <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
          <h2>No messages yet</h2>
          <p *ngIf="currentUserType === 'student'">Start a conversation by messaging a tutor from their profile.</p>
          <p *ngIf="currentUserType === 'tutor'">Student messages will appear here.</p>
        </div>
      </div>

      <!-- Chat View (Mobile) -->
      <div class="chat-view-mobile" *ngIf="selectedConversation">
        <div class="chat-header">
          <ion-button fill="clear" (click)="selectedConversation = null">
            <ion-icon name="arrow-back"></ion-icon>
          </ion-button>
          <div class="chat-header-info" (click)="openOtherUserProfile()" style="cursor: pointer;">
            <ion-avatar class="chat-avatar">
              <img [src]="selectedConversation.otherUser?.picture" *ngIf="selectedConversation.otherUser?.picture" />
              <div class="avatar-fallback" *ngIf="!selectedConversation.otherUser?.picture">
                {{ selectedConversation.otherUser?.name?.charAt(0) || '?' }}
              </div>
            </ion-avatar>
            <div class="chat-user-info">
              <h3>{{ selectedConversation.otherUser?.name || 'Unknown User' }}</h3>
              <p class="typing-indicator" *ngIf="otherUserTyping">Typing...</p>
              <div class="user-details" *ngIf="!otherUserTyping && selectedConversation.otherUser">
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType === 'tutor' && selectedConversation.otherUser.languages && selectedConversation.otherUser.languages.length">
                  <ion-icon name="language-outline"></ion-icon>
                  {{ selectedConversation.otherUser.languages.join(', ') }}
                  <span *ngIf="selectedConversation.otherUser.hourlyRate" class="rate">
                    ‚Ä¢ ${{ selectedConversation.otherUser.hourlyRate }}/hr
                  </span>
                  <span *ngIf="selectedConversation.otherUser.rating" class="rating">
                    ‚Ä¢ ‚≠ê {{ selectedConversation.otherUser.rating.toFixed(1) }}
                  </span>
                </p>
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType === 'tutor' && (!selectedConversation.otherUser.languages || !selectedConversation.otherUser.languages.length)">
                  Tutor
                </p>
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType !== 'tutor'">
                  {{ selectedConversation.otherUser.userType || 'User' }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="chat-messages" #chatContainer>
          <div *ngIf="isLoadingMessages" class="loading-container">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Loading messages...</p>
          </div>

          <!-- Tutor Info Card (shown when starting a new conversation with a tutor) -->
          <ng-container *ngIf="!isLoadingMessages && messages.length === 0 && selectedConversation?.otherUser?.userType === 'tutor' && selectedConversation?.otherUser?.languages && (selectedConversation?.otherUser?.languages?.length ?? 0) > 0">
            <div class="tutor-info-card">
              <div class="tutor-info-header">
                <ion-avatar class="tutor-info-avatar">
                  <img [src]="selectedConversation.otherUser!.picture" *ngIf="selectedConversation.otherUser!.picture" />
                  <div class="avatar-fallback" *ngIf="!selectedConversation.otherUser!.picture">
                    {{ selectedConversation.otherUser!.name?.charAt(0) || '?' }}
                  </div>
                </ion-avatar>
                <div class="tutor-info-main">
                  <h4>{{ selectedConversation.otherUser!.name }}</h4>
                  <div class="tutor-info-badges">
                    <span class="info-badge" *ngIf="selectedConversation.otherUser!.rating">
                      <ion-icon name="star"></ion-icon>
                      {{ selectedConversation.otherUser!.rating.toFixed(1) }}
                    </span>
                    <span class="info-badge" *ngIf="selectedConversation.otherUser!.hourlyRate">
                      ${{ selectedConversation.otherUser!.hourlyRate }}/hr
                    </span>
                  </div>
                </div>
              </div>
              <div class="tutor-info-details">
                <div class="info-row" *ngIf="selectedConversation.otherUser!.languages && selectedConversation.otherUser!.languages.length">
                  <ion-icon name="language-outline"></ion-icon>
                  <span><strong>Languages:</strong> {{ selectedConversation.otherUser!.languages.join(', ') }}</span>
                </div>
                <div class="info-row" *ngIf="selectedConversation.otherUser!.bio">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  <span>{{ selectedConversation.otherUser!.bio }}</span>
                </div>
              </div>
            </div>
          </ng-container>

          <div *ngIf="!isLoadingMessages" class="messages-list">
            <div *ngFor="let message of messages; let i = index; trackBy: trackByMessageId" 
                 class="message-wrapper"
                 [attr.data-message-id]="message.id">
              <div *ngIf="shouldShowDateSeparator(message, messages[i - 1])" class="date-separator">
                {{ formatDate(message.createdAt) }}
              </div>
              <div class="message-bubble" 
                   [class.sent]="message.senderId === getCurrentUserId()"
                   [class.received]="message.senderId !== getCurrentUserId()"
                   [class.highlighted]="highlightedMessageId === message.id"
                   (press)="onMessageTap(message, $event)">
                
                <!-- Replied-to message preview (if this is a reply) -->
                <div *ngIf="message.replyTo" 
                     class="reply-to-preview" 
                     (click)="scrollToMessageById(message.replyTo.messageId, $event)">
                  <div class="reply-to-line"></div>
                  <div class="reply-to-content">
                    <span class="reply-to-sender">{{ message.replyTo.senderName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'text'">{{ message.replyTo.content }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'image'">üì∑ Photo</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'file'">üìÑ {{ message.replyTo.fileName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'voice'">üé§ Voice message</span>
                  </div>
                </div>
                
                <!-- Text message -->
                <div *ngIf="message.type === 'text'" class="message-content">{{ message.content }}</div>
                
                <!-- Image message -->
                <div *ngIf="message.type === 'image'" class="message-image">
                  <img [src]="message.fileUrl" [alt]="message.fileName" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)" />
                  <p *ngIf="message.content" class="image-caption">{{ message.content }}</p>
                </div>
                
                <!-- Document message -->
                <div *ngIf="message.type === 'file'" class="message-file">
                  <div class="file-info" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)">
                    <ion-icon [name]="getFileIcon(message.fileType!)" class="file-icon"></ion-icon>
                    <div class="file-details">
                      <p class="file-name">{{ message.fileName }}</p>
                      <p class="file-size">{{ formatFileSize(message.fileSize!) }}</p>
                    </div>
                    <ion-icon name="download-outline" class="download-icon"></ion-icon>
                  </div>
                  <p *ngIf="message.content" class="file-caption">{{ message.content }}</p>
                </div>
                
                <!-- Voice note message -->
                <div *ngIf="message.type === 'voice'" class="message-voice">
                  <audio [src]="message.fileUrl" controls class="voice-player"></audio>
                </div>
                
                <div class="message-time">{{ formatTime(message.createdAt) }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Reply Preview (Mobile) -->
        <div *ngIf="replyingToMessage" class="replying-to-container">
          <div class="replying-to-header">
            <ion-icon name="arrow-undo-outline" class="reply-icon"></ion-icon>
            <span class="replying-to-label">Replying to {{ isMyMessage(replyingToMessage) ? 'yourself' : selectedConversation?.otherUser.name }}</span>
            <ion-icon name="close-outline" class="close-reply-icon" (click)="clearReply()"></ion-icon>
          </div>
          <button 
            class="replying-to-preview-button" 
            (click)="scrollToRepliedMessage($event)"
            type="button">
            {{ getReplyPreviewContent() }}
          </button>
        </div>

        <div class="message-input-container">
          <!-- Hidden file inputs -->
          <input type="file" #imageInputMobile accept="image/*" (change)="onFileSelected($event, 'image')" style="display: none;">
          <input type="file" #documentInputMobile accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" (change)="onFileSelected($event, 'file')" style="display: none;">
          
          <ion-button fill="clear" size="small" (click)="imageInputMobile.click()" [disabled]="isUploading">
            <ion-icon name="image-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="documentInputMobile.click()" [disabled]="isUploading">
            <ion-icon name="attach-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="toggleVoiceRecording()" [disabled]="isUploading">
            <ion-icon [name]="isRecording ? 'stop-circle' : 'mic-outline'" [color]="isRecording ? 'danger' : ''"></ion-icon>
          </ion-button>
          <ion-input
            #messageInput
            [(ngModel)]="newMessage"
            placeholder="Type a message"
            (ionInput)="onInputChange()"
            (keydown.enter)="sendMessage()"
            [disabled]="isUploading || isRecording">
          </ion-input>
          <ion-button fill="clear" (click)="sendMessage()" [disabled]="!newMessage.trim() || isSending || isUploading || isRecording">
            <ion-icon name="send"></ion-icon>
          </ion-button>
          
          <!-- Upload/Recording indicators -->
          <div *ngIf="isUploading" class="upload-progress-mobile">
            <ion-spinner name="crescent"></ion-spinner>
            <span>Uploading...</span>
          </div>
          <div *ngIf="isRecording" class="recording-indicator-mobile">
            <ion-icon name="radio-button-on" color="danger"></ion-icon>
            <span>{{ recordingDuration }}s</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>
