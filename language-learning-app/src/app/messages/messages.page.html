<ion-content [fullscreen]="true" class="messages-content" [scrollY]="false">
  <!-- Message Context Menu Overlay -->
  <div class="message-context-menu-overlay" 
       *ngIf="showContextMenu"
       (click)="closeContextMenu()">
    <div class="context-menu-container" 
         [style.top.px]="contextMenuPosition?.showBelow ? contextMenuPosition?.top : null"
         [style.bottom.px]="!contextMenuPosition?.showBelow ? contextMenuPosition?.bottom : null"
         [style.left.px]="contextMenuPosition?.left"
         [style.max-height.px]="contextMenuPosition?.maxHeight"
         [class.show-below]="contextMenuPosition?.showBelow"
         (click)="$event.stopPropagation()">
      
      <!-- Pointer Arrow -->
      <div class="menu-arrow" 
           [style.left.px]="contextMenuPosition?.arrowOffset"
           [class.arrow-above]="!contextMenuPosition?.showBelow"></div>
      
      <!-- Quick Emoji Reactions -->
      <div class="emoji-reactions" *ngIf="contextMenuMessage && !isMyMessage(contextMenuMessage)">
        <button class="emoji-btn" *ngFor="let emoji of quickReactions" 
                [class.selected]="hasReaction(contextMenuMessage, emoji)"
                (click)="addReactionToMessage(contextMenuMessage, emoji); $event.stopPropagation()">
          {{ emoji }}
        </button>
      </div>

      <!-- Action Menu -->
      <div class="action-menu">
        <button class="action-item" (click)="onContextMenuAction('reply')">
          <ion-icon name="arrow-undo-outline"></ion-icon>
          <span>Reply</span>
        </button>
        
        <button class="action-item" *ngIf="contextMenuMessage?.type === 'text'" 
                (click)="onContextMenuAction('copy')">
          <ion-icon name="copy-outline"></ion-icon>
          <span>Copy</span>
        </button>
        
        <button class="action-item" (click)="onContextMenuAction('forward')">
          <ion-icon name="arrow-redo-outline"></ion-icon>
          <span>Forward</span>
        </button>
        
        <button class="action-item" *ngIf="contextMenuMessage && isMyMessage(contextMenuMessage)" 
                (click)="onContextMenuAction('delete')">
          <ion-icon name="trash-outline" color="danger"></ion-icon>
          <span class="text-danger">Delete</span>
        </button>
        
        <button class="action-item" (click)="onContextMenuAction('more')">
          <ion-icon name="ellipsis-horizontal"></ion-icon>
          <span>More...</span>
        </button>
      </div>
    </div>
  </div>

  <div class="messages-container" [class.desktop-layout]="isDesktop">
    
    <!-- Desktop Two-Column Layout -->
    <div class="desktop-messages-wrapper" 
         [class.details-open]="showDetailsPanel"
         *ngIf="isDesktop">
      <!-- Left Column: Conversation List -->
      <div class="conversations-panel">
        <div class="conversations-header">
          <h2>Messages</h2>
          <div class="header-actions">
            <ion-button fill="clear" size="small">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small">
              <ion-icon name="search-outline"></ion-icon>
            </ion-button>
          </div>
        </div>

        <!-- Conversations Search Header -->
        <div class="conversations-search-header" [@slideInUp]>
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input
            type="text"
            class="search-input"
            placeholder="Search by name"
            [value]="searchTerm"
            (input)="onSearchChange($any($event.target).value)"
          />
          <ion-icon 
            *ngIf="searchTerm" 
            name="close-circle" 
            class="clear-icon"
            (click)="clearSearch()">
          </ion-icon>
        </div>

        <!-- Conversations Filter Buttons -->
        <div class="conversations-filter-container">
          <button 
            class="filter-button" 
            [class.active]="conversationsFilter === 'all'"
            (click)="setConversationsFilter('all')">
            All
          </button>
          <button 
            class="filter-button" 
            [class.active]="conversationsFilter === 'unread'"
            (click)="setConversationsFilter('unread')">
            Unread
          </button>
        </div>

        <!-- Loading State (only on initial load) -->
        <div *ngIf="isInitialLoad && isLoading" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>

        <!-- Conversations List (stays visible after first load) -->
        <div class="conversations-list" *ngIf="!isInitialLoad || !isLoading" [@fadeInOut]>
          <div 
            *ngFor="let conversation of filteredConversations; let i = index; trackBy: trackByConversationId" 
            class="conversation-item"
            [attr.data-conversation-id]="conversation.conversationId"
            [class.active]="selectedConversation?.conversationId === conversation.conversationId"
            (click)="selectConversation(conversation, $event)"
            [@slideInUp]
            [style.animation-delay]="i * 50 + 'ms'">
            <ion-avatar class="conversation-avatar">
              <!-- System message: show app icon -->
              <img *ngIf="conversation.lastMessage?.isSystemMessage || conversation.lastMessage?.type === 'system'" 
                   src="assets/app-icon.png" 
                   alt="Speak Freely" />
              <!-- Regular message: show user picture or fallback -->
              <img *ngIf="!conversation.lastMessage?.isSystemMessage && conversation.lastMessage?.type !== 'system' && conversation.otherUser?.picture" 
                   [src]="conversation.otherUser?.picture" />
              <div class="avatar-fallback" 
                   *ngIf="!conversation.lastMessage?.isSystemMessage && conversation.lastMessage?.type !== 'system' && !conversation.otherUser?.picture">
                {{ conversation.otherUser?.name?.charAt(0) || '?' }}
              </div>
            </ion-avatar>
            <div class="conversation-info">
              <div class="conversation-header-row">
                <h3>{{ conversation.otherUser?.name || 'Unknown User' }}</h3>
                <span class="timestamp">
                  {{ formatTime(conversation.lastMessage.createdAt) }}
                </span>
              </div>
              <div class="conversation-preview-row">
                <p class="preview-text" 
                   [class.sent-by-me]="conversation.lastMessage.senderId === getCurrentUserId()">
                  <!-- For reactions, show the person's name who reacted -->
                  <span *ngIf="conversation.lastMessage.type === 'reaction' && conversation.lastMessage.senderId !== getCurrentUserId()">
                    {{ conversation.otherUser?.name }}: {{ conversation.lastMessage.content }}
                  </span>
                  <span *ngIf="conversation.lastMessage.type === 'reaction' && conversation.lastMessage.senderId === getCurrentUserId()">
                    You: {{ conversation.lastMessage.content }}
                  </span>
                  <!-- Regular messages with You: prefix -->
                  <span *ngIf="conversation.lastMessage.type !== 'reaction' && conversation.lastMessage.senderId === getCurrentUserId()">You: </span>
                  <!-- Regular message content -->
                  <span *ngIf="conversation.lastMessage.type !== 'reaction' && conversation.lastMessage.type !== 'system' && !conversation.lastMessage.isSystemMessage">{{ conversation.lastMessage.content }}</span>
                  <!-- System messages with HTML -->
                  <span *ngIf="conversation.lastMessage.type !== 'reaction' && (conversation.lastMessage.type === 'system' || conversation.lastMessage.isSystemMessage)" [innerHTML]="conversation.lastMessage.content"></span>
                </p>
                <ion-badge *ngIf="conversation.unreadCount > 0" color="primary" class="unread-badge">
                  {{ conversation.unreadCount }}
                </ion-badge>
              </div>
            </div>
          </div>
        </div>

        <!-- Search Empty State -->
        <div *ngIf="!isInitialLoad && searchTerm && filteredConversations.length === 0 && conversations.length > 0" class="empty-state search-empty-state" [@fadeInOut]>
          <ion-icon name="search-outline" class="empty-icon"></ion-icon>
          <p>Hmm, can't find that</p>
          <p class="empty-hint">Try searching with a different name</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isInitialLoad && conversations.length === 0 && showEmptyState && !searchTerm" class="empty-state" [@fadeInOut]>
          <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
          <p>No conversations yet</p>
          <p class="empty-hint" *ngIf="currentUserType === 'student'">Start messaging from a tutor's profile</p>
          <p class="empty-hint" *ngIf="currentUserType === 'tutor'">Student messages will appear here.</p>
        </div>
      </div>

      <!-- Middle Column: Chat View or Empty State -->
      
      <!-- STABLE NAME - Always rendered, visibility controlled by opacity -->
      <div class="stable-chat-header" 
           [style.opacity]="hasConversationSelected ? '1' : '0'"
           [style.pointer-events]="hasConversationSelected ? 'auto' : 'none'">
           <ion-avatar class="stable-chat-avatar">
            <img [src]="selectedConversation?.otherUser?.picture" *ngIf="selectedConversation?.otherUser?.picture" />
            <div class="avatar-fallback" *ngIf="!selectedConversation?.otherUser?.picture && selectedConversation">
              {{ selectedConversation?.otherUser?.name?.charAt(0) || '?' }}
            </div>
          </ion-avatar>
        <div class="stable-chat-name" 
             [textContent]="selectedConversation?.otherUser?.name || ''"
             (click)="toggleDetailsPanel()"
             (mouseenter)="showHoverCard()"
             (mouseleave)="hideHoverCard()">
        </div>

        <ion-button size="small" fill="clear" (click)="openBookLesson(); $event.stopPropagation()" *ngIf="selectedConversation && currentUserType === 'student'">
          <ion-icon name="calendar-outline" slot="start"></ion-icon>
          Book Lesson
        </ion-button>
      </div>
      <!-- Chat Panel (always in DOM, visibility controlled by opacity) -->
      <div class="chat-panel" 
           [style.opacity]="hasConversationSelected ? '1' : '0'"
           [style.pointer-events]="hasConversationSelected ? 'auto' : 'none'"
           [style.display]="hasConversationSelected ? 'flex' : 'none'">
        <!-- Simplified header for desktop - always visible when panel shown -->
        <div class="chat-header">
          <div class="chat-header-info" 
               (click)="toggleDetailsPanel()" 
               (mouseenter)="showHoverCard()"
               (mouseleave)="hideHoverCard()">
            <!-- Name moved above, this space for other header elements -->
            <p class="typing-indicator" *ngIf="otherUserTyping">
              <span class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
              </span>
              Typing...
            </p>

            <!-- Hover Card -->
            <div class="user-hover-card" 
                 *ngIf="showUserHoverCard && selectedConversation?.otherUser"
                 (mouseenter)="showHoverCard()"
                 (mouseleave)="hideHoverCard()">
              <!-- Row 1: Avatar + Name -->
              <div class="hover-card-header">
                <ion-avatar class="hover-card-avatar">
                  <img [src]="selectedConversation?.otherUser?.picture" *ngIf="selectedConversation?.otherUser?.picture" />
                  <div class="avatar-fallback" *ngIf="!selectedConversation?.otherUser?.picture">
                    {{ selectedConversation?.otherUser?.name?.charAt(0) || '?' }}
                  </div>
                </ion-avatar>
                <h4 class="hover-card-name">{{ selectedConversation?.otherUser?.name }}</h4>
              </div> 

              <!-- Row 2: Time + Action Buttons -->
              <div class="hover-card-actions">
                <span class="local-time" *ngIf="selectedConversation?.otherUser?.timezone">
                  <ion-icon name="time-outline"></ion-icon>
                  {{ getUserLocalTime(selectedConversation?.otherUser) }}
                </span>
                <span class="local-time-placeholder" *ngIf="!selectedConversation?.otherUser?.timezone">
                  <ion-icon name="time-outline"></ion-icon>
                  Time unavailable
                </span>
              </div>

              <div class="hover-card-buttons">
                <ion-button size="small" fill="default" (click)="openBookLesson(); $event.stopPropagation()" *ngIf="currentUserType === 'student'">
                  <ion-icon name="calendar-outline" slot="start"></ion-icon>
                  Book Lesson
                </ion-button>
                <ion-button size="small" fill="clear" (click)="openOtherUserProfile($event)">
                  <ion-icon name="person-outline" slot="start"></ion-icon>
                  View Profile  
                </ion-button>
              </div>
            </div>
          </div>
        </div>

        <div class="chat-messages" #chatContainer>
          <!-- Loading Overlay - covers entire messages area with smooth fade -->
          <div *ngIf="isLoadingMessages" class="loading-overlay">
            <div class="loading-content">
              <ion-spinner name="crescent"></ion-spinner>
              <p>Loading messages...</p>
            </div>
          </div>

          <!-- Messages List - hidden when loading to prevent flash -->
          <div class="messages-list" [hidden]="isLoadingMessages" [style.display]="isLoadingMessages ? 'none' : 'flex'">
            <!-- Empty State -->
            <div *ngIf="messages.length === 0" class="empty-state">
              <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
              <h2>No messages yet</h2>
              <p>Start the conversation!</p>
            </div>
            
            <!-- Messages -->
            <div *ngIf="messages.length > 0">
              <div *ngFor="let message of messages; let i = index; trackBy: trackByMessageId" 
                   [attr.data-message-id]="message.id">
                <!-- Date Separator -->
                <div *ngIf="shouldShowDateSeparator(message, messages[i - 1])" class="date-separator">
                  {{ formatDate(message.createdAt) }}
                </div>

            <!-- System Message -->
            <div *ngIf="message.type === 'system' || message.isSystemMessage" class="message-wrapper received">
              <img src="assets/app-icon.png" alt="Speak Freely" class="message-avatar system-avatar">
              <div class="message-bubble system-message" (click)="handleSystemMessageClick($event)">
                <span class="message-text" [innerHTML]="message.content | markdownLink"></span>
                <span class="message-timestamp">{{ message.createdAt | date: 'short' }}</span>
              </div>
            </div>

              <!-- Regular Message Bubble -->
              <div *ngIf="message.type !== 'system' && !message.isSystemMessage"
                   class="message-wrapper"
                   [class.has-reactions]="message.reactions && message.reactions.length > 0">
              <div class="message-bubble" 
                   [class.sent]="message.senderId === getCurrentUserId()"
                   [class.received]="message.senderId !== getCurrentUserId()"
                   [class.highlighted]="highlightedMessageId === message.id"
                   (mousedown)="onMessagePressStart(message, $event)"
                   (touchstart)="onMessagePressStart(message, $event)"
                   (mouseup)="onMessagePressEnd($event)"
                   (touchend)="onMessagePressEnd($event)"
                   (mouseleave)="onMessagePressEnd($event)"
                   (touchcancel)="onMessagePressEnd($event)"
                   (press)="onMessageTap(message, $event)">
                
                <!-- Replied-to message preview (if this is a reply) -->
                <div *ngIf="message.replyTo" 
                     class="reply-to-preview" 
                     (click)="scrollToMessageById(message.replyTo.messageId, $event)">
                  <div class="reply-to-line"></div>
                  <div class="reply-to-content">
                    <span class="reply-to-sender">{{ message.replyTo.senderName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'text'">{{ message.replyTo.content }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'image'">ðŸ“· Photo</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'file'">ðŸ“„ {{ message.replyTo.fileName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'voice'">ðŸŽ¤ Voice message</span>
                  </div>
                </div>
                
                <!-- Text message -->
                <div *ngIf="message.type === 'text'" 
                     class="message-content"
                     [class.emoji-only]="isEmojiOnly(message.content)">
                  {{ message.content }}
                </div>
                
                <!-- Image message -->
                <div *ngIf="message.type === 'image'" class="message-image">
                  <img [src]="message.fileUrl" [alt]="message.fileName" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)" />
                  <p *ngIf="message.content" class="image-caption">{{ message.content }}</p>
                </div>
                
                <!-- Document message -->
                <div *ngIf="message.type === 'file'" class="message-file">
                  <div class="file-info" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)">
                    <ion-icon [name]="getFileIcon(message.fileType!)" class="file-icon"></ion-icon>
                    <div class="file-details">
                      <p class="file-name">{{ message.fileName }}</p>
                      <p class="file-size">{{ formatFileSize(message.fileSize!) }}</p>
                    </div>
                    <ion-icon name="download-outline" class="download-icon"></ion-icon>
                  </div>
                  <p *ngIf="message.content" class="file-caption">{{ message.content }}</p>
                </div>
                
                <!-- Voice note message -->
                <div *ngIf="message.type === 'voice'" class="message-voice">
                  <ion-icon name="play-circle" class="voice-icon"></ion-icon>
                  <audio [src]="message.fileUrl" controls class="voice-player"></audio>
                  <span class="voice-duration" *ngIf="message.duration">{{ message.duration }}s</span>
                </div>
                
                <div class="message-time">
                  {{ formatTime(message.createdAt) }}
                </div>

                <!-- Reactions Display -->
                <div class="message-reactions" *ngIf="message.reactions && message.reactions.length > 0">
                  <div class="reaction-bubble" *ngFor="let reaction of message.reactions" 
                       [title]="reaction.userName">
                    <div class="bubble-tail">
                      <span class="tail-dot tail-dot-small"></span>
                      <span class="tail-dot tail-dot-medium"></span>
                    </div>
                    <span class="reaction-main" (click)="onReactionClick(message, reaction.emoji, $event)">
                      {{ reaction.emoji }}
                    </span>
                  </div>
                </div>
              </div>
              </div> <!-- Close message-wrapper for regular messages -->
            </div> <!-- Close message iteration -->
            </div> <!-- Close messages.length > 0 div -->
          </div> <!-- Close messages-list -->
        </div> <!-- Close chat-messages -->

        <!-- Reply Preview -->
        <div *ngIf="replyingToMessage" class="replying-to-container">
          <div class="replying-to-header">
            <ion-icon name="arrow-undo-outline" class="reply-icon"></ion-icon>
            <span class="replying-to-label">Replying to {{ isMyMessage(replyingToMessage) ? 'yourself' : (selectedConversation?.otherUser?.name || 'Unknown') }}</span>
            <ion-icon name="close-outline" class="close-reply-icon" (click)="clearReply()"></ion-icon>
          </div>
          <button 
            class="replying-to-preview-button" 
            (click)="scrollToRepliedMessage($event)"
            type="button">
            {{ getReplyPreviewContent() }}
          </button>
        </div>

        <!-- Pending Voice Note Preview -->
        <div *ngIf="pendingVoiceNote" class="voice-preview">
          <div class="voice-preview-header">
            <ion-icon name="mic-circle"></ion-icon>
            <span class="voice-preview-label">Voice note {{ pendingVoiceNote.duration }}s</span>
          </div>
          <audio [src]="pendingVoiceNote.url" controls></audio>
          <div class="voice-preview-actions">
            <ion-button fill="clear" size="small" color="medium" (click)="clearPendingVoiceNote()">
              <ion-icon slot="start" name="trash-outline"></ion-icon>
              Discard
            </ion-button>
            <ion-button size="small" (click)="sendPendingVoiceNote()" [disabled]="isUploading">
              <ion-icon slot="start" name="send"></ion-icon>
              Send
            </ion-button>
          </div>
        </div>

        <!-- Message Input -->
        <div class="message-input-container">
          <!-- Hidden file inputs -->
          <input type="file" #imageInput accept="image/*" (change)="onFileSelected($event, 'image')" style="display: none;">
          <input type="file" #documentInput accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" (change)="onFileSelected($event, 'file')" style="display: none;">
          
          <ion-button fill="clear" size="small" (click)="imageInput.click()" [disabled]="isUploading">
            <ion-icon name="image-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="documentInput.click()" [disabled]="isUploading">
            <ion-icon name="attach-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="toggleVoiceRecording()" [disabled]="isUploading">
            <ion-icon [name]="isRecording ? 'stop-circle' : 'mic-outline'" [color]="isRecording ? 'danger' : ''"></ion-icon>
          </ion-button>
          <ion-input
            #messageInput
            [(ngModel)]="newMessage"
            placeholder="Type a message"
            (ionInput)="onInputChange()"
            (keydown.enter)="sendMessage()"
            class="message-input"
            [disabled]="isUploading || isRecording">
          </ion-input>
          <ion-button fill="clear" size="small" (click)="sendMessage()" [disabled]="!newMessage.trim() || isSending || isUploading || isRecording">
            <ion-icon name="send-outline"></ion-icon>
          </ion-button>
          
          <!-- Upload progress indicator -->
          <div *ngIf="isUploading" class="upload-progress">
            <ion-spinner name="crescent"></ion-spinner>
            <span>Uploading...</span>
          </div>
          
          <!-- Recording indicator -->
          <div *ngIf="isRecording" class="recording-indicator">
            <ion-icon name="radio-button-on" color="danger"></ion-icon>
            <span>Recording... {{ recordingDuration }}s</span>
          </div>
        </div>
      </div>

      <!-- Right Panel: User Details (Desktop Only) -->
      <div class="details-panel" *ngIf="showDetailsPanel && selectedConversation?.otherUser as otherUser">
        <div class="details-header">
          <ion-button fill="clear" size="small" *ngIf="showAvailabilityViewer || showCheckout" (click)="showCheckout ? onCheckoutCancelled() : closeAvailabilityViewer()">
            <ion-icon name="arrow-back"></ion-icon>
          </ion-button>
          <h3>{{ showCheckout ? 'Checkout' : showAvailabilityViewer ? 'Book Lesson' : 'Details' }}</h3>
          <ion-button fill="clear" size="small" (click)="toggleDetailsPanel()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </div>

        <!-- Availability Viewer -->
        <div class="details-content availability-viewer-container" *ngIf="showAvailabilityViewer && !showCheckout && otherUser" style="padding: 6px; overflow-y: auto; font-size: 10px;" #availabilityContainer>

          <app-tutor-availability-viewer
            [tutorId]="otherUser.id"
            [tutorName]="otherUser.name"
            [inline]="true"
            [showDurationSelector]="true"
            (slotSelected)="onSlotSelected($event)"
            [selectionMode]="true" 
            style="font-size: 10px;">
          </app-tutor-availability-viewer>
        </div>

        <!-- Checkout -->
        <div class="details-content checkout-container" *ngIf="showCheckout && checkoutData">
          <app-checkout
            [tutorId]="checkoutData.tutorId"
            [dateIso]="checkoutData.date"
            [time]="checkoutData.time"
            [lessonMinutes]="checkoutData.duration"
            [embedded]="true"
            (bookingComplete)="onCheckoutComplete()"
            (cancelled)="onCheckoutCancelled()">
          </app-checkout>
        </div>

        <!-- User Profile Section -->
        <div class="details-content" *ngIf="!showAvailabilityViewer && !showCheckout">
          <div class="user-profile-section">
            <div class="profile-image-container">
              <ion-avatar class="profile-avatar" (click)="openOtherUserProfile($event)" style="cursor: pointer;">
                <img [src]="otherUser?.picture" *ngIf="otherUser?.picture" />
                <div class="avatar-fallback" *ngIf="!otherUser?.picture">
                  {{ otherUser?.name?.charAt(0) || '?' }}
                </div>
              </ion-avatar>
            </div>
            
            <h2 class="user-name" (click)="openOtherUserProfile($event)" style="cursor: pointer;">
              {{ otherUser?.name || 'Unknown User' }}
            </h2>

            <!-- Tutor Details -->
            <div class="user-meta" *ngIf="otherUser?.userType === 'tutor'">
              <div class="rating-section" *ngIf="otherUser?.rating">
                <ion-icon *ngFor="let star of [1,2,3,4,5]" 
                          [name]="star <= (otherUser?.rating || 0) ? 'star' : 'star-outline'"
                          class="star-icon"></ion-icon>
                <span class="rating-count">({{ otherUser?.rating?.toFixed(1) }})</span>
              </div>

              <div class="price-section" *ngIf="otherUser?.hourlyRate">
                <strong>${{ otherUser?.hourlyRate }}</strong> per lesson
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <ion-button expand="block" color="primary" class="primary-action-btn" (click)="openBookLesson()">
                <ion-icon name="calendar-outline" slot="start"></ion-icon>
                Schedule lessons
              </ion-button>
              <ion-button expand="block" fill="outline" class="secondary-action-btn">
                <ion-icon name="videocam-outline" slot="start"></ion-icon>
                Enter classroom
              </ion-button>
              <ion-button expand="block" fill="outline" class="secondary-action-btn">
                <ion-icon name="create-outline" slot="start"></ion-icon>
                Post review
              </ion-button>
            </div>
          </div>

          <!-- Subject Section (for tutors) -->
          <div class="detail-section" *ngIf="otherUser?.userType === 'tutor' && otherUser?.languages?.length">
            <div class="section-header">
              <ion-icon name="book-outline"></ion-icon>
              <span>Subject</span>
            </div>
            <div class="section-content">
              <div class="languages-list">
                <span *ngFor="let lang of otherUser?.languages; let last = last" class="language-item">
                  <span>{{ lang }}</span>
                  <app-flag-icon [language]="lang" [size]="16" cssClass="language-flag" style="margin-left: 4px;"></app-flag-icon>
                  <span *ngIf="!last">, </span>
                </span>
              </div>
            </div>
          </div>

          <!-- Bio Section (if available) -->
          <div class="detail-section" *ngIf="otherUser?.bio">
            <div class="section-header">
              <ion-icon name="person-outline"></ion-icon>
              <span>About</span>
            </div>
            <div class="section-content">
              <p>{{ otherUser?.bio }}</p>
            </div>
          </div>

          <!-- Additional Actions -->
          <div class="detail-actions">
            <button class="detail-action-item">
              <ion-icon name="share-outline"></ion-icon>
              <span>Share</span>
            </button>
            <button class="detail-action-item">
              <ion-icon name="archive-outline"></ion-icon>
              <span>Archive</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Desktop: Empty State when no conversation selected -->
      <div class="chat-panel-empty" [style.display]="hasConversationSelected || selectedConversation ? 'none' : 'flex'">
        <div class="empty-chat-state">
          <ion-icon name="chatbubbles-outline" class="empty-chat-icon"></ion-icon>
          <h2>Select a conversation</h2>
          <p>Choose a conversation from the list to start messaging</p>
        </div>
      </div>
    </div>

    <!-- Mobile Single Column Layout -->
    <div class="mobile-messages-wrapper" *ngIf="!isDesktop">
      <!-- Conversation List View (Mobile) -->
      <div class="conversations-panel" *ngIf="!selectedConversation">
        <div class="conversations-header">
          <h2>Messages</h2>
        </div>

        <!-- Mobile: Conversations Search Header -->
        <div class="conversations-search-header" [@slideInUp]>
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input
            type="text"
            class="search-input"
            placeholder="Search by name"
            [value]="searchTerm"
            (input)="onSearchChange($any($event.target).value)"
          />
          <ion-icon 
            *ngIf="searchTerm" 
            name="close-circle" 
            class="clear-icon"
            (click)="clearSearch()">
          </ion-icon>
        </div>

        <!-- Mobile: Conversations Filter Buttons -->
        <div class="conversations-filter-container">
          <button 
            class="filter-button" 
            [class.active]="conversationsFilter === 'all'"
            (click)="setConversationsFilter('all')">
            All
          </button>
          <button 
            class="filter-button" 
            [class.active]="conversationsFilter === 'unread'"
            (click)="setConversationsFilter('unread')">
            Unread
          </button>
        </div>

        <div *ngIf="isInitialLoad && isLoading" class="loading-container">
          <ion-spinner name="crescent"></ion-spinner>
        </div>

        <div class="conversations-list" *ngIf="(!isInitialLoad || !isLoading) && filteredConversations.length > 0" [@fadeInOut]>
          <div 
            *ngFor="let conversation of filteredConversations; let i = index; trackBy: trackByConversationId" 
            class="conversation-item"
            [attr.data-conversation-id]="conversation.conversationId"
            (click)="selectConversation(conversation, $event)"
            [@slideInUp]
            [style.animation-delay]="i * 50 + 'ms'">
            <ion-avatar class="conversation-avatar">
              <!-- System message: show app icon -->
              <img *ngIf="conversation.lastMessage?.isSystemMessage || conversation.lastMessage?.type === 'system'" 
                   src="assets/app-icon.png" 
                   alt="Speak Freely" />
              <!-- Regular message: show user picture or fallback -->
              <img *ngIf="!conversation.lastMessage?.isSystemMessage && conversation.lastMessage?.type !== 'system' && conversation.otherUser?.picture" 
                   [src]="conversation.otherUser?.picture" />
              <div class="avatar-fallback" 
                   *ngIf="!conversation.lastMessage?.isSystemMessage && conversation.lastMessage?.type !== 'system' && !conversation.otherUser?.picture">
                {{ conversation.otherUser?.name?.charAt(0) || '?' }}
              </div>
            </ion-avatar>
            <div class="conversation-info">
              <div class="conversation-header-row">
                <h3>{{ conversation.otherUser?.name || 'Unknown User' }}</h3>
                <span class="timestamp">
                  {{ formatTime(conversation.lastMessage.createdAt) }}
                </span>
              </div>
              <div class="conversation-preview-row">
                <p class="preview-text">
                  <!-- For reactions, show the person's name who reacted -->
                  <span *ngIf="conversation.lastMessage.type === 'reaction' && conversation.lastMessage.senderId !== getCurrentUserId()">
                    {{ conversation.otherUser?.name }}: {{ conversation.lastMessage.content }}
                  </span>
                  <span *ngIf="conversation.lastMessage.type === 'reaction' && conversation.lastMessage.senderId === getCurrentUserId()">
                    You: {{ conversation.lastMessage.content }}
                  </span>
                  <!-- Regular message content -->
                  <span *ngIf="conversation.lastMessage.type !== 'reaction' && conversation.lastMessage.type !== 'system' && !conversation.lastMessage.isSystemMessage">{{ conversation.lastMessage.content }}</span>
                  <!-- System messages with HTML -->
                  <span *ngIf="conversation.lastMessage.type !== 'reaction' && (conversation.lastMessage.type === 'system' || conversation.lastMessage.isSystemMessage)" [innerHTML]="conversation.lastMessage.content"></span>
                </p>
                <ion-badge *ngIf="conversation.unreadCount > 0" color="primary" class="unread-badge">
                  {{ conversation.unreadCount }}
                </ion-badge>
              </div>
            </div>
          </div>
        </div>

        <!-- Search Empty State (Mobile) -->
        <div *ngIf="!isInitialLoad && searchTerm && filteredConversations.length === 0 && conversations.length > 0" class="empty-state search-empty-state" [@fadeInOut]>
          <ion-icon name="search-outline" class="empty-icon"></ion-icon>
          <h2>Hmm, can't find that</h2>
          <p class="empty-hint">Try searching with a different name</p>
        </div>

        <div *ngIf="!isInitialLoad && conversations.length === 0 && showEmptyState && !searchTerm" class="empty-state" [@fadeInOut]>
          <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
          <h2>No messages yet</h2>
          <p *ngIf="currentUserType === 'student'">Start a conversation by messaging a tutor from their profile.</p>
          <p *ngIf="currentUserType === 'tutor'">Student messages will appear here.</p>
        </div>
      </div>

      <!-- Chat View (Mobile) -->
      <div class="chat-view-mobile" *ngIf="selectedConversation">
        <div class="chat-header">
          <ion-button fill="clear" (click)="clearSelectedConversation()" class="back-button">
            <ion-icon name="chevron-back"></ion-icon>
          </ion-button>
          <ion-avatar class="chat-avatar" (click)="openOtherUserProfile($event)">
            <img [src]="selectedConversation.otherUser?.picture" *ngIf="selectedConversation.otherUser?.picture" />
            <div class="avatar-fallback" *ngIf="!selectedConversation.otherUser?.picture">
              {{ selectedConversation.otherUser?.name?.charAt(0) || '?' }}
            </div>
          </ion-avatar>
          <div class="chat-header-info" (click)="openOtherUserProfile($event)">
            <div class="chat-user-info">
              <h3>{{ selectedConversation.otherUser?.name || 'Unknown User' }}</h3>
              <p class="typing-indicator" *ngIf="otherUserTyping">Typing...</p>
              <div class="user-details" *ngIf="!otherUserTyping && selectedConversation.otherUser">
                <!-- User type -->
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType === 'tutor'">
                  Tutor
                </p>
                <p class="user-status" *ngIf="selectedConversation.otherUser.userType !== 'tutor'">
                  {{ selectedConversation.otherUser.userType || 'User' }}
                </p>
                <!-- Time status under user type -->
                <p class="time-status-mobile" *ngIf="selectedConversation.otherUser.userType === 'tutor'">
                  <ion-icon name="time-outline"></ion-icon>
                  <span *ngIf="selectedConversation.otherUser.timezone">
                    {{ getUserLocalTime(selectedConversation.otherUser) }}
                  </span>
                  <span *ngIf="!selectedConversation.otherUser.timezone">
                    Time unavailable
                  </span>
                </p>
              </div>
            </div>
          </div>
          
          <!-- Mobile: Book Lesson Button (right side) -->
          <ion-button 
            *ngIf="selectedConversation.otherUser?.userType === 'tutor' && currentUserType === 'student'"
            fill="solid" 
            size="small" 
            color="primary"
            class="mobile-book-btn" 
            (click)="openBookLesson(); $event.stopPropagation()">
            <ion-icon name="calendar-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>

        <div class="chat-messages" #chatContainer>
          <!-- Loading Overlay - covers entire messages area with smooth fade -->
          <div *ngIf="isLoadingMessages" class="loading-overlay">
            <div class="loading-content">
              <ion-spinner name="crescent"></ion-spinner>
              <p>Loading messages...</p>
            </div>
          </div>

          <!-- Messages List - hidden when loading to prevent flash -->
          <div class="messages-list" [hidden]="isLoadingMessages" [style.display]="isLoadingMessages ? 'none' : 'flex'">
            <!-- Empty State -->
            <div *ngIf="messages.length === 0" class="empty-state">
              <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
              <h2>No messages yet</h2>
              <p>Start the conversation!</p>
            </div>
            
            <!-- Messages -->
            <div *ngIf="messages.length > 0">
              <div *ngFor="let message of messages; let i = index; trackBy: trackByMessageId" 
                   [attr.data-message-id]="message.id">
                <div *ngIf="shouldShowDateSeparator(message, messages[i - 1])" class="date-separator">
                  {{ formatDate(message.createdAt) }}
                </div>

            <!-- System Message (Mobile) -->
            <div *ngIf="message.type === 'system' || message.isSystemMessage" class="message-wrapper received">
              <img src="assets/app-icon.png" alt="Speak Freely" class="message-avatar system-avatar">
              <div class="message-bubble system-message" (click)="handleSystemMessageClick($event)">
                <span class="message-text" [innerHTML]="message.content | markdownLink"></span>
                <span class="message-timestamp">{{ message.createdAt | date: 'short' }}</span>
              </div>
            </div>

              <!-- Regular Message Bubble (Mobile) -->
              <div *ngIf="message.type !== 'system' && !message.isSystemMessage"
                   class="message-wrapper"
                   [class.has-reactions]="message.reactions && message.reactions.length > 0">
              <div class="message-bubble" 
                   [class.sent]="message.senderId === getCurrentUserId()"
                   [class.received]="message.senderId !== getCurrentUserId()"
                   [class.highlighted]="highlightedMessageId === message.id"
                   (mousedown)="onMessagePressStart(message, $event)"
                   (touchstart)="onMessagePressStart(message, $event)"
                   (mouseup)="onMessagePressEnd($event)"
                   (touchend)="onMessagePressEnd($event)"
                   (mouseleave)="onMessagePressEnd($event)"
                   (touchcancel)="onMessagePressEnd($event)"
                   (press)="onMessageTap(message, $event)">
                
                <!-- Replied-to message preview (if this is a reply) -->
                <div *ngIf="message.replyTo" 
                     class="reply-to-preview" 
                     (click)="scrollToMessageById(message.replyTo.messageId, $event)">
                  <div class="reply-to-line"></div>
                  <div class="reply-to-content">
                    <span class="reply-to-sender">{{ message.replyTo.senderName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'text'">{{ message.replyTo.content }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'image'">ðŸ“· Photo</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'file'">ðŸ“„ {{ message.replyTo.fileName }}</span>
                    <span class="reply-to-text" *ngIf="message.replyTo.type === 'voice'">ðŸŽ¤ Voice message</span>
                  </div>
                </div>
                
                <!-- Text message -->
                <div *ngIf="message.type === 'text'" 
                     class="message-content"
                     [class.emoji-only]="isEmojiOnly(message.content)">{{ message.content }}</div>
                
                <!-- Image message -->
                <div *ngIf="message.type === 'image'" class="message-image">
                  <img [src]="message.fileUrl" [alt]="message.fileName" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)" />
                  <p *ngIf="message.content" class="image-caption">{{ message.content }}</p>
                </div>
                
                <!-- Document message -->
                <div *ngIf="message.type === 'file'" class="message-file">
                  <div class="file-info" (click)="openFile(message.fileUrl!, message.fileType, message.fileName)">
                    <ion-icon [name]="getFileIcon(message.fileType!)" class="file-icon"></ion-icon>
                    <div class="file-details">
                      <p class="file-name">{{ message.fileName }}</p>
                      <p class="file-size">{{ formatFileSize(message.fileSize!) }}</p>
                    </div>
                    <ion-icon name="download-outline" class="download-icon"></ion-icon>
                  </div>
                  <p *ngIf="message.content" class="file-caption">{{ message.content }}</p>
                </div>
                
                <!-- Voice note message -->
                <div *ngIf="message.type === 'voice'" class="message-voice">
                  <audio [src]="message.fileUrl" controls class="voice-player"></audio>
                </div>
                
                <div class="message-time">{{ formatTime(message.createdAt) }}</div>

                <!-- Reactions Display (Mobile) -->
                <div class="message-reactions" *ngIf="message.reactions && message.reactions.length > 0">
                  <div class="reaction-bubble" *ngFor="let reaction of message.reactions" 
                       [title]="reaction.userName">
                    <div class="bubble-tail">
                      <span class="tail-dot tail-dot-small"></span>
                      <span class="tail-dot tail-dot-medium"></span>
                    </div>
                    <span class="reaction-main" (click)="onReactionClick(message, reaction.emoji, $event)">
                      {{ reaction.emoji }}
                    </span>
                  </div>
                </div>
              </div>
              </div> <!-- Close message-wrapper for regular messages (Mobile) -->
            </div> <!-- Close message iteration (Mobile) -->
            </div> <!-- Close messages.length > 0 div (Mobile) -->
          </div> <!-- Close messages-list (Mobile) -->
        </div> <!-- Close chat-messages (Mobile) -->

        <!-- Reply Preview (Mobile) -->
        <div *ngIf="replyingToMessage" class="replying-to-container">
          <div class="replying-to-header">
            <ion-icon name="arrow-undo-outline" class="reply-icon"></ion-icon>
            <span class="replying-to-label">Replying to {{ isMyMessage(replyingToMessage) ? 'yourself' : (selectedConversation?.otherUser?.name || 'Unknown') }}</span>
            <ion-icon name="close-outline" class="close-reply-icon" (click)="clearReply()"></ion-icon>
          </div>
          <button 
            class="replying-to-preview-button" 
            (click)="scrollToRepliedMessage($event)"
            type="button">
            {{ getReplyPreviewContent() }}
          </button>
        </div>

        <!-- Pending Voice Note Preview (Mobile) -->
        <div *ngIf="pendingVoiceNote" class="voice-preview">
          <div class="voice-preview-header">
            <ion-icon name="mic-circle"></ion-icon>
            <span class="voice-preview-label">Voice note {{ pendingVoiceNote.duration }}s</span>
          </div>
          <audio [src]="pendingVoiceNote.url" controls></audio>
          <div class="voice-preview-actions">
            <ion-button fill="clear" size="small" color="medium" (click)="clearPendingVoiceNote()">
              <ion-icon slot="start" name="trash-outline"></ion-icon>
              Discard
            </ion-button>
            <ion-button size="small" (click)="sendPendingVoiceNote()" [disabled]="isUploading">
              <ion-icon slot="start" name="send"></ion-icon>
              Send
            </ion-button>
          </div>
        </div>
 
        <div class="message-input-container">
          <!-- Hidden file inputs -->
          <input type="file" #imageInputMobile accept="image/*" (change)="onFileSelected($event, 'image')" style="display: none;">
          <input type="file" #documentInputMobile accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" (change)="onFileSelected($event, 'file')" style="display: none;">
          
          <ion-button fill="clear" size="small" (click)="imageInputMobile.click()" [disabled]="isUploading">
            <ion-icon name="image-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="documentInputMobile.click()" [disabled]="isUploading">
            <ion-icon name="attach-outline"></ion-icon>
          </ion-button>
          <ion-button fill="clear" size="small" (click)="toggleVoiceRecording()" [disabled]="isUploading">
            <ion-icon [name]="isRecording ? 'stop-circle' : 'mic-outline'" [color]="isRecording ? 'danger' : ''"></ion-icon>
          </ion-button>
          <ion-input
            #messageInput
            [(ngModel)]="newMessage"
            placeholder="Type a message"
            (ionInput)="onInputChange()"
            (keydown.enter)="sendMessage()"
            [disabled]="isUploading || isRecording">
          </ion-input>
          <ion-button fill="clear" (click)="sendMessage()" [disabled]="!newMessage.trim() || isSending || isUploading || isRecording">
            <ion-icon name="send"></ion-icon>
          </ion-button>
          
          <!-- Upload/Recording indicators -->
          <div *ngIf="isUploading" class="upload-progress-mobile">
            <ion-spinner name="crescent"></ion-spinner>
            <span>Uploading...</span>
          </div>
          <div *ngIf="isRecording" class="recording-indicator-mobile">
            <ion-icon name="radio-button-on" color="danger"></ion-icon>
            <span>{{ recordingDuration }}s</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>
