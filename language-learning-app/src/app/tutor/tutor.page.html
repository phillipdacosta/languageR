<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button 
        *ngIf="!cameFromModal && !justLoggedIn"
        (click)="goBackToSearch()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
      <ion-button 
        *ngIf="!cameFromModal && justLoggedIn"
        (click)="navigateToHome()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
      <ion-button 
        *ngIf="cameFromModal"
        (click)="handleBackClick($event)">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Tutor Profile</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="page-wrapper" *ngIf="!isLoading && tutor; else loadingTpl">
    
    <!-- Main Content Container -->
    <div class="main-container">
      
      <!-- Left Column - Profile Info & Content -->
      <div class="left-column">
        
        <!-- Profile Header -->
        <div class="profile-header-card">
          <div class="profile-top">
            <div class="avatar-section">
              <div class="avatar-large" *ngIf="!tutor.picture">
                {{ getInitials(tutor.name) }}
              </div>
              <img *ngIf="tutor.picture" [src]="tutor.picture" [alt]="tutor.name" class="avatar-large" referrerpolicy="no-referrer">
              <div class="online-dot"></div>
            </div>
            
            <div class="profile-main-info">
              <h1 class="tutor-name-large">{{ tutor | displayName }}</h1>
              
              <!-- Languages -->
              <div class="languages-list">
                <span *ngFor="let lang of tutor?.languages; let last = last" class="language-item-inline">
                  <app-flag-icon [language]="lang" [size]="16"></app-flag-icon>
                  <span>{{ lang }} tutor</span>
                  <span *ngIf="!last" class="separator">â€¢</span>
                </span>
              </div>
              
              <!-- Quick Stats -->
              <div class="quick-stats">
                <div class="stat-badge" *ngIf="tutor.stats?.rating">
                  <ion-icon name="star"></ion-icon>
                  <span>{{ tutor.stats.rating }}</span>
                  <span class="stat-label">({{ tutor.stats?.totalLessons || 0 }} reviews)</span>
                </div>
                <div class="stat-badge">
                  <ion-icon name="people-outline"></ion-icon>
                  <span>{{ tutor.stats?.students || 0 }}</span>
                  <span class="stat-label">students</span>
                </div>
                <div class="stat-badge">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>{{ tutor.stats?.totalHours || 0 }}</span>
                  <span class="stat-label">lessons</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Video Card (if exists) -->
        <div class="video-section-card" *ngIf="tutor.introductionVideo">
          <div class="section-title">
            <ion-icon name="play-circle-outline"></ion-icon>
            <h2>Introduction Video</h2>
          </div>
          <div class="video-wrapper-compact" (click)="openVideoModal($event)">
            <app-video-thumbnail
              [videoUrl]="tutor.introductionVideo || ''"
              [thumbnailUrl]="tutor.videoThumbnail || ''"
              [videoType]="tutor.videoType || 'upload'"
              cssClass="video-thumbnail">
            </app-video-thumbnail>
          </div>
        </div>

        <!-- About Section -->
        <div class="content-section-card" *ngIf="tutor.bio || tutor.experience">
          <div class="section-title">
            <ion-icon name="person-outline"></ion-icon>
            <h2>About Me</h2>
          </div>
          <div class="section-content">
            <div class="bio-container" *ngIf="tutor.bio">
              <p class="bio-text" [class.expanded]="bioExpanded">{{ tutor.bio }}</p>
              <button 
                *ngIf="shouldShowReadMore(tutor.bio)"
                class="read-more-btn"
                (click)="toggleBio()">
                {{ bioExpanded ? 'Read less' : 'Read more' }}
                <ion-icon [name]="bioExpanded ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
              </button>
            </div>
            <div class="experience-block" *ngIf="tutor.experience">
              <h3>Teaching Experience</h3>
              <p>{{ tutor.experience }}</p>
            </div>
          </div>
        </div>

        <!-- Availability Section -->
        <div class="content-section-card" *ngIf="tutorId">
          <div class="section-title">
            <ion-icon name="calendar-outline"></ion-icon>
            <h2>Weekly Availability</h2>
          </div>
          <div class="section-content">
            <app-tutor-availability-viewer 
              [tutorId]="tutorId" 
              [tutorName]="tutor.name"
              [inline]="true"
              [showDurationSelector]="true"
              [refreshTrigger]="availabilityRefreshTrigger"
              [currentUserAuth0Id]="currentUserAuth0Id"
              [tutorAuth0Id]="tutor?.auth0Id">
            </app-tutor-availability-viewer>
          </div>
        </div>
      </div>

      <!-- Right Column - Sticky Booking Card -->
      <div class="right-column">
        <div class="booking-card-sticky">
          <!-- Pricing Header -->
          <div class="pricing-header">
            <div class="price-display">
              <span class="price-amount">${{ tutor.hourlyRate || 25 }}</span>
              <span class="price-period">/hour</span>
            </div>
            <div class="trial-badge">
              <ion-icon name="star-outline"></ion-icon>
              <span>Trial lesson available</span>
            </div>
          </div>

          <!-- Office Hours Badge (if enabled) -->
          <div class="office-hours-available-badge" *ngIf="tutor?.isActivelyAvailable">
            <ion-icon name="flash"></ion-icon>
            <span>Available Now</span>
          </div>

          <!-- Office Hours Button -->
          <ion-button 
            *ngIf="tutor?.isActivelyAvailable" 
            expand="block" 
            size="large" 
            class="book-btn-office-hours" 
            (click)="bookOfficeHours()">
            <ion-icon name="flash" slot="start"></ion-icon>
            Quick Session (7-30 min)
          </ion-button>

          <!-- Book Button -->
          <ion-button expand="block" size="large" class="book-btn-primary" (click)="bookLesson()">
            <ion-icon name="calendar" slot="start"></ion-icon>
            Book Trial Lesson
          </ion-button>

          <!-- Secondary Actions -->
          <div class="secondary-actions-stack">
            <ion-button expand="block" fill="outline" size="default" (click)="messageTutor()">
              <ion-icon name="chatbubble-outline" slot="start"></ion-icon>
              Send Message
            </ion-button>
            <ion-button expand="block" fill="clear" size="default">
              <ion-icon name="heart-outline" slot="start"></ion-icon>
              Save to my list
            </ion-button>
          </div>

          <!-- Response Time -->
          <div class="response-time">
            <ion-icon name="time-outline"></ion-icon>
            <span>Usually responds in less than an hour</span>
          </div>

          <!-- Stats Summary (Desktop Only) -->
          <div class="stats-summary desktop-only">
            <div class="stat-row">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
              <span>{{ tutor.stats?.totalLessons || 0 }} lessons taught</span>
            </div>
            <div class="stat-row">
              <ion-icon name="people-outline"></ion-icon>
              <span>{{ tutor.stats?.students || 0 }} active students</span>
            </div>
            <div class="stat-row">
              <ion-icon name="star"></ion-icon>
              <span>{{ tutor.stats?.rating || '5.0' }} rating</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Sticky Footer (Mobile Only) -->
    <div class="mobile-booking-footer mobile-only">
      <div class="mobile-price-info">
        <div class="price-large">${{ tutor.hourlyRate || 25 }}<span>/hr</span></div>
        <div class="trial-text">Trial available</div>
      </div>
      <ion-button size="default" class="mobile-book-btn" (click)="bookLesson()">
        <ion-icon name="calendar" slot="start"></ion-icon>
        Book Now
      </ion-button>
    </div>
  </div>

  <!-- Loading Template -->
  <ng-template #loadingTpl>
    <div class="loading">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  </ng-template>

  <!-- Messaging Sidebar -->
  <div class="messaging-sidebar" [class.open]="showMessagingSidebar">
    <div class="sidebar-header">
      <h3>Message {{ tutor?.name }}</h3>
      <ion-button fill="clear" (click)="closeMessaging()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <div class="chat-messages" #chatMessagesContainer>
      <!-- Loading State -->
      <div *ngIf="isLoadingMessages" class="loading-container">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading messages...</p>
      </div>

      <!-- Messages -->
      <div *ngIf="!isLoadingMessages" class="messages-list">
        <div *ngIf="messages.length === 0" class="empty-state">
          <ion-icon name="chatbubbles-outline" class="empty-icon"></ion-icon>
          <p>No messages yet</p>
          <small>Start the conversation!</small>
        </div>

        <div 
          *ngFor="let message of messages" 
          class="message-item"
          [class.my-message]="message.senderId === currentUserId || message.senderId === currentUserId.replace('dev-user-', '') || `dev-user-${message.senderId}` === currentUserId"
          [class.their-message]="!(message.senderId === currentUserId || message.senderId === currentUserId.replace('dev-user-', '') || `dev-user-${message.senderId}` === currentUserId)">
          
          <div class="message-bubble">
            <div class="message-content">{{ message.content }}</div>
            <div class="message-time">{{ formatMessageTime(message.createdAt) }}</div>
          </div>
        </div>

        <!-- Typing Indicator -->
        <div *ngIf="otherUserTyping" class="typing-indicator">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="typing-text">{{ tutor?.name }} is typing...</span>
        </div>
      </div>
    </div>

    <div class="chat-input-container">
      <!-- Reply Banner -->
      <div class="reply-banner" *ngIf="replyingToMessage">
        <div class="reply-content">
          <ion-icon name="return-down-forward-outline" class="reply-icon"></ion-icon>
          <div class="reply-details">
            <span class="replying-to-label">Replying to {{ isMyMessage(replyingToMessage) ? 'yourself' : (selectedConversation?.otherUser?.name || 'Unknown') }}</span>
            <span class="reply-message-preview">{{ replyingToMessage.content }}</span>
          </div>
        </div>
        <ion-button fill="clear" size="small" (click)="cancelReply()">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <!-- File Upload Progress -->
      <div *ngIf="isUploading" class="upload-progress">
        <ion-spinner name="crescent"></ion-spinner>
        <span>Uploading...</span>
      </div>

      <div class="input-row">
        <ion-button fill="clear" class="attachment-btn" (click)="triggerFileInput()">
          <ion-icon name="attach-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <input 
          type="file" 
          #fileInput 
          (change)="onFileSelected($event)" 
          accept="image/*,application/pdf"
          style="display: none;">
        
        <ion-textarea
          [(ngModel)]="newMessage"
          placeholder="Type a message..."
          [autoGrow]="true"
          [rows]="1"
          class="message-input"
          (ionInput)="onTyping()"
          (keydown.enter)="onEnterKey($any($event))">
        </ion-textarea>
        
        <ion-button 
          [disabled]="!newMessage.trim() && !selectedFile || isSending"
          (click)="sendMessage()"
          class="send-btn">
          <ion-spinner *ngIf="isSending" name="crescent"></ion-spinner>
          <ion-icon *ngIf="!isSending" name="send" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div 
    class="sidebar-overlay" 
    [class.visible]="showMessagingSidebar"
    (click)="closeMessaging()">
  </div>
</ion-content>
