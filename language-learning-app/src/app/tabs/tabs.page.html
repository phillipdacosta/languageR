<ion-tabs [class]="getPlatformClass()" [class.show-tabs]="showTabs">

  <!-- Mobile Top Toolbar (Global) -->
  <ion-header class="mobile-global-header" *ngIf="showTabs">
    <ion-toolbar>
      <ion-buttons slot="start">
        <div class="app-icon-container" (click)="navigateTo('/tabs/home')">
          <img src="assets/app-icon.png" alt="Speak Freely" class="app-icon">
        </div>
      </ion-buttons>
      <ion-buttons slot="end">
        <ion-button fill="clear" class="notification-btn" 
                    (click)="navigateTo('/tabs/notifications')"
                    (mouseenter)="onNotificationButtonMouseEnter()"
                    (mouseleave)="onNotificationButtonMouseLeave()">
          <ion-icon name="notifications-outline"></ion-icon>
          <span class="notification-dot" *ngIf="(unreadNotificationCount$ | async)! > 0"></span>
        </ion-button>
        <ion-avatar class="header-avatar" *ngIf="currentUser" (click)="navigateTo('/tabs/profile')">
          <img *ngIf="currentUser.picture" [src]="currentUser.picture" alt="User Avatar" referrerpolicy="no-referrer">
          <div *ngIf="!currentUser.picture" class="avatar-initial">{{ getUserInitial() }}</div>
        </ion-avatar>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>

  <!-- Desktop Web Navigation (Top Toolbar) -->
  <ion-header *ngIf="!showTabs">
    <ion-toolbar class="desktop-nav-toolbar">
      <!-- App Icon -->
      <div class="app-icon-container" slot="start" (click)="navigateTo('/tabs/home')">
        <img src="assets/app-icon.png" alt="Speak Freely" class="app-icon">
      </div>
      
      <div class="desktop-nav-buttons" slot="end">
        <button class="nav-button" [class.active]="isCurrentRoute('/tabs/home')" (click)="navigateTo('/tabs/home')">
          <ion-icon name="home"></ion-icon>
          <ion-label>{{ 'TABS.HOME' | translate }}</ion-label>
          </button>
        
        <button *ngIf="currentUser?.userType === 'student'" class="nav-button" [class.active]="isCurrentRoute('/tabs/tutor-search')" (click)="navigateTo('/tabs/tutor-search')">
          <ion-icon name="search"></ion-icon>
          <ion-label>{{ 'TABS.FIND_TUTORS' | translate }}</ion-label>
        </button>
        
        <button *ngIf="currentUser?.userType === 'tutor'" class="nav-button" [class.active]="isCurrentRoute('/tabs/tutor-calendar')" (click)="navigateTo('/tabs/tutor-calendar')">
          <ion-icon name="calendar"></ion-icon>
          <ion-label>{{ 'TABS.CALENDAR' | translate }}</ion-label>
        </button>
        
        <button class="nav-button messages-button" 
                [class.active]="isCurrentRoute('/tabs/messages')" 
                (click)="onMessagesButtonClick()"
                (mouseenter)="onMessagesButtonMouseEnter()"
                (mouseleave)="onMessagesButtonMouseLeave()"
                #messagesBtn>
          <ion-icon name="chatbubbles"></ion-icon>
          <ion-label>{{ 'TABS.MESSAGES' | translate }}</ion-label>
          <span class="notification-dot message-notification-dot" *ngIf="(unreadCount$ | async)! > 0"></span>
        </button>
        
        <button class="nav-button" [class.active]="isCurrentRoute('/tabs/progress')" (click)="navigateTo('/tabs/progress')">
          <ion-icon [name]="currentUser?.userType === 'tutor' ? 'bar-chart' : 'trending-up'"></ion-icon>
          <ion-label>{{ currentUser?.userType === 'tutor' ? ('TABS.ANALYTICS' | translate) : ('TABS.PROGRESS' | translate) }}</ion-label>
        </button>
        
        <button class="nav-button" [class.active]="isCurrentRoute('/tabs/profile')" (click)="navigateTo('/tabs/profile')">
          <ion-icon name="person"></ion-icon>
          <ion-label>{{ 'TABS.PROFILE' | translate }}</ion-label>
        </button>
        
        <!-- Notification Bell Icon -->
        <div class="notification-container">
          <button type="button" #notificationBtn class="nav-button notification-btn" 
                  (click)="onNotificationButtonClick()"
                  (mouseenter)="onNotificationButtonMouseEnter()"
                  (mouseleave)="onNotificationButtonMouseLeave()">
            <ion-icon name="notifications-outline"></ion-icon>
            <span class="notification-dot" *ngIf="(unreadNotificationCount$ | async)! > 0"></span>
          </button>
        </div>
        
        <!-- User Profile Section (moved beside Profile button) -->
        <div class="user-profile" *ngIf="currentUser">
          <ion-avatar class="user-avatar">
            <img *ngIf="currentUser.picture" [src]="currentUser.picture" [alt]="currentUser.name" referrerpolicy="no-referrer" (error)="onImageError($event)">
            <div class="user-initials" *ngIf="!currentUser.picture">{{ getUserInitials(currentUser) }}</div>
          </ion-avatar>
        </div>
        
        <button class="nav-button logout-button" (click)="logout()">
          <ion-icon name="log-out"></ion-icon>
          <span>{{'TABS.LOGOUT' | translate}}</span>
        </button>
      </div>
    </ion-toolbar>
  </ion-header>

  <!-- Notification Dropdown (Desktop Only) - Outside toolbar for proper positioning -->
  <div class="notification-dropdown" 
       [class.show]="isNotificationDropdownOpen"
       *ngIf="isWeb() && !showTabs" 
       [style.top.px]="dropdownTop"
       [style.right.px]="dropdownRight"
       (mouseenter)="onNotificationDropdownMouseEnter()"
       (mouseleave)="onNotificationDropdownMouseLeave()"
       (click)="$event.stopPropagation()">
    <div class="notification-dropdown-header">
      <div class="notification-header-left">
        <h3 class="notification-title">Notifications</h3>
        <ion-icon name="settings-outline" class="notification-settings-icon"></ion-icon>
      </div>
      <button class="notification-close-btn" (click)="closeNotificationDropdown()">
        <ion-icon name="close"></ion-icon>
      </button>
    </div>
    
    <div class="notification-dropdown-content">
      <!-- Loading State -->
      <div *ngIf="isLoadingNotifications" class="notification-loading">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading notifications...</p>
      </div>

      <ng-container *ngIf="formattedNotifications$ | async as notifications">
        <!-- Important Section (Unread Notifications) -->
        <div class="notification-section" *ngIf="!isLoadingNotifications && (notifications | notificationFilter:'unread').length > 0">
          <h4 class="notification-section-title">Important</h4>
          <div class="notification-item" 
               *ngFor="let notification of (notifications | notificationFilter:'unread'); trackBy: trackByNotificationId"
               [class.unread]="!notification.read"
               (click)="onNotificationClick(notification)">
            <div class="notification-item-left">
              <img 
                *ngIf="notification.relatedUserPicture" 
                [src]="notification.relatedUserPicture" 
                alt="User avatar"
                class="notification-avatar" />
              <div *ngIf="!notification.relatedUserPicture" class="notification-icon-wrapper" [ngClass]="getNotificationIconClass(notification.type)">
                <ion-icon 
                  [name]="getNotificationIcon(notification.type)" 
                  class="notification-item-icon">
                </ion-icon>
              </div>
            </div>
            <div class="notification-item-content">
              <p class="notification-text" [innerHTML]="notification.sanitizedMessage"></p>
              <p class="notification-time">{{ notification.formattedTime }}</p>
            </div>
            <div class="notification-item-right">
              <button class="notification-options-btn" (click)="$event.stopPropagation()">
                <ion-icon name="ellipsis-vertical"></ion-icon>
              </button>
            </div>
          </div>
        </div>
        
        <!-- More Notifications Section (Read Notifications) -->
        <div class="notification-section" *ngIf="!isLoadingNotifications">
          <h4 class="notification-section-title">More notifications</h4>
          <div *ngIf="(notifications | notificationFilter:'read').length > 0">
            <div class="notification-item" 
                 *ngFor="let notification of (notifications | notificationFilter:'read'); trackBy: trackByNotificationId"
                 (click)="onNotificationClick(notification)">
              <div class="notification-item-left">
                <img 
                  *ngIf="notification.relatedUserPicture" 
                  [src]="notification.relatedUserPicture" 
                  alt="User avatar"
                  class="notification-avatar" />
                <div *ngIf="!notification.relatedUserPicture" class="notification-icon-wrapper" [ngClass]="getNotificationIconClass(notification.type)">
                  <ion-icon 
                    [name]="getNotificationIcon(notification.type)"
                    class="notification-item-icon">
                  </ion-icon>
                </div>
              </div>
              <div class="notification-item-content">
                <p class="notification-text" [innerHTML]="notification.sanitizedMessage"></p>
                <p class="notification-time">{{ notification.formattedTime }}</p>
              </div>
              <div class="notification-item-right">
                <button class="notification-options-btn" (click)="$event.stopPropagation()">
                  <ion-icon name="ellipsis-vertical"></ion-icon>
                </button>
              </div>
            </div>
          </div>
          <div class="notification-empty" *ngIf="(notifications | notificationFilter:'read').length === 0 && (notifications | notificationFilter:'unread').length === 0">
            <p>No notifications</p>
          </div>
        </div>
      </ng-container>
      
      <!-- View All Footer -->
      <div class="notification-dropdown-footer" *ngIf="!isLoadingNotifications">
        <button class="view-all-btn" (click)="navigateToNotifications()">
          <span>View All Notifications</span>
          <ion-icon name="arrow-forward"></ion-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Messages Dropdown (Desktop Only) - Similar to notifications -->
  <div class="messages-dropdown" 
       [class.show]="isMessagesDropdownOpen"
       *ngIf="isWeb() && !showTabs" 
       [style.top.px]="messagesDropdownTop"
       [style.right.px]="messagesDropdownRight"
       (mouseenter)="onMessagesDropdownMouseEnter()"
       (mouseleave)="onMessagesDropdownMouseLeave()"
       (click)="$event.stopPropagation()">
    <div class="messages-dropdown-header">
      <div class="messages-header-left">
        <h3 class="messages-title">Messages</h3>
      </div>
      <button class="messages-close-btn" (click)="closeMessagesDropdown()">
        <ion-icon name="close"></ion-icon>
      </button>
    </div>
    
    <div class="messages-dropdown-content">
      <!-- Loading State -->
      <div *ngIf="isLoadingConversations" class="messages-loading">
        <ion-spinner name="crescent"></ion-spinner>
        <p>Loading conversations...</p>
      </div>

      <!-- Conversations List -->
      <div class="messages-section" *ngIf="!isLoadingConversations && conversations.length > 0">
        <div class="conversation-item" 
             *ngFor="let conversation of conversations"
             [class.unread]="conversation.unreadCount > 0"
             (click)="onConversationClick(conversation)">
          <div class="conversation-item-left">
            <ion-avatar class="conversation-avatar">
              <img *ngIf="conversation.otherUser?.picture" 
                   [src]="conversation.otherUser!.picture" 
                   [alt]="conversation.otherUser!.name" />
              <div class="avatar-fallback" *ngIf="!conversation.otherUser?.picture">
                {{ conversation.otherUser?.name?.charAt(0) || '?' }}
              </div>
            </ion-avatar>
          </div>
          <div class="conversation-item-content">
            <div class="conversation-name-row">
              <p class="conversation-name">{{ conversation.otherUser?.name || 'Unknown User' }}</p>
              <p class="conversation-time">{{ formatConversationTime(conversation.updatedAt) }}</p>
            </div>
            <div class="conversation-preview-row">
              <p class="conversation-preview">{{ getConversationPreviewFormatted(conversation) }}</p>
              <ion-badge *ngIf="conversation.unreadCount > 0" color="danger" class="conversation-unread-badge">
                {{ conversation.unreadCount }}
              </ion-badge>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Empty State -->
      <div class="messages-empty" *ngIf="!isLoadingConversations && conversations.length === 0">
        <p>No conversations yet</p>
        <p class="messages-empty-subtitle">Start a conversation to see it here</p>
      </div>
    </div>
  </div>

  <!-- Mobile/Tablet Tabs (Bottom Navigation) -->
  <ion-tab-bar slot="bottom" *ngIf="showTabs && !shouldHideTabs">
    <ion-tab-button tab="home" [routerLink]="['/tabs/home']" routerDirection="root">
      <ion-icon aria-hidden="true" name="home"></ion-icon>
      <ion-label>Home</ion-label>
    </ion-tab-button>

    <ion-tab-button *ngIf="currentUser?.userType === 'student'" tab="tutor-search" [routerLink]="['/tabs/tutor-search']" routerDirection="root">
      <ion-icon aria-hidden="true" name="search"></ion-icon>
      <ion-label>Search</ion-label>
    </ion-tab-button>

    <ion-tab-button *ngIf="currentUser?.userType === 'tutor'"
                    (click)="navigateTo('/tabs/tutor-calendar')"
                    [class.tab-selected]="isCalendarTabSelected"
                    [attr.aria-selected]="isCalendarTabSelected"
                    [attr.aria-label]="'Calendar'">
      <ion-icon aria-hidden="true" name="calendar"></ion-icon>
      <ion-label>Calendar</ion-label>
    </ion-tab-button>

    <ion-tab-button tab="messages" 
                    [routerLink]="['/tabs/messages']" 
                    routerDirection="root" 
                    [class.tab-selected]="isMessagesTabSelected"
                    [attr.aria-selected]="isMessagesTabSelected"
                    [attr.aria-label]="'Messages'"
                    style="position: relative;">
      <ion-icon aria-hidden="true" name="chatbubbles"></ion-icon>
      <ion-label>Messages</ion-label>
      <span *ngIf="(unreadCount$ | async)! > 0" 
            class="notification-dot message-tab-notification-dot"
            style="position: absolute; top: 2px; right: 2px; width: 10px; height: 10px; background-color: #ff3b30; border-radius: 50%; border: 2px solid white; z-index: 9999; display: block;"></span>
    </ion-tab-button>

    <ion-tab-button tab="progress" [routerLink]="['/tabs/progress']" routerDirection="root">
      <ion-icon aria-hidden="true" [name]="currentUser?.userType === 'tutor' ? 'bar-chart' : 'trending-up'"></ion-icon>
      <ion-label>{{ currentUser?.userType === 'tutor' ? ('TABS.ANALYTICS' | translate) : ('TABS.PROGRESS' | translate) }}</ion-label>
    </ion-tab-button>

    <ion-tab-button tab="profile" [routerLink]="['/tabs/profile']" routerDirection="root">
      <ion-icon aria-hidden="true" name="person"></ion-icon>
      <ion-label>Profile</ion-label>
    </ion-tab-button>
  </ion-tab-bar>

  <!-- Tab Content is loaded automatically by ion-tabs -->

  <!-- Platform Debug Info (only in development) -->
  <div class="platform-debug" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 12px; z-index: 9999;">
    Platform: {{ currentPlatform }}<br>
    Screen: {{ platformService.getScreenSize() }}<br>
    Touch: {{ platformService.isTouchDevice() ? 'Yes' : 'No' }}<br>
    Show Tabs: {{ showTabs ? 'Yes' : 'No' }}<br>
    Mobile Viewport: {{ isMobileViewport() ? 'Yes' : 'No' }}<br>
    isWeb(): {{ isWeb() ? 'Yes' : 'No' }}<br>
    Window Width: {{ platformService.getScreenSize() }}
  </div>

</ion-tabs>
