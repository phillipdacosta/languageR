
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" aria-label="Go back">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="pre-call-content">
  <div class="pre-call-container">

    
    <!-- Left Panel: Video Preview and Controls -->
    <div class="preview-panel">
      <div class="preview-header">
        <h3 class="preview-title">Join with mic {{ isMuted ? 'OFF' : 'ON' }} and camera {{ isVideoOff ? 'OFF' : 'ON' }}</h3>
      </div>

      <!-- Video Preview -->
      <div class="video-preview-container" [class.video-off]="isVideoOff">
        <video 
          #videoPreview 
          autoplay 
          playsinline 
          muted
          class="video-preview"
          [class.hidden]="isVideoOff || isLoading || !!errorMessage">
        </video>
        
        <div class="video-placeholder" *ngIf="isVideoOff || isLoading || !!errorMessage">
          <ion-icon name="person" class="placeholder-icon"></ion-icon>
          <p *ngIf="isVideoOff">Camera is off</p>
          <p *ngIf="isLoading && !isVideoOff && !errorMessage">Loading camera...</p>
        </div>
        <div class="error-message" *ngIf="errorMessage">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <p>{{ errorMessage }}</p>
        </div>
      </div>

      <!-- Controls -->
      <div class="preview-controls">
        <a class="test-devices-link" (click)="testDevices()">Test devices</a>
        <div class="control-buttons">
          <button 
            class="control-btn" 
            [class.active]="!isMuted"
            (click)="toggleMicrophone()"
            aria-label="Toggle microphone">
            <ion-icon [name]="isMuted ? 'mic-off-outline' : 'mic-outline'" [class.muted]="isMuted"></ion-icon>
          </button>
          <button 
            class="control-btn" 
            [class.active]="!isVideoOff"
            (click)="toggleCamera()"
            aria-label="Toggle camera">
            <ion-icon [name]="isVideoOff ? 'videocam-off-outline' : 'videocam-outline'" [class.off]="isVideoOff"></ion-icon>
          </button>
          <button 
            class="control-btn" 
            [class.active]="showVirtualBackgroundControls"
            (click)="toggleVirtualBackgroundControls()"
            aria-label="Virtual Background">
            <ion-icon name="color-filter-outline"></ion-icon>
          </button>
          <button 
            class="control-btn" 
            (click)="testDevices()"
            aria-label="Settings">
            <ion-icon name="settings-outline"></ion-icon>
          </button>
        </div>
      </div>

    </div>

    <!-- Virtual Background Controls Panel -->
    <div class="virtual-bg-controls" *ngIf="showVirtualBackgroundControls">
      <div class="controls-header">
        <h3>Virtual Background</h3>
        <ion-button fill="clear" size="small" (click)="toggleVirtualBackgroundControls()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="bg-options">
        <ion-button 
          fill="outline" 
          size="small"
          color="primary"
          (click)="setBackgroundBlur()">
          <ion-icon name="blur" slot="start"></ion-icon>
          Enable Blur
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          color="success"
          (click)="setBackgroundColor('#00ff00')">
          <ion-icon name="square-outline" slot="start"></ion-icon>
          Green Background
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          color="danger"
          (click)="setBackgroundColor('#ff0000')">
          <ion-icon name="square-outline" slot="start"></ion-icon>
          Red Background
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          color="medium"
          (click)="disableVirtualBackground()">
          <ion-icon name="videocam-outline" slot="start"></ion-icon>
          Normal
        </ion-button>
      </div>
      
      <div class="status-info" *ngIf="isVirtualBackgroundEnabled">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
        <span>Virtual background active</span>
      </div>
    </div>

    <!-- Right Panel: Lesson Info -->
    <div class="info-panel">
      <h1 class="lesson-title">{{ lessonTitle || 'Language Lesson' }}</h1>
      <p class="lesson-subtitle" *ngIf="isTutor">
        Enter the classroom to join {{ studentName || 'your student' }}
      </p>
      <p class="lesson-subtitle" *ngIf="!isTutor">
        Enter the classroom to meet your tutor
      </p>
      
      <!-- Presence indicator -->
      <div class="presence-indicator-card" *ngIf="otherParticipantJoined">
        <ion-avatar class="presence-avatar">
          <img [src]="otherParticipantPicture || 'assets/avatar.png'" [alt]="otherParticipantName" />
          <div class="presence-badge">
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
        </ion-avatar>
        <div class="presence-info">
          <p class="presence-text">
            <ion-icon name="person-circle-outline"></ion-icon>
            <span *ngIf="isTutor">{{ otherParticipantName || 'Student' }} has joined lesson</span>
            <span *ngIf="!isTutor">{{ otherParticipantName || 'Tutor' }} has joined lesson</span>
          </p>
        </div>
      </div>
      
      <ion-button 
        class="enter-button" 
        expand="block" 
        (click)="enterClassroom()"
        [disabled]="isLoading || !!errorMessage">
        Enter classroom
      </ion-button>
    </div>
  </div>
</ion-content>

