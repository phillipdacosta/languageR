
<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" aria-label="Go back">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="pre-call-content">
  <div class="pre-call-container">

    
    <!-- Left Panel: Video Preview and Controls -->
    <div class="preview-panel">
      <div class="preview-header">
        <h3 class="preview-title">Join with mic {{ isMuted ? 'OFF' : 'ON' }} and camera {{ isVideoOff ? 'OFF' : 'ON' }}</h3>
      </div>

      <!-- Video Preview -->
      <div class="video-preview-container" [class.video-off]="isVideoOff">
        <video 
          #videoPreview 
          autoplay 
          playsinline 
          muted
          class="video-preview"
          [class.hidden]="isVideoOff || isLoading || !!errorMessage">
        </video>
        
        <div class="video-placeholder" *ngIf="isVideoOff || isLoading || !!errorMessage">
          <ion-icon name="person" class="placeholder-icon"></ion-icon>
          <p *ngIf="isVideoOff">Camera is off</p>
          <p *ngIf="isLoading && !isVideoOff && !errorMessage">Loading camera...</p>
        </div>
        <div class="error-message" *ngIf="errorMessage">
          <ion-icon name="alert-circle-outline"></ion-icon>
          <p>{{ errorMessage }}</p>
          <ion-button 
            *ngIf="showRetryButton" 
            fill="outline" 
            size="small" 
            (click)="retrySetup()"
            class="retry-button">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Try Again
          </ion-button>
        </div>
      </div>

      <!-- Controls -->
      <div class="preview-controls">
        <a class="test-devices-link" (click)="testDevices()">Test devices</a>
        <div class="control-buttons">
          <button 
            class="control-btn" 
            [class.active]="!isMuted"
            (click)="toggleMicrophone()"
            aria-label="Toggle microphone">
            <ion-icon [name]="isMuted ? 'mic-off-outline' : 'mic-outline'" [class.muted]="isMuted"></ion-icon>
          </button>
          <button 
            class="control-btn" 
            [class.active]="!isVideoOff"
            (click)="toggleCamera()"
            aria-label="Toggle camera">
            <ion-icon [name]="isVideoOff ? 'videocam-off-outline' : 'videocam-outline'" [class.off]="isVideoOff"></ion-icon>
          </button>
          <button 
            class="control-btn" 
            [class.active]="showVirtualBackgroundControls"
            (click)="toggleVirtualBackgroundControls()"
            aria-label="Virtual Background">
            <ion-icon name="color-filter-outline"></ion-icon>
          </button>
          <button 
            class="control-btn" 
            (click)="testDevices()"
            aria-label="Settings">
            <ion-icon name="settings-outline"></ion-icon>
          </button>
        </div>
        
        <!-- Audio Level Indicator -->
        <div class="audio-level-container">
          <ion-icon [name]="isMuted ? 'mic-off-outline' : 'mic-outline'" 
                    [class.muted]="isMuted"
                    class="mic-icon"></ion-icon>
          <div class="audio-level-bar">
            <div class="audio-level-fill" 
                 [style.width.%]="isMuted ? 0 : audioLevel"
                 [class.muted]="isMuted"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- Virtual Background Controls Panel -->
    <div class="virtual-bg-controls" *ngIf="showVirtualBackgroundControls">
      <div class="controls-header">
        <h3>Virtual Background</h3>
        <ion-button fill="clear" size="small" (click)="toggleVirtualBackgroundControls()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="bg-options">
        <button 
          class="bg-option-btn blur-option"
          (click)="setBackgroundBlur()">
          <ion-icon name="blur"></ion-icon>
          <span>Enable Blur</span>
        </button>
        
        <button 
          class="bg-option-btn black-option"
          (click)="setBackgroundColor('#000000')">
          <div class="color-preview black"></div>
          <span>Black Background</span>
        </button>
        
        <button 
          class="bg-option-btn normal-option"
          (click)="disableVirtualBackground()">
          <ion-icon name="videocam-outline"></ion-icon>
          <span>Normal</span>
        </button>
      </div>
      
      <div class="status-info" *ngIf="isVirtualBackgroundEnabled">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
        <span>Virtual background active</span>
      </div>
    </div>

    <!-- Right Panel: Lesson Info -->
    <div class="info-panel">
      <div class="lesson-header">
        <h1 class="lesson-title">{{ lessonTitle || 'Language Lesson' }}</h1>
        <div class="trial-badge" *ngIf="isTrialLesson">
          <ion-icon name="star"></ion-icon>
          <span>Trial Lesson</span>
        </div>
      </div>
      <p class="lesson-subtitle" *ngIf="isTutor && !isTrialLesson">
        Enter the classroom to join {{ studentName || 'your student' }}
      </p>
      <p class="lesson-subtitle" *ngIf="isTutor && isTrialLesson">
        This is a trial lesson with {{ studentName || 'your student' }}
      </p>
      <p class="lesson-subtitle" *ngIf="!isTutor && !isTrialLesson">
        Enter the classroom to meet your tutor
      </p>
      <p class="lesson-subtitle" *ngIf="!isTutor && isTrialLesson">
        This is your trial lesson with {{ tutorName || 'your tutor' }}
      </p>
      
      <!-- Presence indicator -->
      <div class="presence-indicator-card" *ngIf="otherParticipantJoined">
        <ion-avatar class="presence-avatar">
          <img [src]="otherParticipantPicture || 'assets/avatar.png'" [alt]="otherParticipantName" />
          <div class="presence-badge">
            <ion-icon name="checkmark-circle"></ion-icon>
          </div>
        </ion-avatar>
        <div class="presence-info">
          <p class="presence-text">
            <ion-icon name="person-circle-outline"></ion-icon>
            <span *ngIf="isTutor">{{ otherParticipantName || 'Student' }} has joined lesson</span>
            <span *ngIf="!isTutor">{{ otherParticipantName || 'Tutor' }} has joined lesson</span>
          </p>
        </div>
      </div>
      
      <!-- Previous Lesson Notes (for tutors) -->
      <div class="previous-notes-card" *ngIf="isTutor && (previousLessonNotes || loadingPreviousNotes)">
        <div class="notes-header">
          <ion-icon name="document-text-outline"></ion-icon>
          <h3>Last Lesson Notes</h3>
        </div>
        
        <div *ngIf="loadingPreviousNotes" class="loading-notes">
          <ion-spinner name="crescent" color="primary"></ion-spinner>
          <span>Loading previous lesson...</span>
        </div>
        
        <div *ngIf="previousLessonNotes && !loadingPreviousNotes" class="notes-content">
          <div class="notes-date">
            <ion-icon name="calendar-outline"></ion-icon>
            {{ previousLessonNotes.lessonDate | date:'MMM d, y' }}
          </div>
          
          <div class="notes-summary">
            <p class="summary-text">{{ previousLessonNotes.studentSummary }}</p>
          </div>
          
          <div class="notes-focus" *ngIf="previousLessonNotes.recommendedFocus?.length">
            <h4>
              <ion-icon name="flag-outline"></ion-icon>
              Focus Areas
            </h4>
            <ul>
              <li *ngFor="let focus of previousLessonNotes.recommendedFocus.slice(0, 3)">
                {{ focus }}
              </li>
            </ul>
          </div>
          
          <div class="notes-improvements" *ngIf="previousLessonNotes.areasForImprovement?.length">
            <h4>
              <ion-icon name="trending-up-outline"></ion-icon>
              Work On
            </h4>
            <ul>
              <li *ngFor="let area of previousLessonNotes.areasForImprovement.slice(0, 2)">
                {{ area }}
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Student Entry Countdown (after tutor accepts) -->
      <div class="entry-countdown" *ngIf="showStudentEntryCountdown && tutorHasAccepted">
        <div class="countdown-content">
          <ion-icon name="time-outline" [class.urgent]="studentEntryCountdown <= 10"></ion-icon>
          <div class="countdown-text">
            <p class="countdown-message">Please enter the classroom soon!</p>
            <p class="countdown-timer" [class.urgent]="studentEntryCountdown <= 10">
              {{ studentEntryCountdown }}s remaining
            </p>
          </div>
        </div>
      </div>
      
      <ion-button 
        class="enter-button" 
        expand="block" 
        (click)="enterClassroom()"
        [disabled]="isLoading || !!errorMessage || isOfficeHoursWaitingRoom || waitingForTutorAcceptance">
        <span *ngIf="!isOfficeHoursWaitingRoom && !waitingForTutorAcceptance">Enter classroom</span>
        <span *ngIf="isOfficeHoursWaitingRoom">Waiting for student...</span>
        <span *ngIf="waitingForTutorAcceptance">
          <ion-spinner name="dots"></ion-spinner>
          Waiting for tutor to accept...
        </span>
      </ion-button>
      
      <!-- Show message when tutor accepts (stays visible even after tutor joins) -->
      <div class="tutor-ready-message" *ngIf="tutorHasAccepted">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
        <p>Tutor is ready! You can enter when ready.</p>
      </div>
    </div>
  </div>
</ion-content>

<!-- Office Hours Request Modal (Full Screen, Unavoidable) -->
<div class="office-hours-request-overlay" *ngIf="showOfficeHoursRequestModal && isOfficeHoursWaitingRoom">
  <div class="office-hours-request-modal">
    <div class="modal-icon">
      <ion-icon name="flash"></ion-icon>
    </div>
    <h2>⚡ A Student Wants to Join!</h2>
    <p class="student-info">{{ pendingOfficeHoursRequest?.data?.studentName || 'A student' }} is requesting an office hours session</p>
    <p class="duration-info">Duration: {{ pendingOfficeHoursRequest?.data?.duration || 15 }} minutes</p>
    <p class="warning-text">⏰ {{ requestTimeRemaining }} seconds remaining</p>
    
    <div class="button-group">
      <ion-button 
        expand="block" 
        size="large" 
        color="success" 
        class="accept-button"
        (click)="acceptOfficeHoursRequest()">
        <ion-icon name="checkmark-circle" slot="start"></ion-icon>
        Accept
      </ion-button>
      
      <ion-button 
        expand="block" 
        size="large" 
        fill="outline" 
        color="danger" 
        class="decline-button"
        (click)="declineOfficeHoursRequest()">
        <ion-icon name="close-circle" slot="start"></ion-icon>
        Decline
      </ion-button>
    </div>
  </div>
</div>

