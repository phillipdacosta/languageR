<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-title>{{ isViewingOtherUser ? (getDisplayUser()?.name || ('PROFILE_SCREEN.PROFILE' | translate)) : ('PROFILE_SCREEN.PROFILE' | translate) }}</ion-title>
    <ion-buttons slot="start" *ngIf="isViewingOtherUser">
      <ion-back-button defaultHref="/tabs"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header> 

<ion-content [fullscreen]="true" class="profile-content">
      <div class="profile-container" *ngIf="getDisplayUser()">
        <!-- User Profile Card -->
        <ion-card class="profile-card">
          <ion-card-content>
            <div class="profile-header">
              <div class="avatar-container" (click)="!isViewingOtherUser && !getDisplayUser()?.picture && triggerPictureUpload()" [class.clickable]="!isViewingOtherUser && !getDisplayUser()?.picture">
                <ion-avatar class="profile-avatar">
                  <img [src]="getDisplayUser()?.picture" [alt]="getDisplayUser()?.name" referrerpolicy="no-referrer" *ngIf="getDisplayUser()?.picture">
                  <div class="profile-initials" *ngIf="!getDisplayUser()?.picture">{{ getUserInitials(getDisplayUser()) }}</div>
                </ion-avatar>
                <div class="avatar-overlay" *ngIf="!isViewingOtherUser && !getDisplayUser()?.picture">
                  <ion-icon name="camera"></ion-icon>
                  <span> {{ 'PROFILE_SCREEN.CHANGE_PICTURE' | translate }}</span>
                </div>
              </div>
              <!-- Hidden file input for picture upload (always present for own profile) -->
              <input 
                type="file" 
                id="profile-picture-input" 
                accept="image/*" 
                style="display: none;"
                (change)="onPictureSelected($event)"
                *ngIf="!isViewingOtherUser">
              <div class="profile-info">
                <h2 class="profile-name">{{ getDisplayUser()?.name }}</h2>
                <p class="profile-email" *ngIf="!isViewingOtherUser">{{ getDisplayUser()?.email }}</p>
                <p class="profile-email" *ngIf="isViewingOtherUser && isTutor()">{{ getDisplayUser()?.email }}</p>
                
                <!-- Picture actions when picture exists -->
                <div class="picture-actions-inline" *ngIf="!isViewingOtherUser && hasCustomPicture()">
                  <ion-button fill="outline" size="small" (click)="triggerPictureUpload()">
                    <ion-icon slot="start" name="camera"></ion-icon>
                    Change Photo
                  </ion-button>
                  <ion-button fill="outline" size="small" color="danger" (click)="removePicture()">
                    <ion-icon slot="start" name="trash"></ion-icon>
                    Remove
                  </ion-button>
                </div>
                
                <!-- Add photo button when no custom picture -->
                <div class="picture-actions-inline" *ngIf="!isViewingOtherUser && !hasCustomPicture()">
                  <ion-button fill="outline" size="small" (click)="triggerPictureUpload()">
                    <ion-icon slot="start" name="camera"></ion-icon>
                    Add Photo
                  </ion-button>
                </div>
                
                <!-- Languages Section -->
                <div class="languages-section" *ngIf="isTutor() && getDisplayUser()?.languages?.length">
                  <ion-icon name="language-outline"></ion-icon>
                  <div class="languages-list">
                    <span *ngFor="let lang of getDisplayUser()?.languages; let last = last" class="language-item">
                      <span>{{ lang }}</span>
                      <app-flag-icon [language]="lang" [size]="16" cssClass="language-flag" style="margin-left: 4px;"></app-flag-icon>
                      <span *ngIf="!last">, </span>
                    </span>
                  </div>
                </div>
                
                <div class="languages-section" *ngIf="isStudent() && getDisplayUser()?.languagesLearning?.length">
                  <ion-icon name="school-outline"></ion-icon>
                  <div class="languages-list">
                    <span>Learning: </span>
                    <span *ngFor="let lang of getDisplayUser()?.languagesLearning; let last = last" class="language-item">
                      <span>{{ lang }}</span>
                      <app-flag-icon [language]="lang" [size]="16" cssClass="language-flag" style="margin-left: 4px;"></app-flag-icon>
                      <span *ngIf="!last">, </span>
                    </span>
                  </div>
                </div>
                
                <ion-chip *ngIf="!isViewingOtherUser && getDisplayUser()?.emailVerified" color="success">
                  <ion-icon name="checkmark-circle"></ion-icon>
                  <ion-label>{{'PROFILE_SCREEN.VERIFIED' | translate}}</ion-label>
                </ion-chip>
                <ion-chip *ngIf="!isViewingOtherUser && !getDisplayUser()?.emailVerified" color="warning">
                  <ion-icon name="warning"></ion-icon>
                  <ion-label>{{'PROFILE_SCREEN.UNVERIFIED' | translate}}</ion-label>
                </ion-chip>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

    <!-- Stripe Connect Setup Card (Tutors Only) -->
    
    <!-- Warning Banner for Non-Onboarded Tutors -->
    <ion-card class="warning-banner" *ngIf="!isViewingOtherUser && isTutor() && !stripeConnectOnboarded" color="warning">
      <ion-card-content>
        <div class="warning-content">
          <ion-icon name="warning" color="warning"></ion-icon>
          <div class="warning-text">
            <h3>‚ö†Ô∏è Payment Setup Required</h3>
            <p><strong>Your profile is hidden from students</strong> until you connect your bank account. Complete the setup below to start accepting bookings.</p>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
    
    <ion-card class="stripe-connect-card" *ngIf="!isViewingOtherUser && isTutor()">
      <ion-card-content [class.stripe-connected]="stripeConnectOnboarded">
        <!-- Not Connected State -->
        <div class="stripe-connect-content" *ngIf="!stripeConnectOnboarded">
          <div class="stripe-icon">
            <ion-icon name="wallet-outline"></ion-icon>
          </div>
          <div class="stripe-text">
            <h3>üí∞ Connect Bank Account</h3>
            <p>Set up payouts to receive earnings from your lessons via Stripe.</p>
          </div>
          <ion-button 
            expand="block" 
            color="primary" 
            (click)="startStripeConnectOnboarding()"
            [disabled]="isLoadingStripeConnect">
            <ion-spinner *ngIf="isLoadingStripeConnect" name="crescent" slot="start"></ion-spinner>
            {{ isLoadingStripeConnect ? 'Loading...' : 'Set Up Payouts' }}
          </ion-button>
        </div>
        
        <!-- Connected State -->
        <div class="stripe-connect-success" *ngIf="stripeConnectOnboarded">
          <div class="success-header">
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
            <div class="stripe-success-text">
              <h4>‚úì Payouts Enabled</h4>
              <p>Earnings will be automatically transferred to your bank account</p>
            </div>
          </div>
          <ion-button 
            expand="block" 
            fill="outline"
            color="primary" 
            (click)="editStripeConnectAccount()"
            [disabled]="isLoadingStripeConnect">
            <ion-icon name="create-outline" slot="start"></ion-icon>
            {{ isLoadingStripeConnect ? 'Loading...' : 'Edit Payout Settings' }}
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- User Stats - Only show for own profile -->
    <ion-card class="stats-card" *ngIf="!isViewingOtherUser">
      <ion-card-header>
        <ion-card-title>{{ isTutor() ? ('PROFILE_SCREEN.TEACHING_STATS' | translate) : ('PROFILE_SCREEN.LEARNING_PROGRESS' | translate)   }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="stats-grid">
          <div class="stat-item">
            <ion-icon name="book" color="primary"></ion-icon>
            <div class="stat-info">
              <span class="stat-number">{{ getDisplayUser()?.stats?.totalLessons || 0 }}</span>
              <span class="stat-label">{{ isTutor() ? ('PROFILE_SCREEN.LESSONS_TAUGHT' | translate) : ('PROFILE_SCREEN.LESSONS_COMPLETED' | translate) }}</span>
            </div>
          </div>
          <div class="stat-item">
            <ion-icon name="time" color="secondary"></ion-icon>
            <div class="stat-info">
              <span class="stat-number">{{ getDisplayUser()?.stats?.totalHours || 0 }}h</span>
              <span class="stat-label">{{ isTutor() ? ('PROFILE_SCREEN.HOURS_TAUGHT' | translate) : ('PROFILE_SCREEN.TOTAL_STUDY_TIME' | translate)  }}</span>
            </div>
          </div>
          <div class="stat-item" *ngIf="isTutor()">
            <ion-icon name="star" color="warning"></ion-icon>
            <div class="stat-info">
              <span class="stat-number">{{ getDisplayUser()?.stats?.rating || '5.0' }}</span>
              <span class="stat-label">{{'PROFILE_SCREEN.RATING' | translate}}</span>
            </div>
          </div>
          <div class="stat-item" *ngIf="isStudent()">
            <ion-icon name="trophy" color="warning"></ion-icon>
            <div class="stat-info">
              <span class="stat-number">{{ getDisplayUser()?.stats?.streak || 0 }}</span>
              <span class="stat-label">{{'PROFILE_SCREEN.DAY_STREAK' | translate}}</span>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Tutor-specific sections (only for tutors) -->
    <ng-container *ngIf="isTutor()">
      <!-- Tutor Video Section - Only show for own profile -->
      <ion-card class="tutor-video-card" *ngIf="!isViewingOtherUser">
        <ion-card-header>
          <ion-card-title>{{'PROFILE_SCREEN.INTRO_VIDEO' | translate}}</ion-card-title>
          <ion-card-subtitle>{{'PROFILE_SCREEN.INTRO_VIDEO_SUBTITLE' | translate}}</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="video-section">
            <p class="video-description">
              {{'PROFILE_SCREEN.INTRO_VIDEO_DESC' | translate}}
            </p>
            
            <app-video-upload
              [videoUrl]="tutorIntroductionVideo"
              [thumbnailUrl]="tutorVideoThumbnail"
              [videoType]="tutorVideoType"
              [enableModalPlayer]="true"
              (thumbnailClick)="openVideoPlayerModal()"
              (videoUploaded)="onVideoUploaded($event)"
              (videoRemoved)="onVideoRemoved()">
            </app-video-upload>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- About Section -->
      <ion-card class="content-card" *ngIf="getDisplayUser()?.bio">
        <ion-card-header>
          <ion-card-title>{{'PROFILE_SCREEN.ABOUT_ME' | translate}}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ getDisplayUser()?.bio }}</p>
        </ion-card-content>
      </ion-card>

      <!-- Experience Section -->
      <ion-card class="content-card" *ngIf="getDisplayUser()?.experience">
        <ion-card-header>
          <ion-card-title>{{ 'PROFILE_SCREEN.EXPERIENCE' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ getDisplayUser()?.experience }}</p>
        </ion-card-content>
      </ion-card>

      <!-- Schedule Section -->
      <ion-card class="content-card" *ngIf="getDisplayUser()?.schedule">
        <ion-card-header>
          <ion-card-title>{{ 'PROFILE_SCREEN.SCHEDULE' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ getDisplayUser()?.schedule }}</p>
        </ion-card-content>
      </ion-card>
    </ng-container>

    <!-- Student-specific sections -->
    <ng-container *ngIf="isStudent()">
      <!-- About Section -->
      <ion-card class="content-card" *ngIf="getDisplayUser()?.bio">
        <ion-card-header>
          <ion-card-title>{{ 'PROFILE_SCREEN.ABOUT_ME' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ getDisplayUser()?.bio }}</p>
        </ion-card-content>
      </ion-card>

      <!-- Experience Level -->
      <ion-card class="content-card" *ngIf="getDisplayUser()?.experienceLevel">
        <ion-card-header>
          <ion-card-title>{{ 'PROFILE_SCREEN.EXPERIENCE_LEVEL' | translate }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-chip color="primary">
            <ion-label>{{ getDisplayUser()?.experienceLevel }}</ion-label>
          </ion-chip>
        </ion-card-content>
      </ion-card>
    </ng-container>

    <!-- Settings - Only show for own profile -->
    <ion-card class="settings-card" *ngIf="!isViewingOtherUser">
      <ion-card-header>
        <ion-card-title>{{ 'PROFILE_SCREEN.SETTINGS' | translate }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ion-list>
          <ion-item button routerLink="/review-deck" *ngIf="isStudent()">
            <ion-icon name="bookmark" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>{{ 'PROFILE_SCREEN.REVIEW_DECK' | translate }}</h3>
              <p>{{ 'PROFILE_SCREEN.REVIEW_DECK_DESC' | translate }}  </p>
            </ion-label>
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-item>
          <ion-item button>
            <ion-icon name="notifications" slot="start"></ion-icon>
            <ion-label>{{ 'PROFILE_SCREEN.NOTIFICATIONS' | translate }}</ion-label>
            <ion-toggle slot="end" checked></ion-toggle>
          </ion-item>
          <ion-item button (click)="openTimezoneSelector()" class="timezone-item" lines="none">
            <div class="timezone-content">
              <div class="timezone-icon-wrapper">
                <ion-icon name="globe-outline"></ion-icon>
              </div>
              <div class="timezone-info">
                <h3>{{ 'PROFILE_SCREEN.TIMEZONE' | translate }}</h3>
                <p class="timezone-value">{{ getTimezoneLabel() }}</p>
              </div>
              <ion-icon name="chevron-forward" class="chevron-icon"></ion-icon>
            </div>
          </ion-item>
          <ion-item>
            <ion-icon name="language" slot="start"></ion-icon>
            <ion-label>{{ 'PROFILE_SCREEN.INTERFACE_LANGUAGE' | translate }}</ion-label>
            <ion-select 
              [(ngModel)]="selectedInterfaceLanguage" 
              (ionChange)="onInterfaceLanguageChange($event)" 
              interface="action-sheet"
              slot="end">
              <ion-select-option *ngFor="let lang of availableLanguages" [value]="lang.code">
                {{ lang.flag }} {{ lang.nativeName | translate }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <ion-item button>
            <ion-icon name="moon" slot="start"></ion-icon>
            <ion-label>{{ 'PROFILE_SCREEN.DARK_MODE' | translate }}</ion-label>
            <ion-toggle slot="end" [checked]="isDarkMode$ | async" (ionChange)="toggleDarkMode($event)"></ion-toggle>
          </ion-item>
          <ion-item button>
            <ion-icon name="notifications" slot="start"></ion-icon>
            <ion-label>Lesson Reminders</ion-label>
            <ion-toggle slot="end" [checked]="remindersEnabled" (ionChange)="toggleReminders($event)"></ion-toggle>
          </ion-item>
          <ion-item button *ngIf="isTutor()">
            <ion-icon name="wallet" slot="start"></ion-icon>
            <ion-label>Show Wallet Balance</ion-label>
            <ion-toggle slot="end" [checked]="showWalletBalance" (ionChange)="toggleShowWalletBalance($event)"></ion-toggle>
          </ion-item>
          <!-- 
          TEMPORARILY DISABLED: AI Analysis Toggle
          TODO: Re-enable if we want to allow users to disable AI analysis
          
          <ion-item button *ngIf="isStudent()">
            <ion-icon name="analytics" slot="start"></ion-icon>
            <ion-label>
              <h3>AI Analysis</h3>
              <p>Get detailed feedback from AI after lessons. When disabled, your tutor will provide all feedback.</p>
            </ion-label>
            <ion-toggle slot="end" [checked]="aiAnalysisEnabled" (ionChange)="toggleAIAnalysis($event)"></ion-toggle>
          </ion-item>
          -->
          <ion-item button>
            <ion-icon name="help-circle" slot="start"></ion-icon>
            <ion-label>{{ 'PROFILE_SCREEN.HELP_SUPPORT' | translate }}</ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Logout Button - Only show for own profile -->
    <ion-button 
      expand="block" 
      fill="solid" 
      color="danger" 
      (click)="logout()"
      class="logout-button"
      *ngIf="!isViewingOtherUser">
      <ion-icon name="log-out" slot="start"></ion-icon>
      {{ 'PROFILE_SCREEN.SIGN_OUT' | translate }}
    </ion-button>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="!getDisplayUser()">
    <ion-spinner name="crescent"></ion-spinner>
    <p>{{ 'PROFILE_SCREEN.LOADING_PROFILE' | translate }}</p>
  </div>

  <!-- Video Player Modal -->
  <ion-modal 
    [isOpen]="isVideoPlayerModalOpen" 
    (didDismiss)="onVideoPlayerModalDismiss()"
    cssClass="video-player-modal">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Introduction Video</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="isVideoPlayerModalOpen = false">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="video-player-content">
        <div class="video-player-container" *ngIf="videoPlayerData">
          <!-- YouTube Video -->
          <iframe 
            *ngIf="videoPlayerData.videoType === 'youtube'"
            [src]="videoPlayerData.safeVideoUrl"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            class="video-iframe">
          </iframe>
          
          <!-- Vimeo Video -->
          <iframe 
            *ngIf="videoPlayerData.videoType === 'vimeo'"
            [src]="videoPlayerData.safeVideoUrl"
            frameborder="0"
            allow="autoplay; fullscreen; picture-in-picture"
            allowfullscreen
            class="video-iframe">
          </iframe>
          
          <!-- Uploaded Video -->
          <video 
            *ngIf="videoPlayerData.videoType === 'upload'"
            [src]="videoPlayerData.videoUrl"
            controls
            autoplay
            class="video-player">
          </video>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
