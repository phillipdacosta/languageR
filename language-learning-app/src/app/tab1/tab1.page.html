<!-- home.page.html -->
<ion-content>
  <div class="content-wrapper">
    
    <!-- ðŸŽ¨ DEV: Preview Lesson Summary Button -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;" *ngIf="currentUser?.userType === 'student'">
      <ion-button color="secondary" (click)="previewLessonSummaryModal()" size="small" style="--box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
        <ion-icon name="eye" slot="start"></ion-icon>
        {{ 'HOME.PREVIEW_SUMMARY' | translate }}
      </ion-button>
    </div>
    
    <!-- Student Search Bar -->
    <div class="search-container" *ngIf="currentUser?.userType === 'student'" (click)="openSearchTutors()">
      <ion-icon name="search-outline" class="search-icon"></ion-icon>
      <input type="text" [placeholder]="'HOME.SEARCH_PLACEHOLDER' | translate" readonly class="search-input">
    </div>

    <!-- Pending Class Invitations for Students -->
    <div class="invitations-section" *ngIf="currentUser?.userType === 'student' && !isLoadingInvitations && pendingClassInvitations.length > 0">
      <div class="section-header-new">
        <h2>{{ 'HOME.CLASS_INVITATIONS' | translate }}</h2>
        <span class="invitation-count">{{ pendingClassInvitations.length }}</span>
      </div>
      
      <div class="invitations-list">
        <div 
          class="invitation-card" 
          [class.cancelled]="invitation?.status === 'cancelled'"
          *ngFor="let invitation of pendingClassInvitations"
          (click)="openClassInvitation(invitation._id)">
          <div class="invitation-badge" [class.cancelled-badge]="invitation?.status === 'cancelled'">
            <ion-icon [name]="invitation?.status === 'cancelled' ? 'close-circle-outline' : 'mail-outline'"></ion-icon>
            <span>{{ invitation?.status === 'cancelled' ? 'CANCELLED' : 'INVITED' }}</span>
          </div>
          
          <div class="invitation-content">
            <div class="invitation-header">
              <ion-icon name="people" class="class-icon"></ion-icon>
              <div class="invitation-info">
                <h3 class="class-name" [class.cancelled-text]="invitation?.status === 'cancelled'">{{ invitation?.name || 'Group Class' }}</h3>
                <p class="tutor-name" *ngIf="invitation?.tutorId?.name">with {{ invitation.tutorId.name }}</p>
                <p class="tutor-name" *ngIf="!invitation?.tutorId?.name">Group Class Invitation</p>
                <p class="cancel-reason" *ngIf="invitation?.status === 'cancelled' && invitation?.cancelReason === 'minimum_not_met'">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  Cancelled due to insufficient enrollment
                </p>
              </div>
            </div>
            
            <div class="invitation-details">
              <div class="detail-item">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>{{ formatClassDate(invitation?.startTime) }}</span>
              </div>
              <div class="detail-item">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ formatClassTime(invitation?.startTime) }}</span>
              </div>
            </div>
            
            <div class="invitation-actions">
              <ion-button fill="outline" size="small" (click)="openClassInvitation(invitation._id); $event.stopPropagation()">
                View Details
              </ion-button>
            </div>
          </div>
          
          <ion-icon name="chevron-forward-outline" class="chevron"></ion-icon>
        </div>
      </div>
    </div>

    <!-- Explore Public Classes Card (Students only) -->
    <div class="explore-section" *ngIf="currentUser?.userType === 'student'">
      <ion-card class="explore-card" [routerLink]="['/tabs/home/explore']">
        <div class="explore-card-content">
          <div class="explore-icon">
            <ion-icon name="compass"></ion-icon>
          </div>
          <div class="explore-info">
            <h3>Explore Public Classes</h3>
            <p>Discover and join group classes from tutors</p>
          </div>
          <ion-icon name="chevron-forward" class="chevron-icon"></ion-icon>
        </div>
      </ion-card>
    </div>
    <div class="section-header-new">
      <h2>Dashboard</h2>
    </div>
    <!-- Tutor Insights Panel -->
    <div class="insights-panel" *ngIf="isTutor()">
      <div class="insight-metric">
        <div class="insight-icon students">
          <ion-icon name="people"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ totalStudents || 0 }}</div>
          <div class="insight-label">Students</div>
        </div>
      </div>
      <div class="insight-divider"></div>
      <div class="insight-metric">
        <div class="insight-icon lessons">
          <ion-icon name="videocam"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ lessonsThisWeek || 0 }}</div>
          <div class="insight-label">This Week</div>
        </div>
      </div>
      <div class="insight-divider"></div>
      <div class="insight-metric">
        <div class="insight-icon rating">
          <ion-icon name="star"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ tutorRating || '4.8' }}</div>
          <div class="insight-label">Rating</div>
        </div>
      </div>
      
      <div class="insight-divider"></div>
      <div class="insight-metric" (click)="router.navigate(['/wallet'])" style="cursor: pointer;">
        <div class="insight-icon messages">
          <ion-icon name="wallet-outline"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value wallet-value" 
               [class.wallet-hidden]="!showWalletBalance && !walletTemporarilyVisible"
               (click)="toggleWalletVisibility($event)">
            <span class="wallet-amount" *ngIf="!showWalletBalance && !walletTemporarilyVisible">$<span class="wallet-dots">â€¢â€¢â€¢â€¢</span></span>
            <span class="wallet-amount" *ngIf="showWalletBalance || walletTemporarilyVisible">${{ walletBalance.toFixed(2) }}</span>
            <span class="wallet-amount-hover" *ngIf="!showWalletBalance && !walletTemporarilyVisible">${{ walletBalance.toFixed(2) }}</span>
          </div>
          <div class="insight-label">Wallet</div>
        </div>
      </div>
    </div>
    <!-- Upcoming Schedule Section -->
    <!-- Header Loading Skeleton -->
    <div class="section-header-skeleton" *ngIf="isLoadingLessons">
      <div class="skeleton-line skeleton-header"></div>
      <div class="skeleton-line skeleton-button-small"></div>
    </div>
    
    <div class="section-header-new" *ngIf="!isLoadingLessons">
      <div class="header-with-tabs">
        <div class="header-title-row">
          <h2>{{'HOME.UPCOMING_LESSONS' | translate}}</h2>
          <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
        </div>
        
        <!-- Tab Toggle for Upcoming/Cancelled -->
        <div class="lesson-view-tabs" *ngIf="hasCancelledLessons()">
          <button 
            class="tab-button" 
            [class.active]="lessonView === 'upcoming'"
            (click)="switchLessonView('upcoming')">
            Upcoming
          </button>
          <button 
            class="tab-button" 
            [class.active]="lessonView === 'cancelled'"
            (click)="switchLessonView('cancelled')">
            Cancelled
          </button>
        </div>
      </div>
    </div>

    <!-- <div class="week-navigation" *ngIf="isTutor()">
      <ion-button fill="clear" size="small" (click)="navigateWeek('prev')">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>
      <div class="week-display">
        <span class="week-range">{{ weekRangeLabel }}</span>
        <ion-button fill="clear" size="small" (click)="goToToday()" [disabled]="isCurrentWeek()" class="today-btn">Today</ion-button>
      </div>
      <ion-button fill="clear" size="small" (click)="navigateWeek('next')">
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </ion-button>
    </div> -->

    <!-- Date Strip -->
    <!-- <div class="date-strip-container" *ngIf="isTutor()">
      <div class="date-strip">
        <div 
          class="date-pill" 
          *ngFor="let d of dateStrip" 
          [class.active]="d.isToday" 
          [class.selected]="selectedDate && d.date.toDateString() === selectedDate.toDateString()"
          (click)="selectDate(d.date)">
          <div class="weekday">{{ d.label }}</div>
          <div class="daynum">{{ d.dayNum }}</div>
        </div>
      </div>
    </div> -->

    <!-- Loading State for Tutors -->
    <ion-card class="next-class-card loading-card" *ngIf="isTutor() && isLoadingLessons">
      <ion-card-content>
        <div class="card-inner">
          <div class="loading-skeleton">
            <div class="skeleton-badge"></div>
            <div class="skeleton-content">
              <div class="skeleton-avatar"></div>
              <div class="skeleton-details">
                <div class="skeleton-line skeleton-name"></div>
                <div class="skeleton-line skeleton-subject"></div>
                <div class="skeleton-line skeleton-time"></div>
              </div>
              <div class="skeleton-button"></div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Next Class Info Card - Show upcoming or cancelled based on active tab -->
    <ion-card class="next-class-card" *ngIf="isTutor() && !isLoadingLessons && (lessonView === 'upcoming' ? firstLessonForSelectedDate : firstCancelledLesson)">
      <!-- Hidden reference to countdownTick to trigger change detection -->
      <span style="display: none;">{{ countdownTick }}</span>
      <ion-card-content>
        <div class="card-inner" *ngIf="(lessonView === 'upcoming' ? firstLessonForSelectedDate : firstCancelledLesson) as nextClass">
          <!-- Badge Row -->
          <div class="badge-row">
            <div class="badge-row-left">
              <!-- Badge changes based on view and lesson status -->
              <div class="next-class-badge" [class.cancelled-badge]="lessonView === 'cancelled'">
                <span *ngIf="lessonView === 'cancelled'">CANCELLED</span>
                <span *ngIf="lessonView === 'upcoming' && nextClass.isInProgress">NOW</span>
                <span *ngIf="lessonView === 'upcoming' && !nextClass.isInProgress && nextClass.isNextClass">NEXT CLASS</span>
                <span *ngIf="lessonView === 'upcoming' && !nextClass.isInProgress && !nextClass.isNextClass">{{ nextClass.dateTag }}</span>
              </div>
              
              <!-- Trial Lesson Badge -->
              <div class="trial-lesson-badge" *ngIf="nextClass.lesson?.isTrialLesson">
                <ion-icon name="star"></ion-icon>
                <span>TRIAL</span>
              </div>
              
              <!-- Reschedule Proposal Badge -->
              <!-- If reschedule was accepted - show for both proposer and recipient -->
              <div class="reschedule-accepted-badge" 
                   *ngIf="nextClass.rescheduleAccepted">
                <ion-icon name="checkmark-circle"></ion-icon>
                <span>RESCHEDULE ACCEPTED</span>
              </div>
              
              <!-- If current user (tutor) proposed and waiting (and not yet accepted) -->
              <div class="reschedule-sent-badge" 
                   *ngIf="!nextClass.rescheduleAccepted && nextClass.lesson?.status === 'pending_reschedule' && nextClass.lesson?.rescheduleProposal?.status === 'pending' && nextClass.isRescheduleProposer">
                <ion-icon name="hourglass-outline"></ion-icon>
                <span>RESCHEDULE REQUEST SENT</span>
              </div>
              
              <!-- If student proposed and tutor needs to respond (and not yet accepted) -->
              <div class="reschedule-proposal-badge" 
                   *ngIf="!nextClass.rescheduleAccepted && nextClass.lesson?.status === 'pending_reschedule' && nextClass.lesson?.rescheduleProposal?.status === 'pending' && !nextClass.isRescheduleProposer"
                   (click)="showRescheduleProposal(nextClass.lesson); $event.stopPropagation()">
                <ion-icon name="time"></ion-icon>
                <span>NEW RESCHEDULE REQUEST RECEIVED - TAP TO REVIEW</span>
              </div>
            </div>
            
            <!-- Lesson/Class Menu Button (three dots) - Hide when lesson is in progress or cancelled -->
            <!-- Mobile: click handler for action sheet -->
            <ion-button 
              *ngIf="isMobile && !nextClass.isInProgress && lessonView !== 'cancelled'"
              fill="clear" 
              size="small" 
              class="class-menu-btn"
              (click)="openMobileLessonMenu($event, nextClass.lesson)">
              <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
            </ion-button>
            
            <!-- Desktop: trigger for popover -->
            <ion-button 
              *ngIf="!isMobile && !nextClass.isInProgress && lessonView !== 'cancelled'"
              [id]="'next-class-menu-' + nextClass.lesson._id"
              fill="clear" 
              size="small" 
              class="class-menu-btn">
              <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
            </ion-button>
            
            <!-- Popover for desktop only -->
            <ion-popover 
              *ngIf="!isMobile && !nextClass.isInProgress && lessonView !== 'cancelled'"
              [trigger]="'next-class-menu-' + nextClass.lesson._id"
              triggerAction="click"
              side="start"
              alignment="start"
              [dismissOnSelect]="true">
              <ng-template>
                <ion-content class="ion-padding">
                  <ion-list>
                    <ion-item [button]="true" (click)="inviteStudentToClass(nextClass.lesson._id)" *ngIf="nextClass.lesson?.isClass" [detail]="false">
                      <ion-icon name="person-add-outline" slot="start"></ion-icon>
                      <ion-label>Invite student</ion-label>
                    </ion-item>
                    <ion-item *ngIf="!hasLessonStarted(nextClass.lesson)" [button]="true" (click)="nextClass.lesson?.isClass ? rescheduleClass(nextClass.lesson._id, nextClass.lesson) : rescheduleLesson(nextClass.lesson._id, nextClass.lesson)" [detail]="false">
                      <ion-icon name="calendar-outline" slot="start"></ion-icon>
                      <ion-label>Reschedule</ion-label>
                    </ion-item>
                    <ion-item *ngIf="hasLessonStarted(nextClass.lesson)" [button]="false" [detail]="false" class="reschedule-disabled" (click)="$event.preventDefault(); $event.stopPropagation(); $event.stopImmediatePropagation()">
                      <ion-icon name="calendar-outline" slot="start"></ion-icon>
                      <ion-label>Reschedule</ion-label>
                    </ion-item>
                    <ion-item [button]="true" (click)="nextClass.lesson?.isClass ? cancelClass(nextClass.lesson._id, nextClass.lesson) : cancelLesson(nextClass.lesson._id, nextClass.lesson)" class="ion-text-danger" [detail]="false">
                      <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                      <ion-label>Cancel lesson</ion-label>
                    </ion-item>
                  </ion-list>
                </ion-content>
              </ng-template>
            </ion-popover>
          </div>
          
          <!-- Main Content - Horizontal Layout -->
          <div class="next-class-content">
            <!-- Left: Avatar -->
            <ion-avatar class="student-avatar">
              <!-- Class with thumbnail -->
              <img
                *ngIf="nextClass.lesson?.isClass && nextClass.lesson?.classData?.thumbnail"
                [src]="nextClass.lesson.classData.thumbnail"
                [alt]="nextClass.lesson.className || 'Class'"
                referrerpolicy="no-referrer"
              />
              <!-- Regular lesson with avatar -->
              <img
                *ngIf="!nextClass.lesson?.isClass && getOtherParticipantAvatar(nextClass.lesson) && getOtherParticipantAvatar(nextClass.lesson) !== 'assets/avatar.png'"
                [src]="getOtherParticipantAvatar(nextClass.lesson)"
                [alt]="nextClass | displayName"
                referrerpolicy="no-referrer"
              />
              <!-- Class without thumbnail - show people icon -->
              <ion-icon *ngIf="nextClass.lesson?.isClass && !nextClass.lesson?.classData?.thumbnail" name="people" class="avatar-placeholder-icon"></ion-icon>
              <!-- Regular lesson without avatar - show person icon -->
              <ion-icon *ngIf="!nextClass.lesson?.isClass && (!getOtherParticipantAvatar(nextClass.lesson) || getOtherParticipantAvatar(nextClass.lesson) === 'assets/avatar.png')" name="person" class="avatar-placeholder-icon"></ion-icon>
            </ion-avatar>
            
            <!-- Middle: Info -->
            <div class="class-info">
              <h3 class="class-title">
                <span *ngIf="nextClass.lesson?.isClass">{{ nextClass.lesson.className || nextClass.lesson.subject || 'Group Class' }}</span>
                <span *ngIf="!nextClass.lesson?.isClass">{{ nextClass | displayName }}</span>
              </h3>
              <p class="class-subtitle">
                <span *ngIf="nextClass.lesson?.isClass">{{ nextClass.subject }} Â· Group Class</span>
                <span *ngIf="!nextClass.lesson?.isClass">{{ nextClass.subject }} Student</span>
              </p>
              
              <!-- Time and date info -->
              <div class="class-meta">
                <div class="meta-item">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <span>{{ nextClass.isToday ? 'Today' : nextClass.dateTag }}</span>
                </div>
                <div class="meta-item">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>{{ getTimeRangeOnly(nextClass.lesson) }}</span>
                </div>
              </div>
              
              <!-- Class Attendees (if it's a class) -->
              <app-class-attendees 
                *ngIf="nextClass.lesson?.isClass && nextClass.lesson?.attendees"
                [attendees]="nextClass.lesson.attendees"
                [capacity]="nextClass.lesson.capacity"
                [maxDisplay]="3">
              </app-class-attendees>
              
              <!-- Cancellation reason (when viewing cancelled tab) -->
              <p class="cancellation-reason" *ngIf="lessonView === 'cancelled' && nextClass.lesson?.cancelReason === 'minimum_not_met'">
                <ion-icon name="information-circle-outline"></ion-icon>
                Cancelled due to insufficient enrollment
              </p>
            </div>
            
            <!-- Right: Action Column -->
            <div class="action-column" *ngIf="lessonView === 'upcoming'">
              <div class="time-until" *ngIf="!nextClass.isInProgress">
                <span class="time-label">Join in</span>
                <span class="time-value">{{ getTimeUntilLesson(nextClass.lesson) }}</span>
              </div>
              <ion-button 
                class="join-btn"
                [class.is-now]="nextClass.isInProgress"
                expand="block"
                [disabled]="!canJoinStudentLesson(nextClass)"
                (click)="joinStudentLesson(nextClass)">
                <ion-icon slot="start" [name]="nextClass.isInProgress ? 'videocam' : 'videocam-outline'"></ion-icon>
                {{ nextClass.isInProgress ? 'Join Now' : 'Join' }}
              </ion-button>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Empty State: No Classes Today / No More Classes Today / No Cancelled Classes -->
    <div class="next-class-empty-state" *ngIf="isTutor() && !isLoadingLessons && lessonView === 'upcoming' && !firstLessonForSelectedDate">
      <div class="empty-state-content">
        <ion-icon name="calendar-outline" class="empty-state-icon"></ion-icon>
        
        <!-- Case 1: Had lessons earlier today, but no more -->
        <h3 class="empty-state-title" *ngIf="hadLessonsEarlierToday()">No more classes today</h3>
        
        <!-- Case 2: No lessons at all today -->
        <ng-container *ngIf="!hadLessonsEarlierToday()">
          <h3 class="empty-state-title" *ngIf="getNextLessonInfo() && getNextLessonInfo()?.dayText === 'today'">Your next class is today</h3>
          <h3 class="empty-state-title" *ngIf="!getNextLessonInfo() || getNextLessonInfo()?.dayText !== 'today'">No lessons today</h3>
        </ng-container>
        
        <!-- Subtitle for Case 1: Had lessons earlier -->
        <p class="empty-state-subtitle" *ngIf="hadLessonsEarlierToday() && getNextLessonInfo()">
          Your next lesson is <strong>{{ getNextLessonInfo()?.dayText }}</strong> at <strong>{{ getNextLessonInfo()?.time }}</strong>
        </p>
        <p class="empty-state-subtitle" *ngIf="hadLessonsEarlierToday() && !getNextLessonInfo()">
          You don't have any more lessons scheduled for today.
        </p>
        
        <!-- Subtitle for Case 2: No lessons today at all -->
        <p class="empty-state-subtitle" *ngIf="!hadLessonsEarlierToday() && getNextLessonInfo() && getNextLessonInfo()?.dayText !== 'today'">
          Your next lesson is <strong>{{ getNextLessonInfo()?.dayText }}</strong> at <strong>{{ getNextLessonInfo()?.time }}</strong>
        </p>
        <p class="empty-state-subtitle" *ngIf="!hadLessonsEarlierToday() && getNextLessonInfo() && getNextLessonInfo()?.dayText === 'today'">
          Your class starts at <strong>{{ getNextLessonInfo()?.time }}</strong>
        </p>
        <p class="empty-state-subtitle" *ngIf="!hadLessonsEarlierToday() && !getNextLessonInfo()">
          You don't have any lessons scheduled yet.
        </p>
        
        <ion-button 
          fill="outline" 
          size="medium" 
          class="empty-state-cta"
          routerLink="/tabs/tutor-calendar">
          View Calendar
          <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
        </ion-button>
      </div>
    </div>
    
    <!-- Empty State: No Cancelled Classes -->
    <div class="next-class-empty-state" *ngIf="isTutor() && !isLoadingLessons && lessonView === 'cancelled' && !firstCancelledLesson">
      <div class="empty-state-content">
        <ion-icon name="close-circle-outline" class="empty-state-icon"></ion-icon>
        <h3 class="empty-state-title">No cancelled classes</h3>
        <p class="empty-state-subtitle">You don't have any recently cancelled classes.</p>
      </div>
    </div>

    <!-- Students/Tutors Grid (for selected date, excluding next class) -->
    <!-- Hidden: Only showing Next Class card now -->
    <div class="tutors-section" *ngIf="false && isTutor()">
      <div class="tutors-grid fade-in" *ngIf="getOtherStudentsForDate().length > 0">
        <div class="tutor-card" *ngFor="let student of getOtherStudentsForDate()">
          <div class="tutor-card-content">
            <ion-avatar class="tutor-avatar">
              <img *ngIf="student && (student.profilePicture || student.picture)" [src]="student.profilePicture || student.picture" alt="{{ student?.name }}" referrerpolicy="no-referrer">
              <ion-icon *ngIf="!student || (!student.profilePicture && !student.picture)" name="person" class="avatar-placeholder-icon"></ion-icon>
              <div class="presence-indicator" *ngIf="student?.lessonId && hasParticipantJoinedById(student.lessonId)">
                <ion-icon name="checkmark-circle" class="presence-icon"></ion-icon>
              </div>
            </ion-avatar>
            <div class="rating-badge" *ngIf="student && !student.isClass">
              <ion-icon name="star"></ion-icon>
              <span>{{ student?.rating || '4.5' }}</span>
            </div>
          </div>
          <div class="tutor-info">
            <h3>{{ student?.name || 'Student' }}</h3>
            <p class="subject">{{ student?.subject || '' }}</p>
            <p class="lesson-time" *ngIf="student?.lessonTime">
              <ion-icon name="time-outline"></ion-icon>
              {{ student.lessonTime }}
            </p>
            <!-- Presence indicator text for student card -->
            <div class="presence-text" *ngIf="student?.lessonId && hasParticipantJoinedById(student.lessonId)">
              <ion-icon name="person-circle-outline" class="presence-icon-small"></ion-icon>
              <span>{{ getPresenceDataById(student.lessonId)?.participantName || 'Student' }} has joined lesson</span>
            </div>
            <div class="student-card-actions" *ngIf="student?.lessonId">
              <ion-button fill="clear" size="small" class="action-icon-btn message">
                <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
              </ion-button>
              <ion-button 
                fill="solid"
                size="small" 
                class="join-btn-small" 
                [class.is-next-class]="student.isNextClass"
                [disabled]="!canJoinStudentLesson(student)"
                (click)="joinStudentLesson(student)">
                <ion-icon name="call-outline" slot="start"></ion-icon>
                {{ getStudentJoinLabel(student) }}
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Coming Up Next Timeline (for tutors) - Only show for upcoming view -->
    <div class="timeline-section" *ngIf="isTutor() && lessonView === 'upcoming' && timelineEvents.length > 0 && !isLoadingLessons">
      <div class="section-header-new">
        <h2>Coming Up</h2>
        <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
      </div>
      
      <ion-card class="timeline-card">
        <ion-card-content>
          <div class="timeline-container">
            <div class="timeline-item" *ngFor="let event of timelineEvents; let last = last; let first = first" [class.last]="last" [class.first]="first">
              <div class="timeline-dot"></div>
              <div class="timeline-line" *ngIf="!last"></div>
              <div class="timeline-content" [class.has-join-button]="first && event.lesson" (click)="!first || !event.lesson ? navigateToLesson(event.lesson) : null">
                <div class="timeline-header">
                  <div class="timeline-date-group">
                    <span class="timeline-time">{{ event.time }}</span>
                    <span class="timeline-end-time" *ngIf="event.endTime">{{ event.endTime }}</span>
                    <span class="timeline-date" [class.is-today]="event.date === 'Today'">{{ event.date }}</span>
                  </div>
                  <div class="timeline-header-right">
                    <ion-avatar class="timeline-avatar" *ngIf="event.avatar">
                      <img [src]="event.avatar" [alt]="event.name" referrerpolicy="no-referrer">
                    </ion-avatar>
                    <!-- Lesson/Class Menu Button (three dots) - Hide when lesson is in progress -->
                    <!-- Mobile: click handler for action sheet -->
                    <ion-button 
                      *ngIf="event.lesson && isMobile && !isLessonInProgress(event.lesson)"
                      fill="clear" 
                      size="small" 
                      class="class-menu-btn timeline-menu-btn"
                      (click)="openMobileLessonMenu($event, event.lesson)">
                      <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
                    </ion-button>
                    
                    <!-- Desktop: trigger for popover -->
                    <ion-button 
                      *ngIf="event.lesson && !isMobile && !isLessonInProgress(event.lesson)"
                      [id]="'timeline-menu-' + event.lesson._id"
                      fill="clear" 
                      size="small" 
                      class="class-menu-btn timeline-menu-btn">
                      <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
                    </ion-button>
                    
                    <!-- Popover for desktop only -->
                    <ion-popover 
                      *ngIf="event.lesson && !isMobile && !isLessonInProgress(event.lesson)"
                      [trigger]="'timeline-menu-' + event.lesson._id"
                      triggerAction="click"
                      side="start"
                      alignment="start"
                      [dismissOnSelect]="true">
                      <ng-template>
                        <ion-content class="ion-padding">
                          <ion-list>
                            <ion-item [button]="true" (click)="inviteStudentToClass(event.lesson._id)" *ngIf="event.lesson?.isClass" [detail]="false">
                              <ion-icon name="person-add-outline" slot="start"></ion-icon>
                              <ion-label>Invite student</ion-label>
                            </ion-item>
                            <ion-item *ngIf="!hasLessonStarted(event.lesson)" [button]="true" (click)="event.lesson?.isClass ? rescheduleClass(event.lesson._id, event.lesson) : rescheduleLesson(event.lesson._id, event.lesson)" [detail]="false">
                              <ion-icon name="calendar-outline" slot="start"></ion-icon>
                              <ion-label>Reschedule</ion-label>
                            </ion-item>
                            <ion-item *ngIf="hasLessonStarted(event.lesson)" [button]="false" [detail]="false" class="reschedule-disabled" (click)="$event.preventDefault(); $event.stopPropagation(); $event.stopImmediatePropagation()">
                              <ion-icon name="calendar-outline" slot="start"></ion-icon>
                              <ion-label>Reschedule</ion-label>
                            </ion-item>
                            <ion-item [button]="true" (click)="event.lesson?.isClass ? cancelClass(event.lesson._id, event.lesson) : cancelLesson(event.lesson._id, event.lesson)" class="ion-text-danger" [detail]="false">
                              <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                              <ion-label>Cancel lesson</ion-label>
                            </ion-item>
                          </ion-list>
                        </ion-content>
                      </ng-template>
                    </ion-popover>
                  </div>
                </div>
            <div class="timeline-details">
              <div class="timeline-name-row">
                <h4 class="timeline-name" [class.cancelled-text]="event.isCancelled">
                  <span *ngIf="event.lesson?.isClass">{{ event.lesson.className || event.lesson.subject || 'Group Class' }}</span>
                  <span *ngIf="!event.lesson?.isClass">{{ event.name }}</span>
                </h4>
                <div class="timeline-trial-badge" *ngIf="event.isTrialLesson">
                  <ion-icon name="star"></ion-icon>
                  <span>TRIAL</span>
                </div>
                
                <!-- Reschedule badges in timeline -->
                <!-- Show accepted badge for both proposer and recipient -->
                <div class="timeline-reschedule-accepted-badge" 
                     *ngIf="event.rescheduleAccepted">
                  <ion-icon name="checkmark-circle"></ion-icon>
                  <span>RESCHEDULE REQUEST ACCEPTED</span>
                </div>
                
                <!-- Show "request sent" badge only if not accepted and is proposer -->
                <div class="timeline-reschedule-sent-badge" 
                     *ngIf="!event.rescheduleAccepted && event.lesson?.status === 'pending_reschedule' && event.lesson?.rescheduleProposal?.status === 'pending' && event.isRescheduleProposer">
                  <ion-icon name="hourglass-outline"></ion-icon>
                  <span>RESCHEDULE REQUEST SENT</span>
                </div>
                
                <!-- Show "new request" badge only if not accepted and is recipient -->
                <div class="timeline-reschedule-badge" 
                     *ngIf="!event.rescheduleAccepted && event.lesson?.status === 'pending_reschedule' && event.lesson?.rescheduleProposal?.status === 'pending' && !event.isRescheduleProposer"
                     (click)="showRescheduleProposal(event.lesson); $event.stopPropagation()">
                  <ion-icon name="time"></ion-icon>
                  <span>NEW RESCHEDULE REQUEST</span>
                </div>
                
                <div class="timeline-cancelled-badge" *ngIf="event.isCancelled">
                  <ion-icon name="close-circle"></ion-icon>
                  <span>Cancelled</span>
                </div>
              </div>
              <p class="timeline-subject" [class.cancelled-text]="event.isCancelled">
                <span *ngIf="event.lesson?.isClass">Group Class</span>
                <span *ngIf="!event.lesson?.isClass">{{ event.subject }}</span>
              </p>
              
              <!-- Cancellation reason -->
              <p class="cancellation-reason" *ngIf="event.isCancelled && event.cancelReason === 'minimum_not_met'">
                <ion-icon name="information-circle-outline"></ion-icon>
                Cancelled due to insufficient enrollment
              </p>
              
              <!-- Class Attendees (if it's a class) -->
              <app-class-attendees 
                *ngIf="event.lesson?.isClass && event.lesson?.attendees"
                [attendees]="event.lesson.attendees"
                [capacity]="event.lesson.capacity"
                [maxDisplay]="3">
              </app-class-attendees>
              
              <!-- View Notes Button (Tutor Only) -->
              <div class="timeline-notes-btn" *ngIf="isTutor() && event.lesson?.notes">
                <ion-button 
                  fill="outline" 
                  size="small" 
                  color="primary"
                  (click)="openNotesModal(event.lesson); $event.stopPropagation()">
                  <ion-icon name="document-text-outline" slot="start"></ion-icon>
                  View Notes
                </ion-button>
              </div>
            </div>
                <!-- Join button for first timeline card -->
                <div class="timeline-join-button" *ngIf="first && event.lesson">
                  <ion-button 
                    fill="solid"
                    size="small" 
                    class="join-btn-timeline"
                    [disabled]="!canJoinStudentLesson({ lesson: event.lesson })"
                    (click)="joinStudentLesson({ lesson: event.lesson }); $event.stopPropagation()">
                    <ion-icon name="call-outline" slot="start"></ion-icon>
                    {{ getStudentJoinLabel({ lesson: event.lesson }) }}
                  </ion-button>
                </div>
              </div>
            </div>
            <!-- Show More Button -->
            <div class="timeline-show-more" *ngIf="hasMoreTimelineEvents()">
              <ion-button fill="clear" class="show-more-btn" (click)="navigateToTutorCalendar()">
                Show More
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Featured Tutors (for students) -->
    <div class="tutors-grid" *ngIf="!isTutor()">
      <div class="tutor-card" *ngFor="let tutor of featuredTutors">
        <div class="tutor-card-content">
          <ion-avatar class="tutor-avatar">
            <img *ngIf="tutor.profilePicture" [src]="tutor.profilePicture" alt="{{ tutor.name }}" referrerpolicy="no-referrer">
            <ion-icon *ngIf="!tutor.profilePicture" name="person" class="avatar-placeholder-icon"></ion-icon>
          </ion-avatar>
          <div class="rating-badge">
            <ion-icon name="star"></ion-icon>
            <span>{{ tutor.rating }}</span>
          </div>
        </div>
        <div class="tutor-info">
          <h3>{{ tutor.name }}</h3>
          <p>{{ tutor.specialty }}</p>
        </div>
      </div>
    </div>

    <!-- Upcoming Lesson Card -->
    <ion-card class="upcoming-lesson-card" [class.cancelled]="upcomingLesson?.status === 'cancelled'" *ngIf="upcomingLesson && !isTutor()">
      <ion-card-content>
        <div class="upcoming-lesson-row">
            <ion-avatar class="lesson-avatar-large">
            <img 
              *ngIf="upcomingLesson && !upcomingLesson.isClass && getPresenceAvatar(upcomingLesson)" 
              [src]="getPresenceAvatar(upcomingLesson)" 
              alt="Avatar" 
              referrerpolicy="no-referrer" />
            <ion-icon *ngIf="upcomingLesson?.isClass" name="people" class="avatar-placeholder-icon"></ion-icon>
            <ion-icon *ngIf="!upcomingLesson || (!upcomingLesson.isClass && !getPresenceAvatar(upcomingLesson))" name="person" class="avatar-placeholder-icon"></ion-icon>
            <div class="presence-indicator" *ngIf="hasParticipantJoined(upcomingLesson)">
              <ion-icon name="checkmark-circle" class="presence-icon"></ion-icon>
            </div>
          </ion-avatar>
          <div class="lesson-details">
            <h3 [class.cancelled-text]="upcomingLesson?.status === 'cancelled'">{{ upcomingLesson ? getOtherParticipantName(upcomingLesson) : '' }}</h3>
            <p class="lesson-specialty">{{ upcomingLesson ? getOtherParticipantSpecialty(upcomingLesson) : '' }}</p>
            
            <!-- Cancelled Badge -->
            <div class="cancelled-badge-inline" *ngIf="upcomingLesson?.status === 'cancelled'">
              <ion-icon name="close-circle"></ion-icon>
              <span>Cancelled</span>
              <span class="cancel-reason" *ngIf="upcomingLesson?.cancelReason === 'minimum_not_met'"> - Insufficient enrollment</span>
            </div>
            
            <!-- Reschedule Proposal Badge (Student View) -->
            <!-- If current user proposed the reschedule -->
            <div class="reschedule-sent-badge-inline" 
                 *ngIf="upcomingLesson?.status === 'pending_reschedule' && upcomingLesson?.rescheduleProposal && isRescheduleProposer(upcomingLesson)">
              <ion-icon name="hourglass-outline"></ion-icon>
              <span>Reschedule request sent</span>
            </div>
            
            <!-- If other user proposed the reschedule -->
            <div class="reschedule-proposal-badge-inline" 
                 *ngIf="upcomingLesson?.status === 'pending_reschedule' && upcomingLesson?.rescheduleProposal && !isRescheduleProposer(upcomingLesson)"
                 (click)="showRescheduleProposal(upcomingLesson); $event.stopPropagation()">
              <ion-icon name="time"></ion-icon>
              <span>New reschedule request received - Tap to review</span>
            </div>
            
            <!-- Class Attendees (if it's a class) -->
            <app-class-attendees 
              *ngIf="upcomingLesson?.isClass && upcomingLesson?.attendees"
              [attendees]="upcomingLesson.attendees"
              [capacity]="upcomingLesson.capacity"
              [maxDisplay]="3">
            </app-class-attendees>
            <div class="lesson-datetime">
              <ion-icon name="calendar-outline"></ion-icon>
              <span>{{ upcomingLesson ? formatLessonTime(upcomingLesson) : '' }}</span>
              <span class="status-badge in-progress" *ngIf="upcomingLesson && isLessonInProgress(upcomingLesson)">In progress</span>
            </div>
            <div class="presence-text" *ngIf="hasParticipantJoined(upcomingLesson)">
              <ion-icon name="person-circle-outline" class="presence-icon-small"></ion-icon>
              <span *ngIf="isTutor()">{{ getPresenceData(upcomingLesson)?.participantName || 'Student' }} has joined lesson</span>
              <span *ngIf="!isTutor()">{{ getPresenceData(upcomingLesson)?.participantName || 'Tutor' }} has joined lesson</span>
            </div>
          </div>
          <div class="lesson-actions">
            <ion-button fill="clear" class="action-icon-btn message">
              <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
            </ion-button>
            <ion-button 
              class="join-btn" 
              color="success" 
              [disabled]="upcomingLesson?.status === 'cancelled' || !canJoinUpcoming()" 
              (click)="joinUpcomingLesson()">
              <ion-icon name="call-outline" slot="start"></ion-icon>
              {{ upcomingLesson?.status === 'cancelled' ? 'Cancelled' : upcomingJoinLabel() }}
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Additional Upcoming Lessons for Students -->
    <div class="additional-lessons-section" *ngIf="!isTutor() && !isLoadingLessons && getUpcomingLessons().length > 1">
      <div class="additional-lessons-list">
        <ion-card 
          class="additional-lesson-card" 
          [class.cancelled]="additionalLesson?.status === 'cancelled'"
          *ngFor="let additionalLesson of getUpcomingLessons().slice(1, 6); trackBy: trackByLessonId">
          <ion-card-content>
            <div class="additional-lesson-row">
              <ion-avatar class="lesson-avatar-small">
                <img 
                  *ngIf="!additionalLesson.isClass && getPresenceAvatar(additionalLesson)" 
                  [src]="getPresenceAvatar(additionalLesson)" 
                  alt="Avatar" 
                  referrerpolicy="no-referrer" />
                <ion-icon *ngIf="additionalLesson.isClass" name="people" class="avatar-placeholder-icon"></ion-icon>
                <ion-icon *ngIf="!additionalLesson.isClass && !getPresenceAvatar(additionalLesson)" name="person" class="avatar-placeholder-icon"></ion-icon>
              </ion-avatar>
              <div class="lesson-info">
                <h4 [class.cancelled-text]="additionalLesson?.status === 'cancelled'">{{ additionalLesson.isClass ? (additionalLesson.className || additionalLesson.subject) : getOtherParticipantName(additionalLesson) }}</h4>
                <p class="lesson-type">{{ additionalLesson.isClass ? 'Group Class' : getOtherParticipantSpecialty(additionalLesson) }}</p>
                
                <!-- Cancelled Badge -->
                <div class="cancelled-badge-inline-small" *ngIf="additionalLesson?.status === 'cancelled'">
                  <ion-icon name="close-circle"></ion-icon>
                  <span>Cancelled</span>
                </div>
                
                <!-- Reschedule Proposal Badge (Additional Lessons) -->
                <!-- If current user proposed -->
                <div class="reschedule-sent-badge-inline-small" 
                     *ngIf="additionalLesson?.status === 'pending_reschedule' && additionalLesson?.rescheduleProposal && isRescheduleProposer(additionalLesson)">
                  <ion-icon name="hourglass-outline"></ion-icon>
                  <span>Request sent</span>
                </div>
                
                <!-- If other user proposed -->
                <div class="reschedule-proposal-badge-inline-small" 
                     *ngIf="additionalLesson?.status === 'pending_reschedule' && additionalLesson?.rescheduleProposal && !isRescheduleProposer(additionalLesson)"
                     (click)="showRescheduleProposal(additionalLesson); $event.stopPropagation()">
                  <ion-icon name="time"></ion-icon>
                  <span>New request received</span>
                </div>
                
                <div class="lesson-time-small">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <span>{{ formatLessonTime(additionalLesson) }}</span>
                  <span class="status-badge in-progress" *ngIf="isLessonInProgress(additionalLesson)">In progress</span>
                </div>
              </div>
              <ion-button 
                class="join-btn-small" 
                [color]="isLessonInProgress(additionalLesson) ? 'success' : 'primary'"
                [disabled]="additionalLesson?.status === 'cancelled' || (!canJoinLesson(additionalLesson) && !isLessonInProgress(additionalLesson))" 
                (click)="navigateToLesson(additionalLesson); $event.stopPropagation()">
                <ion-icon name="call-outline" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <!-- No Lessons State -->
    <ion-card class="empty-state-card" *ngIf="!isLoadingLessons && getUpcomingLessons().length === 0 && !isTutor()">
      <ion-card-content>
        <div class="empty-state">
          <ion-icon name="calendar-outline" class="empty-icon"></ion-icon>
          <h3>No upcoming lessons</h3>
          <p *ngIf="!isTutor()">Find a tutor to start learning</p>
          <p *ngIf="isTutor()">Your schedule is clear</p>
          
          <!-- Past Tutors Section (Student only, only if past tutors exist) - Now at top -->
          <div *ngIf="!isTutor() && pastTutors && pastTutors.length > 0" class="past-tutors-section">
            <p class="continue-working-text">Continue working with</p>
            <div class="stacked-avatars">
              <div 
                class="stacked-avatar" 
                *ngFor="let tutor of pastTutors.slice(0, 5); trackBy: trackByTutorId">
                <img 
                  *ngIf="tutor && tutor.picture"
                  [src]="tutor.picture" 
                  [alt]="tutor.name"
                  referrerpolicy="no-referrer">
                <ion-icon *ngIf="!tutor || !tutor.picture" name="person" style="font-size: 24px; color: #94a3b8;"></ion-icon>
              </div>
            </div>
            <p class="past-tutors-label">Or</p>
          </div>
          
          <!-- Find a Tutor Button - Now at bottom -->
          <ion-button 
            *ngIf="!isTutor()" 
            (click)="openSearchTutors()"
            class="find-tutor-btn">
            Find a Tutor
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <div class="section-header-new" *ngIf="!isLoadingLessons">
      <h2>{{ isTutor() ? 'Enhance Your Lessons' : 'Next Up' }}</h2>
      <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
    </div>

    <!-- Category Tabs (moved below lessons for mobile student view) -->
    <div class="category-tabs" *ngIf="isTutor() && !isLoadingLessons">
      <div class="tab-item">
        <div class="tab-icon kids">
          <ion-icon name="create"></ion-icon>
        </div>
        <span>Create Material</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon hospital">
          <ion-icon name="briefcase"></ion-icon>
        </div>
        <span>Business</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon consultant">
          <ion-icon name="people"></ion-icon>
        </div>
        <span>Explore</span>
      </div>
    </div>

  </div>

  <!-- Inline Confirm Reschedule Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isConfirmRescheduleModalOpen" 
    (didDismiss)="onConfirmRescheduleModalDismiss($event)"
    cssClass="confirm-action-modal">
    <ng-template>
      <app-confirm-action-modal
        *ngIf="confirmRescheduleModalData"
        [title]="confirmRescheduleModalData.title"
        [message]="confirmRescheduleModalData.message"
        [notificationMessage]="confirmRescheduleModalData.notificationMessage"
        [confirmText]="confirmRescheduleModalData.confirmText"
        [cancelText]="confirmRescheduleModalData.cancelText"
        [confirmColor]="confirmRescheduleModalData.confirmColor"
        [icon]="confirmRescheduleModalData.icon"
        [iconColor]="confirmRescheduleModalData.iconColor"
        [participantName]="confirmRescheduleModalData.participantName"
        [participantAvatar]="confirmRescheduleModalData.participantAvatar">
      </app-confirm-action-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Confirm Cancel Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isConfirmCancelModalOpen" 
    (didDismiss)="onConfirmCancelModalDismiss($event)"
    cssClass="confirm-action-modal">
    <ng-template>
      <app-confirm-action-modal
        *ngIf="confirmCancelModalData"
        [title]="confirmCancelModalData.title"
        [message]="confirmCancelModalData.message"
        [notificationMessage]="confirmCancelModalData.notificationMessage"
        [confirmText]="confirmCancelModalData.confirmText"
        [cancelText]="confirmCancelModalData.cancelText"
        [confirmColor]="confirmCancelModalData.confirmColor"
        [icon]="confirmCancelModalData.icon"
        [iconColor]="confirmCancelModalData.iconColor"
        [participantName]="confirmCancelModalData.participantName"
        [participantAvatar]="confirmCancelModalData.participantAvatar">
      </app-confirm-action-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Reschedule Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isRescheduleModalOpen" 
    (didDismiss)="onRescheduleModalDismiss($event)"
    cssClass="reschedule-lesson-modal">
    <ng-template>
      <app-reschedule-lesson-modal
        *ngIf="rescheduleModalData"
        [lessonId]="rescheduleModalData.lessonId"
        [lesson]="rescheduleModalData.lesson"
        [participantId]="rescheduleModalData.participantId"
        [participantName]="rescheduleModalData.participantName"
        [participantAvatar]="rescheduleModalData.participantAvatar"
        [currentUserId]="rescheduleModalData.currentUserId"
        [isTutor]="rescheduleModalData.isTutor"
        [showBackButton]="rescheduleModalData.showBackButton">
      </app-reschedule-lesson-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Reschedule Proposal Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isRescheduleProposalModalOpen" 
    (didDismiss)="onRescheduleProposalModalDismiss($event)"
    cssClass="reschedule-proposal-modal">
    <ng-template>
      <app-reschedule-proposal-modal
        *ngIf="rescheduleProposalModalData"
        [lessonId]="rescheduleProposalModalData.lessonId"
        [lesson]="rescheduleProposalModalData.lesson"
        [proposal]="rescheduleProposalModalData.proposal"
        [participantName]="rescheduleProposalModalData.participantName"
        [participantAvatar]="rescheduleProposalModalData.participantAvatar"
        [proposedDate]="rescheduleProposalModalData.proposedDate"
        [proposedTime]="rescheduleProposalModalData.proposedTime"
        [originalDate]="rescheduleProposalModalData.originalDate"
        [originalTime]="rescheduleProposalModalData.originalTime">
      </app-reschedule-proposal-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Class Invitation Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isClassInvitationModalOpen" 
    (didDismiss)="onClassInvitationModalDismiss($event)"
    cssClass="class-invitation-modal">
    <ng-template>
      <app-class-invitation-modal
        *ngIf="classInvitationModalData"
        [classId]="classInvitationModalData.classId"
        [notification]="classInvitationModalData.notification">
      </app-class-invitation-modal>
    </ng-template>
  </ion-modal>

</ion-content>