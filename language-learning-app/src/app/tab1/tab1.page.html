<!-- home.page.html -->
<ion-content>
  
  <div class="content-wrapper">
    
    <!-- üé® DEV: Test Smart Island Button -->
    <!-- <button 
      *ngIf="true"
      (click)="testSmartIsland()"
      style="position: fixed; bottom: 140px; right: 20px; z-index: 9999; padding: 12px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4); cursor: pointer;">
      üåü Test Island
    </button> -->
    
    <!-- üé® DEV: Preview Lesson Summary Button -->
    <!-- <div style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;" *ngIf="currentUser?.userType === 'student'">
      <ion-button color="secondary" (click)="previewLessonSummaryModal()" size="small" style="--box-shadow: 0 4px 16px rgba(0,0,0,0.2);">
        <ion-icon name="eye" slot="start"></ion-icon>
        {{ 'HOME.PREVIEW_SUMMARY' | translate }}
      </ion-button>
    </div> -->
    
    <!-- Welcome Message with Search Bar (Students) -->
    <div class="welcome-section" *ngIf="currentUser && isStudent()">
      <div class="welcome-header">
        <div class="welcome-content">
          <h1 class="welcome-title">Hi, {{currentUser.firstName}}! üëã</h1>
          <p class="welcome-subtitle" *ngIf="activeInvitationsCount > 0 && !nextLesson">
            You have {{activeInvitationsCount}} pending {{activeInvitationsCount === 1 ? 'invitation' : 'invitations'}}
          </p>
          <p class="welcome-subtitle" *ngIf="!activeInvitationsCount && nextLesson && getNextLessonTimeLabel()">
            Your next lesson is {{ getNextLessonTimeLabel() }}
          </p>
          <p class="welcome-subtitle" *ngIf="activeInvitationsCount > 0 && nextLesson && getNextLessonTimeLabel()">
            {{activeInvitationsCount}} {{activeInvitationsCount === 1 ? 'invitation' : 'invitations'}} pending ‚Ä¢ Next lesson {{ getNextLessonTimeLabel() }}
          </p>
          <p class="welcome-subtitle" *ngIf="!activeInvitationsCount && (!nextLesson || !getNextLessonTimeLabel())">
            Ready to learn something new today?
          </p>
        </div>
        
        <!-- Compact Search Bar (inline right) -->
        <div class="search-container-compact" (click)="openSearchTutors()">
          <ion-icon name="search-outline" class="search-icon"></ion-icon>
          <input type="text" [placeholder]="'HOME.SEARCH_PLACEHOLDER' | translate" readonly class="search-input">
        </div>
      </div>
    </div>
    
    <!-- Welcome Message (Tutors) -->
    <div class="welcome-section" *ngIf="currentUser && isTutor()">
      <div class="welcome-header">
        <div class="welcome-content">
          <h1 class="welcome-title">Hi, {{currentUser.firstName}}! üëã</h1>
        </div>
      </div>
    </div>
    
    <!-- Smart Island Section -->
    <div class="smart-island-section" *ngIf="isStudent()">
      <app-smart-island #smartIsland></app-smart-island>
    </div>
    
    <!-- Insights Panel (for both students and tutors) -->
    <div class="insights-panel" *ngIf="currentUser">
      <div class="insight-metric" *ngIf="isTutor()">
        <div class="insight-icon students">
          <ion-icon name="people"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ totalStudents || 0 }}</div>
          <div class="insight-label">Students</div>
        </div>
      </div>
      <div class="insight-divider" *ngIf="isTutor()"></div>
      
      <div class="insight-metric" 
           *ngIf="isStudent()" 
           (click)="router.navigate(['/tabs/tutors'])" 
           style="cursor: pointer;">
        <!-- Tutors for students -->
        <div class="insight-icon tutors">
          <ion-icon name="people"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ totalTutors || 0 }}</div>
          <div class="insight-label">Tutors</div>
        </div>
      </div>
      
      <div class="insight-metric" *ngIf="isTutor()" (click)="navigateToCompletedLessons()" style="cursor: pointer;">
        <!-- Completed Lessons (clickable) for tutors -->
        <div class="insight-icon lessons">
          <ion-icon name="videocam"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ totalLessonsCompleted || 0 }}</div>
          <div class="insight-label">Lessons Completed</div>
        </div>
      </div>
      
      <div class="insight-divider" *ngIf="isTutor()"></div>
      
      <div class="insight-metric" *ngIf="isTutor()">
        <!-- Rating (not clickable) for tutors -->
        <div class="insight-icon rating">
          <ion-icon name="star"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ tutorRating || '0.0' }}</div>
          <div class="insight-label">Rating</div>
        </div>
      </div>
      
      <div class="insight-divider" *ngIf="isStudent()"></div>
      <div class="insight-metric" *ngIf="isStudent()" (click)="navigateToInvitations()" style="cursor: pointer;">
        <div class="insight-icon invitations">
          <ion-icon name="mail-outline"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ activeInvitationsCount || 0 }}</div>
          <div class="insight-label">Class Invitations</div>
        </div>
      </div>
      <div class="insight-divider"></div>
      
      <div class="insight-metric" *ngIf="isStudent()" (click)="navigateToCompletedLessons()" style="cursor: pointer;">
        <!-- Completed Lessons (clickable) for students -->
        <div class="insight-icon analysis">
          <ion-icon name="videocam"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ totalLessonsCompleted || 0 }}</div>
          <div class="insight-label">Lessons Completed</div>
        </div>
      </div>
      
      <div class="insight-divider" *ngIf="isStudent()"></div>
      <div class="insight-metric" *ngIf="isStudent()" (click)="router.navigate(['/tabs/progress'])" style="cursor: pointer;">
        <div class="insight-icon wallet">
          <ion-icon name="wallet-outline"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ lessons.length || 0 }}</div>
          <div class="insight-label">Balance</div>
        </div>
      </div>
      
      <div class="insight-divider" *ngIf="isTutor()"></div>
      <div class="insight-metric" *ngIf="isTutor()" (click)="router.navigate(['/wallet'])" style="cursor: pointer;">
        <div class="insight-icon messages">
          <ion-icon name="wallet-outline"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value wallet-value" 
               [class.wallet-hidden]="!showWalletBalance && !walletTemporarilyVisible"
               (click)="toggleWalletVisibility($event)">
            <span class="wallet-amount" *ngIf="!showWalletBalance && !walletTemporarilyVisible">$<span class="wallet-dots">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></span>
            <span class="wallet-amount" *ngIf="showWalletBalance || walletTemporarilyVisible">${{ walletBalance.toFixed(2) }}</span>
            <span class="wallet-amount-hover" *ngIf="!showWalletBalance && !walletTemporarilyVisible">${{ walletBalance.toFixed(2) }}</span>
          </div>
          <div class="insight-label">Wallet</div>
        </div>
      </div>
    </div>
    
    <!-- 
    TEMPORARILY DISABLED: Tutor Feedback System
    TODO: Re-enable if we want to support AI-disabled mode
    
    <ion-button 
      *ngIf="isTutor()"
      expand="block" 
      fill="outline" 
      size="small"
      color="warning"
      (click)="openTestFeedbackForm()"
      style="margin: 16px;">
      üß™ Test Feedback Form
    </ion-button>
    
    <ion-card *ngIf="isTutor()" style="margin: 16px; background: #ffe6e6; border: 2px solid #ff4444;">
      <ion-card-content>
        <h3 style="color: #ff4444; margin-top: 0;">üêõ DEBUG: Feedback Status</h3>
        <p><strong>Current User:</strong> {{ currentUser?.email || 'Not loaded' }}</p>
        <p><strong>User Type:</strong> {{ currentUser?.userType || 'Unknown' }}</p>
        <p><strong>Is Tutor:</strong> {{ isTutor() }}</p>
        <p><strong>Pending Feedback Count:</strong> {{ pendingFeedbackCount }}</p>
        <p><strong>Has Shown Alert:</strong> {{ hasShownFeedbackAlertThisSession }}</p>
        <p><strong>Feedback Items:</strong> {{ pendingFeedback.length }}</p>
        <ion-button size="small" (click)="loadPendingFeedback()">
          üîÑ Reload Feedback
        </ion-button>
        <ion-button size="small" color="primary" (click)="showFeedbackAlert()" *ngIf="pendingFeedbackCount > 0">
          üîî Force Show Alert
        </ion-button>
      </ion-card-content>
    </ion-card>
    
    <div class="pending-feedback-section" *ngIf="isTutor() && pendingFeedbackCount > 0">
      <div class="section-header-compact">
        <div class="section-title-row">
          <h2 class="section-title">Feedback Needed</h2>
          <ion-chip color="primary" class="feedback-count-chip">
            <ion-label>{{ pendingFeedbackCount }}</ion-label>
          </ion-chip>
        </div>
        <p class="section-subtitle">Provide feedback while lessons are fresh in your mind</p>
      </div>
      
      <div class="feedback-requests-list">
        <div 
          *ngFor="let feedback of pendingFeedback.slice(0, 3)" 
          class="feedback-request-card"
          (click)="openFeedbackForm(feedback._id)"
        >
          <ion-avatar class="feedback-avatar">
            <img [src]="feedback.studentPicture" *ngIf="feedback.studentPicture" />
            <div class="avatar-placeholder" *ngIf="!feedback.studentPicture">
              {{ feedback.studentName?.charAt(0) || 'S' }}
            </div>
          </ion-avatar>
          <div class="feedback-info">
            <h3>{{ feedback.studentName }}</h3>
            <p *ngIf="feedback.lesson">
              {{ feedback.lesson.startTime | date: 'EEE, MMM d ‚Ä¢ h:mm a' }}
            </p>
          </div>
          <ion-icon name="chevron-forward" class="feedback-arrow"></ion-icon>
        </div>
        
        <ion-button 
          *ngIf="pendingFeedbackCount > 3"
          expand="block" 
          fill="outline" 
          size="small"
          class="view-all-button"
          (click)="router.navigate(['/tabs/home/lessons'])"
        >
          View All ({{ pendingFeedbackCount }})
        </ion-button>
      </div>
    </div>
    -->
    
    <!-- Upcoming Schedule Section -->
    <!-- Header Loading Skeleton -->
    <div class="section-header-skeleton" *ngIf="isLoadingLessons">
      <div class="skeleton-line skeleton-header"></div>
      <div class="skeleton-line skeleton-button-small"></div>
    </div>
    
    <div class="section-header-new" *ngIf="!isLoadingLessons">
      <h2>{{'HOME.UPCOMING_LESSONS' | translate}}</h2>
    </div>

    <!-- <div class="week-navigation" *ngIf="isTutor()">
      <ion-button fill="clear" size="small" (click)="navigateWeek('prev')">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>
      <div class="week-display">
        <span class="week-range">{{ weekRangeLabel }}</span>
        <ion-button fill="clear" size="small" (click)="goToToday()" [disabled]="isCurrentWeek()" class="today-btn">Today</ion-button>
      </div>
      <ion-button fill="clear" size="small" (click)="navigateWeek('next')">
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </ion-button>
    </div> -->

    <!-- Date Strip -->
    <!-- <div class="date-strip-container" *ngIf="isTutor()">
      <div class="date-strip">
        <div 
          class="date-pill" 
          *ngFor="let d of dateStrip" 
          [class.active]="d.isToday" 
          [class.selected]="selectedDate && d.date.toDateString() === selectedDate.toDateString()"
          (click)="selectDate(d.date)">
          <div class="weekday">{{ d.label }}</div>
          <div class="daynum">{{ d.dayNum }}</div>
        </div>
      </div>
    </div> -->

    <!-- Loading State -->
    <ion-card class="next-class-card loading-card" *ngIf="isLoadingLessons">
      <ion-card-content>
        <div class="card-inner">
          <div class="loading-skeleton">
            <div class="skeleton-badge"></div>
            <div class="skeleton-content">
              <div class="skeleton-avatar"></div>
              <div class="skeleton-details">
                <div class="skeleton-line skeleton-name"></div>
                <div class="skeleton-line skeleton-subject"></div>
                <div class="skeleton-line skeleton-time"></div>
              </div>
              <div class="skeleton-button"></div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Next Class Info Card (for both tutors and students) -->
    <ion-card class="next-class-card" *ngIf="!isLoadingLessons && nextLesson">
      <!-- Hidden reference to countdownTick to trigger change detection -->
      <span style="display: none;">{{ countdownTick }}</span>
      <ion-card-content>
        <div class="card-inner" *ngIf="nextLesson as nextClass">
          
          <!-- Modern Spacious Layout -->
          <div class="next-class-layout-modern">
            <!-- Left Section: Avatar + Info -->
            <div class="left-section-modern">
              <!-- Avatar with Badge -->
              <div class="avatar-with-badge">
                <div class="badge-container">
                  <!-- Main status badge (NEXT LESSON / CANCELLED) -->
                  <span class="badge-modern badge-light" 
                        [class.badge-cancelled]="nextClass.lesson?.status === 'cancelled'">
                    <span *ngIf="nextClass.lesson?.status === 'cancelled'">CANCELLED</span>
                    <span *ngIf="nextClass.lesson?.status !== 'cancelled'">NEXT LESSON</span>
                  </span>
                  
                  <!-- Trial badge (additional badge for trial lessons) -->
                  <span class="badge-modern badge-trial" *ngIf="nextClass.lesson?.isTrialLesson && nextClass.lesson?.status !== 'cancelled'">
                    <ion-icon name="star"></ion-icon>
                    TRIAL
                  </span>
                  
                  <!-- Reschedule badges -->
                  <!-- Sent reschedule proposal (you are the proposer) -->
                  <span class="badge-modern badge-reschedule-sent" 
                        *ngIf="nextClass.rescheduleAccepted && nextClass.lesson?.status === 'pending_reschedule' && nextClass.lesson?.rescheduleProposal?.status === 'accepted'">
                    <ion-icon name="checkmark-circle"></ion-icon>
                    RESCHEDULE ACCEPTED
                  </span>
                  <span class="badge-modern badge-reschedule-sent" 
                        *ngIf="!nextClass.rescheduleAccepted && nextClass.lesson?.status === 'pending_reschedule' && nextClass.lesson?.rescheduleProposal?.status === 'pending' && nextClass.isRescheduleProposer">
                    <ion-icon name="time"></ion-icon>
                    RESCHEDULE REQUEST SENT
                  </span>
                  
                  <!-- Received reschedule proposal (you are NOT the proposer) -->
                  <span class="badge-modern badge-reschedule-proposal" 
                        *ngIf="!nextClass.rescheduleAccepted && nextClass.lesson?.status === 'pending_reschedule' && nextClass.lesson?.rescheduleProposal?.status === 'pending' && !nextClass.isRescheduleProposer"
                        (click)="showRescheduleProposal(nextClass.lesson)">
                    <ion-icon name="alert-circle"></ion-icon>
                    NEW RESCHEDULE REQUEST
                  </span>
                </div>
                <ion-avatar class="class-avatar-modern">
                  <img
                    *ngIf="nextClass.lesson?.isClass && nextClass.lesson?.classData?.thumbnail"
                    [src]="nextClass.lesson.classData.thumbnail"
                    [alt]="nextClass.lesson.className || 'Class'"
                    referrerpolicy="no-referrer"
                  />
                  <img
                    *ngIf="!nextClass.lesson?.isClass && getOtherParticipantAvatar(nextClass.lesson) && getOtherParticipantAvatar(nextClass.lesson) !== 'assets/avatar.png'"
                    [src]="getOtherParticipantAvatar(nextClass.lesson)"
                    [alt]="nextClass | displayName"
                    referrerpolicy="no-referrer"
                  />
                  <ion-icon *ngIf="nextClass.lesson?.isClass && !nextClass.lesson?.classData?.thumbnail" name="people" class="avatar-placeholder"></ion-icon>
                  <ion-icon *ngIf="!nextClass.lesson?.isClass && (!getOtherParticipantAvatar(nextClass.lesson) || getOtherParticipantAvatar(nextClass.lesson) === 'assets/avatar.png')" name="person" class="avatar-placeholder"></ion-icon>
                </ion-avatar>
              </div>
              
              <!-- Info Section -->
              <div class="info-section-modern">
                <!-- Name -->
                <h2 class="class-name-modern">
                  <span *ngIf="nextClass.lesson?.isClass">{{ nextClass.lesson.className || nextClass.lesson.subject || 'Group Class' }}</span>
                  <span *ngIf="!nextClass.lesson?.isClass">{{ nextClass | displayName }}</span>
                </h2>
                
                <!-- Date & Time (horizontal with icons) -->
                <div class="date-time-row">
                  <span class="subject-text" *ngIf="!nextClass.lesson?.isClass">
                    <img 
                      *ngIf="flagService.getFlagPath(nextClass.subject)" 
                      [src]="flagService.getFlagPath(nextClass.subject)" 
                      class="flag-icon"
                      [alt]="nextClass.subject + ' flag'"
                    />
                    {{ nextClass.subject }}
                  </span>
                  <span class="date-time-text" [class.is-today]="nextClass.isToday">
                    <ion-icon name="calendar-outline"></ion-icon>
                    {{ nextClass.isToday ? 'Today' : nextClass.dateTag }}
                  </span>
                  <span class="date-time-text">
                    <ion-icon name="time-outline"></ion-icon>
                    {{ getTimeRangeOnly(nextClass.lesson) }}
                  </span>
                </div>
                
                <!-- Attendees for classes -->
                <app-class-attendees 
                  *ngIf="nextClass.lesson?.isClass && nextClass.lesson?.attendees"
                  [attendees]="nextClass.lesson.attendees"
                  [capacity]="nextClass.lesson.capacity"
                  [maxDisplay]="3">
                </app-class-attendees>
                
                <!-- Cancellation reason -->
                <p class="cancel-reason" *ngIf="nextClass.lesson?.status === 'cancelled' && nextClass.lesson?.cancelReason === 'minimum_not_met'">
                  <ion-icon name="information-circle-outline"></ion-icon>
                  Cancelled due to insufficient enrollment
                </p>
              </div>
            </div>
            
            <!-- Right Section: Starts In Card -->
            <div class="starts-in-card" *ngIf="nextClass.lesson?.status !== 'cancelled'">
              <span class="starts-label-modern">{{ isLessonInProgress(nextClass.lesson) ? 'STARTED' : 'STARTS IN' }}</span>
              <span class="countdown-modern">{{ getTimeUntilLesson(nextClass.lesson) }}</span>
              <ion-button 
                class="join-button-modern"
                [class.active]="isLessonInProgress(nextClass.lesson)"
                expand="block"
                [disabled]="!canJoinStudentLesson(nextClass)"
                (click)="joinStudentLesson(nextClass)">
                <ion-icon slot="start" [name]="isLessonInProgress(nextClass.lesson) ? 'videocam' : 'videocam-outline'"></ion-icon>
                {{ isLessonInProgress(nextClass.lesson) ? 'Join Now' : 'Join' }}
              </ion-button>
            </div>
            
            <!-- Three-dot menu button -->
            <ion-button 
              *ngIf="!isMobile && !nextClass.isInProgress && nextClass.lesson?.status !== 'cancelled'"
              [id]="'next-class-menu-' + nextClass.lesson._id"
              fill="clear"
              class="menu-button-modern">
              <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
            </ion-button>
            
            <ion-popover 
              *ngIf="!isMobile && !nextClass.isInProgress && nextClass.lesson?.status !== 'cancelled'"
              [trigger]="'next-class-menu-' + nextClass.lesson._id"
              triggerAction="click"
              side="start"
              alignment="start"
              [dismissOnSelect]="true">
              <ng-template>
                <ion-content class="ion-padding">
                  <ion-list>
                    <!-- Tutor actions -->
                    <ion-item *ngIf="isTutor() && nextClass.lesson?.isClass" [button]="true" (click)="inviteStudentToClass(nextClass.lesson._id)" [detail]="false">
                      <ion-icon name="person-add-outline" slot="start"></ion-icon>
                      <ion-label>Invite student</ion-label>
                    </ion-item>
                    
                    <!-- Reschedule for both tutors and students -->
                    <ion-item *ngIf="!hasLessonStarted(nextClass.lesson)" [button]="true" (click)="nextClass.lesson?.isClass ? rescheduleClass(nextClass.lesson._id, nextClass.lesson) : rescheduleLesson(nextClass.lesson._id, nextClass.lesson)" [detail]="false">
                      <ion-icon name="calendar-outline" slot="start"></ion-icon>
                      <ion-label>Reschedule</ion-label>
                    </ion-item>
                    <ion-item *ngIf="hasLessonStarted(nextClass.lesson)" [button]="false" [detail]="false" class="reschedule-disabled" (click)="$event.preventDefault(); $event.stopPropagation(); $event.stopImmediatePropagation()">
                      <ion-icon name="calendar-outline" slot="start"></ion-icon>
                      <ion-label>Reschedule</ion-label>
                    </ion-item>
                    
                    <!-- Cancel for both tutors and students -->
                    <ion-item [button]="true" (click)="nextClass.lesson?.isClass ? cancelClass(nextClass.lesson._id, nextClass.lesson) : cancelLesson(nextClass.lesson._id, nextClass.lesson)" class="ion-text-danger" [detail]="false">
                      <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                      <ion-label>Cancel lesson</ion-label>
                    </ion-item>
                  </ion-list>
                </ion-content>
              </ng-template>
            </ion-popover>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Empty State: No Upcoming Lessons (Tutors) -->
    <div class="next-class-empty-state" *ngIf="isTutor() && !isLoadingLessons && !nextLesson">
      <div class="empty-state-content">
        <ion-icon name="calendar-outline" class="empty-state-icon"></ion-icon>
        <h3 class="empty-state-title" *ngIf="!hadLessonsEarlierToday()">No upcoming lessons</h3>
        <h3 class="empty-state-title" *ngIf="hadLessonsEarlierToday()">No more lessons for today</h3>
        <p class="empty-state-subtitle" *ngIf="!hadLessonsEarlierToday()">You don't have any lessons scheduled yet.</p>
        <p class="empty-state-subtitle" *ngIf="hadLessonsEarlierToday()">You don't have any more lessons scheduled for today.</p>
        
        <ion-button 
          fill="clear" 
          size="medium" 
          class="empty-state-cta"
          routerLink="/tabs/tutor-calendar">
          View Calendar
          <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Empty State: No Upcoming Lessons (Students) -->
    <div class="next-class-empty-state" *ngIf="isStudent() && !isLoadingLessons && !nextLesson">
      <div class="empty-state-content">
        <ion-icon name="calendar-outline" class="empty-state-icon"></ion-icon>
        <h3 class="empty-state-title">No upcoming lessons</h3>
        <p class="empty-state-subtitle">Book another lesson with your tutors or find new tutors.</p>
        
        <div class="empty-state-actions">
          <ion-button 
            fill="clear" 
            size="medium" 
            class="empty-state-cta"
            routerLink="/tabs/tutor-search">
            Find Tutors
            <ion-icon name="search-outline" slot="end"></ion-icon>
          </ion-button>
          
          <span class="or-text" *ngIf="getRecentTutors().length > 0">or rebook with</span>
          
          <div class="recent-tutors-avatars" *ngIf="getRecentTutors().length > 0">
            <div 
              *ngFor="let tutor of getRecentTutorsForDisplay(); let i = index"
              class="tutor-avatar-tooltip-wrapper"
              [class.more-indicator]="i === 4 && hasMoreTutors()">
              <ion-avatar 
                class="recent-tutor-avatar"
                (click)="i === 4 && hasMoreTutors() ? openAllTutorsModal() : openTutorAvailability(tutor)">
                <img 
                  *ngIf="(i < 4 || !hasMoreTutors()) && (tutor.picture || tutor.profilePicture)" 
                  [src]="tutor.picture || tutor.profilePicture" 
                  [alt]="tutor.firstName || tutor.name || 'Tutor'"
                  referrerpolicy="no-referrer">
                <ion-icon 
                  *ngIf="(i < 4 || !hasMoreTutors()) && !tutor.picture && !tutor.profilePicture" 
                  name="person" 
                  class="avatar-placeholder-icon">
                </ion-icon>
                <div *ngIf="i === 4 && hasMoreTutors()" class="more-count">
                  +{{ getRecentTutors().length - 4 }}
                </div>
              </ion-avatar>
              <span class="tooltip-text" *ngIf="i < 4 || !hasMoreTutors()">
                {{ getTutorTooltipName(tutor) }}
              </span>
              <span class="tooltip-text" *ngIf="i === 4 && hasMoreTutors()">
                +{{ getRecentTutors().length - 4 }} more
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tutor Booking Modal (inline) -->
    <ion-modal
      [isOpen]="isTutorBookingModalOpen"
      (didDismiss)="closeTutorBookingModal()"
      cssClass="tutor-booking-modal">
      <ng-template>
        <app-tutor-availability-viewer
          *ngIf="selectedTutorForBooking"
          [tutorId]="selectedTutorForBooking._id || selectedTutorForBooking.id"
          [tutorName]="selectedTutorForBooking.name || selectedTutorForBooking.firstName || 'Tutor'"
          [selectionMode]="false"
          [showDurationSelector]="true">
        </app-tutor-availability-viewer>
      </ng-template>
    </ion-modal>
    
    <!-- All Tutors Modal (inline) -->
    <ion-modal
      [isOpen]="isAllTutorsModalOpen"
      (didDismiss)="closeAllTutorsModal()"
      [breakpoints]="[0, 0.5, 0.75, 1]"
      [initialBreakpoint]="0.75"
      cssClass="all-tutors-modal">
      <ng-template>
        <ion-header>
          <ion-toolbar>
            <ion-title>Your Tutors</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeAllTutorsModal()">
                <ion-icon name="close" slot="icon-only"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <p>Coming soon: View all your tutors here</p>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- Students/Tutors Grid (for selected date, excluding next class) -->
    <!-- Hidden: Only showing Next Class card now -->
    <div class="tutors-section" *ngIf="false && isTutor()">
      <div class="tutors-grid fade-in" *ngIf="getOtherStudentsForDate().length > 0">
        <div class="tutor-card" *ngFor="let student of getOtherStudentsForDate()">
          <div class="tutor-card-content">
            <ion-avatar class="tutor-avatar">
              <img *ngIf="student && (student.profilePicture || student.picture)" [src]="student.profilePicture || student.picture" alt="{{ student?.name }}" referrerpolicy="no-referrer">
              <ion-icon *ngIf="!student || (!student.profilePicture && !student.picture)" name="person" class="avatar-placeholder-icon"></ion-icon>
              <div class="presence-indicator" *ngIf="student?.lessonId && hasParticipantJoinedById(student.lessonId)">
                <ion-icon name="checkmark-circle" class="presence-icon"></ion-icon>
              </div>
            </ion-avatar>
            <div class="rating-badge" *ngIf="student && !student.isClass">
              <ion-icon name="star"></ion-icon>
              <span>{{ student?.rating || '4.5' }}</span>
            </div>
          </div>
          <div class="tutor-info">
            <h3>{{ student?.name || 'Student' }}</h3>
            <p class="subject">{{ student?.subject || '' }}</p>
            <p class="lesson-time" *ngIf="student?.lessonTime">
              <ion-icon name="time-outline"></ion-icon>
              {{ student.lessonTime }}
            </p>
            <!-- Presence indicator text for student card -->
            <div class="presence-text" *ngIf="student?.lessonId && hasParticipantJoinedById(student.lessonId)">
              <ion-icon name="person-circle-outline" class="presence-icon-small"></ion-icon>
              <span>{{ getPresenceDataById(student.lessonId)?.participantName || 'Student' }} has joined lesson</span>
            </div>
            <div class="student-card-actions" *ngIf="student?.lessonId">
              <ion-button fill="clear" size="small" class="action-icon-btn message">
                <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
              </ion-button>
              <ion-button 
                fill="solid"
                size="small" 
                class="join-btn-small" 
                [class.is-next-class]="student.isNextClass"
                [disabled]="!canJoinStudentLesson(student)"
                (click)="joinStudentLesson(student)">
                <ion-icon name="call-outline" slot="start"></ion-icon>
                {{ getStudentJoinLabel(student) }}
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Coming Up Next Timeline (for tutors) -->
    <div class="timeline-section" *ngIf="timelineEvents.length > 0 && !isLoadingLessons">
      <div class="section-header-new">
        <h2>Coming Up</h2>
        <ion-button *ngIf="isTutor()" fill="clear" class="see-all-btn" routerLink="/tabs/home/lessons">See All</ion-button>
      </div>
      
      <ion-card class="timeline-card">
        <ion-card-content>
          <div class="timeline-container">
            <div class="timeline-item" *ngFor="let event of timelineEvents; let last = last; let first = first" [class.last]="last" [class.first]="first">
              <div class="timeline-dot"></div>
              <div class="timeline-line" *ngIf="!last"></div>
              <div class="timeline-content" [class.has-join-button]="first && event.lesson" (click)="!first || !event.lesson ? navigateToLesson(event.lesson) : null">
                <!-- Modern Timeline Layout -->
                <div class="timeline-modern-layout">
                  <!-- Avatar + Name Section -->
                  <div class="timeline-left-section">
                    <ion-avatar class="timeline-avatar" *ngIf="event.avatar">
                      <img [src]="event.avatar" [alt]="event.name" referrerpolicy="no-referrer">
                    </ion-avatar>
                    
                    <div class="timeline-info">
                      <div class="timeline-name-row">
                        <h4 class="timeline-name" [class.cancelled-text]="event.isCancelled">
                          <span *ngIf="event.lesson?.isClass">{{ event.lesson.className || event.lesson.subject || 'Group Class' }}</span>
                          <span *ngIf="!event.lesson?.isClass">{{ event.name }}</span>
                        </h4>
                        <div class="timeline-trial-badge" *ngIf="event.isTrialLesson">
                          <ion-icon name="star"></ion-icon>
                          <span>TRIAL</span>
                        </div>
                        
                        <!-- Reschedule badges in timeline -->
                        <div class="timeline-reschedule-accepted-badge" 
                             *ngIf="event.rescheduleAccepted">
                          <ion-icon name="checkmark-circle"></ion-icon>
                          <span>RESCHEDULE REQUEST ACCEPTED</span>
                        </div>
                        
                        <div class="timeline-reschedule-sent-badge" 
                             *ngIf="!event.rescheduleAccepted && event.lesson?.status === 'pending_reschedule' && event.lesson?.rescheduleProposal?.status === 'pending' && event.isRescheduleProposer">
                          <ion-icon name="hourglass-outline"></ion-icon>
                          <span>RESCHEDULE REQUEST SENT</span>
                        </div>
                        
                        <div class="timeline-reschedule-badge" 
                             *ngIf="!event.rescheduleAccepted && event.lesson?.status === 'pending_reschedule' && event.lesson?.rescheduleProposal?.status === 'pending' && !event.isRescheduleProposer"
                             (click)="showRescheduleProposal(event.lesson); $event.stopPropagation()">
                          <ion-icon name="time"></ion-icon>
                          <span>NEW RESCHEDULE REQUEST</span>
                        </div>
                        
                        <div class="timeline-cancelled-badge" *ngIf="event.isCancelled">
                          <ion-icon name="close-circle"></ion-icon>
                          <span>Cancelled</span>
                        </div>
                      </div>
                      
                      <!-- Subject with flag -->
                      <p class="timeline-subject" [class.cancelled-text]="event.isCancelled">
                        <img 
                          *ngIf="!event.lesson?.isClass && flagService.getFlagPath(event.subject)" 
                          [src]="flagService.getFlagPath(event.subject)" 
                          class="flag-icon-timeline"
                          [alt]="event.subject + ' flag'"
                        />
                        <span *ngIf="event.lesson?.isClass">Group Class</span>
                        <span *ngIf="!event.lesson?.isClass">{{ event.subject }}</span>
                      </p>
                      
                      <!-- Date & Time row -->
                      <div class="timeline-datetime-row">
                        <span class="timeline-datetime-text" [class.is-today]="event.date === 'Today'">
                          <ion-icon name="calendar-outline"></ion-icon>
                          {{ event.date }}
                        </span>
                        <span class="timeline-datetime-text">
                          <ion-icon name="time-outline"></ion-icon>
                          {{ event.time }} ‚Äî {{ event.endTime }}
                        </span>
                      </div>
                      
                      <!-- Cancellation reason -->
                      <p class="cancellation-reason" *ngIf="event.isCancelled && event.cancelReason === 'minimum_not_met'">
                        <ion-icon name="information-circle-outline"></ion-icon>
                        Cancelled due to insufficient enrollment
                      </p>
                      
                      <!-- Class Attendees with GOING badge -->
                      <div class="class-status-section" *ngIf="event.lesson?.isClass && event.lesson?.attendees && !event.isCancelled">
                        <div class="going-badge">
                          <span class="going-text">GOING</span>
                          <div class="attendee-count-badge">
                            <ion-avatar class="mini-avatar">
                              <ion-icon name="person"></ion-icon>
                            </ion-avatar>
                            <span class="count-text">{{ event.lesson.attendees.length }}/{{ event.lesson.capacity }}</span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Join button for first timeline card (hide if cancelled) -->
                      <div class="timeline-join-button" *ngIf="first && event.lesson && !event.isCancelled">
                        <ion-button 
                          fill="solid"
                          size="small" 
                          class="join-btn-timeline"
                          [disabled]="!canJoinStudentLesson({ lesson: event.lesson })"
                          (click)="joinStudentLesson({ lesson: event.lesson }); $event.stopPropagation()">
                          <ion-icon name="call-outline" slot="start"></ion-icon>
                          {{ getStudentJoinLabel({ lesson: event.lesson }) }}
                        </ion-button>
                      </div>
                      
                      <!-- View Notes Button (Tutor Only) -->
                      <div class="timeline-notes-btn" *ngIf="isTutor() && event.lesson?.notes">
                        <ion-button 
                          fill="outline" 
                          size="small" 
                          color="primary"
                          (click)="openNotesModal(event.lesson); $event.stopPropagation()">
                          <ion-icon name="document-text-outline" slot="start"></ion-icon>
                          View Notes
                        </ion-button>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Menu Button -->
                  <div class="timeline-menu-section">
                    <!-- Mobile: click handler for action sheet -->
                    <ion-button 
                      *ngIf="event.lesson && isMobile && !isLessonInProgress(event.lesson)"
                      fill="clear" 
                      size="small" 
                      class="class-menu-btn timeline-menu-btn"
                      (click)="openMobileLessonMenu($event, event.lesson)">
                      <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
                    </ion-button>
                    
                    <!-- Desktop: trigger for popover -->
                    <ion-button 
                      *ngIf="event.lesson && !isMobile && !isLessonInProgress(event.lesson)"
                      [id]="'timeline-menu-' + event.lesson._id"
                      fill="clear" 
                      size="small" 
                      class="class-menu-btn timeline-menu-btn">
                      <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
                    </ion-button>
                    
                    <!-- Popover for desktop only -->
                    <ion-popover 
                      *ngIf="event.lesson && !isMobile && !isLessonInProgress(event.lesson)"
                      [trigger]="'timeline-menu-' + event.lesson._id"
                      triggerAction="click"
                      side="start"
                      alignment="start"
                      [dismissOnSelect]="true">
                      <ng-template>
                        <ion-content class="ion-padding">
                          <ion-list>
                            <ion-item [button]="true" (click)="inviteStudentToClass(event.lesson._id)" *ngIf="event.lesson?.isClass" [detail]="false">
                              <ion-icon name="person-add-outline" slot="start"></ion-icon>
                              <ion-label>Invite student</ion-label>
                            </ion-item>
                            <ion-item *ngIf="!hasLessonStarted(event.lesson)" [button]="true" (click)="event.lesson?.isClass ? rescheduleClass(event.lesson._id, event.lesson) : rescheduleLesson(event.lesson._id, event.lesson)" [detail]="false">
                              <ion-icon name="calendar-outline" slot="start"></ion-icon>
                              <ion-label>Reschedule</ion-label>
                            </ion-item>
                            <ion-item *ngIf="hasLessonStarted(event.lesson)" [button]="false" [detail]="false" class="reschedule-disabled" (click)="$event.preventDefault(); $event.stopPropagation(); $event.stopImmediatePropagation()">
                              <ion-icon name="calendar-outline" slot="start"></ion-icon>
                              <ion-label>Reschedule</ion-label>
                            </ion-item>
                            <ion-item [button]="true" (click)="event.lesson?.isClass ? cancelClass(event.lesson._id, event.lesson) : cancelLesson(event.lesson._id, event.lesson)" class="ion-text-danger" [detail]="false">
                              <ion-icon name="close-circle-outline" slot="start"></ion-icon>
                              <ion-label>Cancel lesson</ion-label>
                            </ion-item>
                          </ion-list>
                        </ion-content>
                      </ng-template>
                    </ion-popover>
                  </div>
                </div>
              </div>
            </div>
            <!-- Show More Button (Tutors only) -->
            <div class="timeline-show-more" *ngIf="hasMoreTimelineEvents() && isTutor()">
              <ion-button fill="clear" class="show-more-btn" (click)="navigateToTutorCalendar()">
                Show More
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
    
    <!-- No Lessons State (for students only - tutors have their own empty state above) -->
    <ion-card class="empty-state-card" *ngIf="!isLoadingLessons && lessons.length === 0 && isStudent()">
      <ion-card-content>
        <div class="empty-state">
          <ion-icon name="calendar-outline" class="empty-icon"></ion-icon>
          <h3>No upcoming lessons</h3>
          <p *ngIf="!isTutor()">Find a tutor to start learning</p>
          <p *ngIf="isTutor()">Your schedule is clear</p>
          
          <!-- Past Tutors Section (Student only, only if past tutors exist) - Now at top -->
          <div *ngIf="!isTutor() && pastTutors && pastTutors.length > 0" class="past-tutors-section">
            <p class="continue-working-text">Continue working with</p>
            <div class="stacked-avatars">
              <div 
                class="stacked-avatar" 
                *ngFor="let tutor of pastTutors.slice(0, 5); trackBy: trackByTutorId">
                <img 
                  *ngIf="tutor && tutor.picture"
                  [src]="tutor.picture" 
                  [alt]="tutor.name"
                  referrerpolicy="no-referrer">
                <ion-icon *ngIf="!tutor || !tutor.picture" name="person" style="font-size: 24px; color: #94a3b8;"></ion-icon>
              </div>
            </div>
            <p class="past-tutors-label">Or</p>
          </div>
          
          <!-- Find a Tutor Button - Now at bottom -->
          <ion-button 
            *ngIf="!isTutor()" 
            (click)="openSearchTutors()"
            class="find-tutor-btn">
            Find a Tutor
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- <div class="section-header-new" *ngIf="!isLoadingLessons">
      <h2>{{ isTutor() ? 'Enhance Your Lessons' : 'Next Up' }}</h2>
      <ion-button fill="clear" class="see-all-btn" routerLink="/tabs/home/lessons">See All</ion-button>
    </div> -->

     <!-- Category Tabs (moved below lessons for mobile student view) -->
     <div class="category-tabs" *ngIf="currentUser?.userType === 'student' && !isLoadingLessons">
      <div class="tab-item">
        <div class="tab-icon kids">
          <ion-icon name="create"></ion-icon>
        </div>
        <span>Learning Material</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon hospital">
          <ion-icon name="briefcase"></ion-icon>
        </div>
        <span>Forum</span>
      </div>
      <div class="tab-item" (click)="navigateToExplore()">
        <div class="tab-icon consultant">
          <ion-icon name="people"></ion-icon>
        </div>
        <span>Public Classes</span>      
      </div>
    </div>

    <!-- Category Tabs (moved below lessons for mobile student view) -->
    <div class="category-tabs" *ngIf="!isLoadingLessons && isTutor()">
      <div class="tab-item" (click)="navigateToExplore()">
        <div class="tab-icon consultant">
          <ion-icon name="people"></ion-icon>
        </div>
        <span>Public Classes</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon kids">
          <ion-icon name="create"></ion-icon>
        </div>
        <span>Create Material</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon hospital">
          <ion-icon name="reader-outline"></ion-icon>
        </div>
        <span>Forum</span>
      </div>
    </div>

  </div>

  <!-- Inline Confirm Reschedule Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isConfirmRescheduleModalOpen" 
    (didDismiss)="onConfirmRescheduleModalDismiss($event)"
    cssClass="confirm-action-modal">
    <ng-template>
      <app-confirm-action-modal
        *ngIf="confirmRescheduleModalData"
        [title]="confirmRescheduleModalData.title"
        [message]="confirmRescheduleModalData.message"
        [notificationMessage]="confirmRescheduleModalData.notificationMessage"
        [confirmText]="confirmRescheduleModalData.confirmText"
        [cancelText]="confirmRescheduleModalData.cancelText"
        [confirmColor]="confirmRescheduleModalData.confirmColor"
        [icon]="confirmRescheduleModalData.icon"
        [iconColor]="confirmRescheduleModalData.iconColor"
        [participantName]="confirmRescheduleModalData.participantName"
        [participantAvatar]="confirmRescheduleModalData.participantAvatar">
      </app-confirm-action-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Confirm Cancel Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isConfirmCancelModalOpen" 
    (didDismiss)="onConfirmCancelModalDismiss($event)"
    cssClass="confirm-action-modal">
    <ng-template>
      <app-confirm-action-modal
        *ngIf="confirmCancelModalData"
        [title]="confirmCancelModalData.title"
        [message]="confirmCancelModalData.message"
        [notificationMessage]="confirmCancelModalData.notificationMessage"
        [confirmText]="confirmCancelModalData.confirmText"
        [cancelText]="confirmCancelModalData.cancelText"
        [confirmColor]="confirmCancelModalData.confirmColor"
        [icon]="confirmCancelModalData.icon"
        [iconColor]="confirmCancelModalData.iconColor"
        [participantName]="confirmCancelModalData.participantName"
        [participantAvatar]="confirmCancelModalData.participantAvatar">
      </app-confirm-action-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Reschedule Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isRescheduleModalOpen" 
    (didDismiss)="onRescheduleModalDismiss($event)"
    cssClass="reschedule-lesson-modal">
    <ng-template>
      <app-reschedule-lesson-modal
        *ngIf="rescheduleModalData"
        [lessonId]="rescheduleModalData.lessonId"
        [lesson]="rescheduleModalData.lesson"
        [participantId]="rescheduleModalData.participantId"
        [participantName]="rescheduleModalData.participantName"
        [participantAvatar]="rescheduleModalData.participantAvatar"
        [currentUserId]="rescheduleModalData.currentUserId"
        [isTutor]="rescheduleModalData.isTutor"
        [showBackButton]="rescheduleModalData.showBackButton">
      </app-reschedule-lesson-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Reschedule Proposal Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isRescheduleProposalModalOpen" 
    (didDismiss)="onRescheduleProposalModalDismiss($event)"
    cssClass="reschedule-proposal-modal">
    <ng-template>
      <app-reschedule-proposal-modal
        *ngIf="rescheduleProposalModalData"
        [lessonId]="rescheduleProposalModalData.lessonId"
        [lesson]="rescheduleProposalModalData.lesson"
        [proposal]="rescheduleProposalModalData.proposal"
        [participantName]="rescheduleProposalModalData.participantName"
        [participantAvatar]="rescheduleProposalModalData.participantAvatar"
        [proposedDate]="rescheduleProposalModalData.proposedDate"
        [proposedTime]="rescheduleProposalModalData.proposedTime"
        [originalDate]="rescheduleProposalModalData.originalDate"
        [originalTime]="rescheduleProposalModalData.originalTime">
      </app-reschedule-proposal-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Class Invitation Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isClassInvitationModalOpen" 
    (didDismiss)="onClassInvitationModalDismiss($event)"
    cssClass="class-invitation-modal">
    <ng-template>
      <app-class-invitation-modal
        *ngIf="classInvitationModalData"
        [classId]="classInvitationModalData.classId"
        [notification]="classInvitationModalData.notification">
      </app-class-invitation-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Invite Student Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isInviteStudentModalOpen" 
    (didDismiss)="onInviteStudentModalDismiss($event)"
    cssClass="invite-student-modal">
    <ng-template>
      <app-invite-student-modal
        *ngIf="inviteStudentModalProps"
        [className]="inviteStudentModalProps.className"
        [classId]="inviteStudentModalProps.classId"
        [classData]="inviteStudentModalProps.classData">
      </app-invite-student-modal>
    </ng-template>
  </ion-modal>

  <!-- Inline Invitations List Modal (declarative, no programmatic creation) -->
  <ion-modal 
    [isOpen]="isInvitationsListModalOpen" 
    (didDismiss)="onInvitationsListModalDismiss($event)"
    cssClass="invitations-list-modal">
    <ng-template>
      <app-invitations-list-modal
        [invitations]="pendingClassInvitations">
      </app-invitations-list-modal>
    </ng-template>
  </ion-modal>

</ion-content>