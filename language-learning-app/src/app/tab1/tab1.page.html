<!-- home.page.html -->
<ion-header class="custom-header" *ngIf="isMobile">
  <ion-toolbar>
    <ion-buttons slot="start">
      <div class="app-icon-container" (click)="router.navigate(['/tabs/home'])">
        <img src="assets/app-icon.png" alt="Speak Freely" class="app-icon">
      </div>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="notification-btn" (click)="openNotifications()">
        <ion-icon name="notifications-outline"></ion-icon>
        <span class="notification-dot" *ngIf="hasNotifications"></span>
      </ion-button>
      <ion-avatar class="header-avatar" *ngIf="currentUser">
        <img *ngIf="currentUser.picture" [src]="currentUser.picture" alt="User Avatar" referrerpolicy="no-referrer" (error)="onAvatarError($event)" (load)="onAvatarLoad($event)">
        <div *ngIf="!currentUser.picture" class="avatar-initial">{{ userInitial }}</div>
      </ion-avatar>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="content-wrapper">
    
    <!-- Student Search Bar -->
    <div class="search-container" *ngIf="currentUser?.userType === 'student'" (click)="openSearchTutors()">
      <ion-icon name="search-outline" class="search-icon"></ion-icon>
      <input type="text" placeholder="Search for a tutor" readonly class="search-input">
    </div>

    <!-- Tutor Insights Panel -->
    <div class="insights-panel" *ngIf="isTutor()">
      <div class="insight-metric">
        <div class="insight-icon students">
          <ion-icon name="people"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ totalStudents || 0 }}</div>
          <div class="insight-label">Students</div>
        </div>
      </div>
      <div class="insight-divider"></div>
      <div class="insight-metric">
        <div class="insight-icon lessons">
          <ion-icon name="videocam"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ lessonsThisWeek || 0 }}</div>
          <div class="insight-label">This Week</div>
        </div>
      </div>
      <div class="insight-divider"></div>
      <div class="insight-metric">
        <div class="insight-icon rating">
          <ion-icon name="star"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ tutorRating || '4.8' }}</div>
          <div class="insight-label">Rating</div>
        </div>
      </div>
      <!-- <div class="insight-divider"></div>
      <div class="insight-metric" (click)="router.navigate(['/tabs/messages'])" style="cursor: pointer;">
        <div class="insight-icon messages">
          <ion-icon name="chatbubbles"></ion-icon>
          <span class="message-badge" *ngIf="unreadMessages > 0">{{ unreadMessages }}</span>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ unreadMessages || 0 }}</div>
          <div class="insight-label">Messages</div>
        </div>
      </div> -->
    </div>
    <!-- Upcoming Schedule Section -->
    <div class="section-header-new">
      <h2>{{ isTutor() ? 'Upcoming Class' : 'Upcoming Lessons' }}</h2>
      <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
    </div>

    <!-- <div class="week-navigation" *ngIf="isTutor()">
      <ion-button fill="clear" size="small" (click)="navigateWeek('prev')">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>
      <div class="week-display">
        <span class="week-range">{{ weekRangeLabel }}</span>
        <ion-button fill="clear" size="small" (click)="goToToday()" [disabled]="isCurrentWeek()" class="today-btn">Today</ion-button>
      </div>
      <ion-button fill="clear" size="small" (click)="navigateWeek('next')">
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </ion-button>
    </div> -->

    <!-- Date Strip -->
    <!-- <div class="date-strip-container" *ngIf="isTutor()">
      <div class="date-strip">
        <div 
          class="date-pill" 
          *ngFor="let d of dateStrip" 
          [class.active]="d.isToday" 
          [class.selected]="selectedDate && d.date.toDateString() === selectedDate.toDateString()"
          (click)="selectDate(d.date)">
          <div class="weekday">{{ d.label }}</div>
          <div class="daynum">{{ d.dayNum }}</div>
        </div>
      </div>
    </div> -->

    <!-- Next Class Info (Text Only) -->
    <div class="next-class-text-section" *ngIf="isTutor() && getFirstLessonForSelectedDate()">
      <!-- Hidden reference to countdownTick to trigger change detection -->
      <span style="display: none;">{{ countdownTick }}</span>
      <div class="next-class-text-content">
        <div class="next-class-header">
          <span class="next-class-label">
            <!-- Show "NOW" if lesson is in progress -->
            <span *ngIf="getFirstLessonForSelectedDate()?.isInProgress">NOW</span>
            <!-- Show "NEXT CLASS" if this is the actual next class and not in progress -->
            <span *ngIf="!getFirstLessonForSelectedDate()?.isInProgress && getFirstLessonForSelectedDate()?.isNextClass">NEXT CLASS</span>
            <!-- Otherwise show the date tag -->
            <span *ngIf="!getFirstLessonForSelectedDate()?.isInProgress && !getFirstLessonForSelectedDate()?.isNextClass">
              {{ getFirstLessonForSelectedDate()?.dateTag }}
            </span>
          </span>
        </div>
        <div class="next-class-details">
          <div class="next-class-student-row" *ngIf="getFirstLessonForSelectedDate() as nextClass">
            <ion-avatar class="next-class-student-avatar">
              <img
                [src]="getOtherParticipantAvatar(nextClass.lesson)"
                [alt]="formatStudentDisplayName(nextClass)"
                referrerpolicy="no-referrer"
              />
            </ion-avatar>
            <div class="next-class-student-info">
              <div class="next-class-student-name">
                {{ formatStudentDisplayName(nextClass) }}
              </div>
            </div>
          </div>
          <h3 class="next-class-name">{{ getFirstLessonForSelectedDate()?.subject }}</h3>
          <p class="next-class-subject">{{ getFirstLessonForSelectedDate()?.subject }}</p>
          <p class="next-class-time" *ngIf="getFirstLessonForSelectedDate()?.lessonTime">
            <ion-icon name="time-outline"></ion-icon>
            {{ getFirstLessonForSelectedDate()?.lessonTime }}
          </p>
        </div>
        <div class="next-class-actions" *ngIf="getFirstLessonForSelectedDate()?.lessonId">
          <ion-button 
            fill="solid"
            size="medium" 
            class="join-btn-text"
            [class.is-next-class]="getFirstLessonForSelectedDate()?.isNextClass"
            [disabled]="!canJoinStudentLesson(getFirstLessonForSelectedDate())"
            (click)="joinStudentLesson(getFirstLessonForSelectedDate())">
            <ion-icon name="call-outline" slot="start"></ion-icon>
            {{ getStudentJoinLabel(getFirstLessonForSelectedDate()) }}
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Empty State: No Classes Today -->
    <div class="next-class-empty-state" *ngIf="isTutor() && !getFirstLessonForSelectedDate()">
      <div class="empty-state-content">
        <ion-icon name="calendar-outline" class="empty-state-icon"></ion-icon>
        <h3 class="empty-state-title">No class today</h3>
        
        <!-- Show next lesson info if available -->
        <p class="empty-state-subtitle" *ngIf="getNextLessonInfo()">
          Your next lesson is <strong>{{ getNextLessonInfo()?.dayText }}</strong> at <strong>{{ getNextLessonInfo()?.time }}</strong>
        </p>
        
        <!-- Fallback if no future lessons at all -->
        <p class="empty-state-subtitle" *ngIf="!getNextLessonInfo()">
          You don't have any lessons scheduled yet.
        </p>
        
        <ion-button 
          fill="outline" 
          size="medium" 
          class="empty-state-cta"
          routerLink="/tabs/tutor-calendar">
          View Calendar
          <ion-icon name="arrow-forward-outline" slot="end"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Students/Tutors Grid (for selected date, excluding next class) -->
    <!-- Hidden: Only showing Next Class card now -->
    <div class="tutors-section" *ngIf="false && isTutor()">
      <div class="tutors-grid fade-in" *ngIf="getOtherStudentsForDate().length > 0">
        <div class="tutor-card" *ngFor="let student of getOtherStudentsForDate()">
          <div class="tutor-card-content">
            <ion-avatar class="tutor-avatar">
              <img [src]="student.profilePicture || student.picture || 'assets/avatar.png'" alt="{{ student.name }}" referrerpolicy="no-referrer">
              <div class="presence-indicator" *ngIf="hasParticipantJoinedById(student.lessonId)">
                <ion-icon name="checkmark-circle" class="presence-icon"></ion-icon>
              </div>
            </ion-avatar>
            <div class="rating-badge" *ngIf="!student.isClass">
              <ion-icon name="star"></ion-icon>
              <span>{{ student.rating || '4.5' }}</span>
            </div>
          </div>
          <div class="tutor-info">
            <h3>{{ student.name }}</h3>
            <p class="subject">{{ student.subject }}</p>
            <p class="lesson-time" *ngIf="student.lessonTime">
              <ion-icon name="time-outline"></ion-icon>
              {{ student.lessonTime }}
            </p>
            <!-- Presence indicator text for student card -->
            <div class="presence-text" *ngIf="hasParticipantJoinedById(student.lessonId)">
              <ion-icon name="person-circle-outline" class="presence-icon-small"></ion-icon>
              <span>{{ getPresenceDataById(student.lessonId)?.participantName || 'Student' }} has joined lesson</span>
            </div>
            <div class="student-card-actions" *ngIf="student.lessonId">
              <ion-button fill="clear" size="small" class="action-icon-btn message">
                <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
              </ion-button>
              <ion-button 
                fill="solid"
                size="small" 
                class="join-btn-small" 
                [class.is-next-class]="student.isNextClass"
                [disabled]="!canJoinStudentLesson(student)"
                (click)="joinStudentLesson(student)">
                <ion-icon name="call-outline" slot="start"></ion-icon>
                {{ getStudentJoinLabel(student) }}
              </ion-button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Coming Up Next Timeline (for tutors) -->
    <div class="timeline-section" *ngIf="isTutor() && getTimelineEvents().length > 0">
      <div class="section-header-new">
        <h2>Coming Up Next</h2>
        <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
      </div>
      
      <ion-card class="timeline-card">
        <ion-card-content>
          <div class="timeline-container">
            <div class="timeline-item" *ngFor="let event of getTimelineEvents(); let last = last; let first = first" [class.last]="last" [class.first]="first">
              <div class="timeline-dot"></div>
              <div class="timeline-line" *ngIf="!last"></div>
              <div class="timeline-content" [class.has-join-button]="first && event.lesson" (click)="!first || !event.lesson ? navigateToLesson(event.lesson) : null">
                <div class="timeline-header">
                  <div class="timeline-date-group">
                    <span class="timeline-time">{{ event.time }}</span>
                    <span class="timeline-end-time" *ngIf="event.endTime">{{ event.endTime }}</span>
                    <span class="timeline-date" [class.is-today]="event.date === 'Today'">{{ event.date }}</span>
                  </div>
                  <ion-avatar class="timeline-avatar" *ngIf="event.avatar">
                    <img [src]="event.avatar" [alt]="event.name" referrerpolicy="no-referrer">
                  </ion-avatar>
                </div>
                <div class="timeline-details">
                  <h4 class="timeline-name">{{ event.name }}</h4>
                  <p class="timeline-subject">{{ event.subject }}</p>
                </div>
                <!-- Join button for first timeline card -->
                <div class="timeline-join-button" *ngIf="first && event.lesson">
                  <ion-button 
                    fill="solid"
                    size="small" 
                    class="join-btn-timeline"
                    [disabled]="!canJoinStudentLesson({ lesson: event.lesson })"
                    (click)="joinStudentLesson({ lesson: event.lesson }); $event.stopPropagation()">
                    <ion-icon name="call-outline" slot="start"></ion-icon>
                    {{ getStudentJoinLabel({ lesson: event.lesson }) }}
                  </ion-button>
                </div>
              </div>
            </div>
            <!-- Show More Button -->
            <div class="timeline-show-more" *ngIf="hasMoreTimelineEvents()">
              <ion-button fill="clear" class="show-more-btn" (click)="navigateToTutorCalendar()">
                Show More
                <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
              </ion-button>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Featured Tutors (for students) -->
    <div class="tutors-grid" *ngIf="!isTutor()">
      <div class="tutor-card" *ngFor="let tutor of featuredTutors">
        <div class="tutor-card-content">
          <ion-avatar class="tutor-avatar">
            <img [src]="tutor.profilePicture || 'assets/avatar.png'" alt="{{ tutor.name }}" referrerpolicy="no-referrer">
          </ion-avatar>
          <div class="rating-badge">
            <ion-icon name="star"></ion-icon>
            <span>{{ tutor.rating }}</span>
          </div>
        </div>
        <div class="tutor-info">
          <h3>{{ tutor.name }}</h3>
          <p>{{ tutor.specialty }}</p>
        </div>
      </div>
    </div>

    <!-- Upcoming Lesson Card -->
    <ion-card class="upcoming-lesson-card" *ngIf="upcomingLesson && !isTutor()">
      <ion-card-content>
        <div class="upcoming-lesson-row">
          <ion-avatar class="lesson-avatar-large">
            <img [src]="upcomingLesson ? getPresenceAvatar(upcomingLesson) : 'assets/avatar.png'" alt="Avatar" referrerpolicy="no-referrer" />
            <div class="presence-indicator" *ngIf="hasParticipantJoined(upcomingLesson)">
              <ion-icon name="checkmark-circle" class="presence-icon"></ion-icon>
            </div>
          </ion-avatar>
          <div class="lesson-details">
            <h3>{{ upcomingLesson ? getOtherParticipantName(upcomingLesson) : '' }}</h3>
            <p class="lesson-specialty">{{ upcomingLesson ? getOtherParticipantSpecialty(upcomingLesson) : '' }}</p>
            <div class="lesson-datetime">
              <ion-icon name="calendar-outline"></ion-icon>
              <span>{{ upcomingLesson ? formatLessonTime(upcomingLesson) : '' }}</span>
              <span class="status-badge in-progress" *ngIf="upcomingLesson && isLessonInProgress(upcomingLesson)">In progress</span>
            </div>
            <div class="presence-text" *ngIf="hasParticipantJoined(upcomingLesson)">
              <ion-icon name="person-circle-outline" class="presence-icon-small"></ion-icon>
              <span *ngIf="isTutor()">{{ getPresenceData(upcomingLesson)?.participantName || 'Student' }} has joined lesson</span>
              <span *ngIf="!isTutor()">{{ getPresenceData(upcomingLesson)?.participantName || 'Tutor' }} has joined lesson</span>
            </div>
          </div>
          <div class="lesson-actions">
            <ion-button fill="clear" class="action-icon-btn message">
              <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
            </ion-button>
            <ion-button class="join-btn" color="success" [disabled]="!canJoinUpcoming()" (click)="joinUpcomingLesson()">
              <ion-icon name="call-outline" slot="start"></ion-icon>
              {{ upcomingJoinLabel() }}
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- No Lessons State -->
    <ion-card class="empty-state-card" *ngIf="!isLoadingLessons && getUpcomingLessons().length === 0 && !isTutor()">
      <ion-card-content>
        <div class="empty-state">
          <ion-icon name="calendar-outline" class="empty-icon"></ion-icon>
          <h3>No upcoming lessons</h3>
          <p *ngIf="!isTutor()">Find a tutor to start learning</p>
          <p *ngIf="isTutor()">Your schedule is clear</p>
          
          <!-- Past Tutors Section (Student only, only if past tutors exist) - Now at top -->
          <div *ngIf="!isTutor() && pastTutors && pastTutors.length > 0" class="past-tutors-section">
            <p class="continue-working-text">Continue working with</p>
            <div class="stacked-avatars">
              <div 
                class="stacked-avatar" 
                *ngFor="let tutor of pastTutors.slice(0, 5); trackBy: trackByTutorId">
                <img 
                  [src]="tutor.picture || 'assets/avatar.png'" 
                  [alt]="tutor.name"
                  referrerpolicy="no-referrer"
                  (error)="$event.target.src='assets/avatar.png'">
              </div>
            </div>
            <p class="past-tutors-label">Or</p>
          </div>
          
          <!-- Find a Tutor Button - Now at bottom -->
          <ion-button 
            *ngIf="!isTutor()" 
            (click)="openSearchTutors()"
            class="find-tutor-btn">
            Find a Tutor
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

    <div class="section-header-new">
      <h2>{{ isTutor() ? 'Enhance Your Lessons' : 'Upcoming Lessons' }}</h2>
      <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
    </div>

    <!-- Category Tabs (moved below lessons for mobile student view) -->
    <div class="category-tabs" *ngIf="isTutor()">
      <div class="tab-item">
        <div class="tab-icon kids">
          <ion-icon name="create"></ion-icon>
        </div>
        <span>Create Material</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon hospital">
          <ion-icon name="briefcase"></ion-icon>
        </div>
        <span>Business</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon consultant">
          <ion-icon name="people"></ion-icon>
        </div>
        <span>Conversation</span>
      </div>
    </div>

  </div>
</ion-content>