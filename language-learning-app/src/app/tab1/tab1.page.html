<!-- home.page.html -->
<ion-header class="custom-header" *ngIf="isMobile">
  <ion-toolbar>
    <ion-buttons slot="start">
      <div class="app-icon-container" (click)="router.navigate(['/tabs/home'])">
        <img src="assets/app-icon.png" alt="Speak Freely" class="app-icon">
      </div>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="notification-btn" (click)="openNotifications()">
        <ion-icon name="notifications-outline"></ion-icon>
        <span class="notification-dot" *ngIf="hasNotifications"></span>
      </ion-button>
      <ion-avatar class="header-avatar">
        <img [src]="currentUserPicture" alt="User Avatar">
      </ion-avatar>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="content-wrapper">
    
    <!-- Student Search Bar -->
    <div class="search-container" *ngIf="currentUser?.userType === 'student'" (click)="openSearchTutors()">
      <ion-icon name="search-outline" class="search-icon"></ion-icon>
      <input type="text" placeholder="Search for a tutor" readonly class="search-input">
    </div>

    <!-- Tutor Insights Panel -->
    <div class="insights-panel" *ngIf="isTutor()">
      <div class="insight-metric">
        <div class="insight-icon students">
          <ion-icon name="people"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ totalStudents || 0 }}</div>
          <div class="insight-label">Students</div>
        </div>
      </div>
      <div class="insight-divider"></div>
      <div class="insight-metric">
        <div class="insight-icon lessons">
          <ion-icon name="videocam"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ lessonsThisWeek || 0 }}</div>
          <div class="insight-label">This Week</div>
        </div>
      </div>
      <div class="insight-divider"></div>
      <div class="insight-metric">
        <div class="insight-icon rating">
          <ion-icon name="star"></ion-icon>
        </div>
        <div class="insight-text">
          <div class="insight-value">{{ tutorRating || '4.8' }}</div>
          <div class="insight-label">Rating</div>
        </div>
      </div>
    </div>
    <!-- Upcoming Schedule Section -->
    <div class="section-header-new">
      <h2>{{ isTutor() ? 'Upcoming Classes' : 'Upcoming Lessons' }}</h2>
      <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
    </div>

    <div class="week-navigation" *ngIf="isTutor()">
      <ion-button fill="clear" size="small" (click)="navigateWeek('prev')">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>
      <div class="week-display">
        <span class="week-range">{{ weekRangeLabel }}</span>
        <ion-button fill="clear" size="small" (click)="goToToday()" [disabled]="isCurrentWeek()" class="today-btn">Today</ion-button>
      </div>
      <ion-button fill="clear" size="small" (click)="navigateWeek('next')">
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </ion-button>
    </div>

    <!-- Date Strip -->
    <div class="date-strip-container" *ngIf="isTutor()">
      <div class="date-strip">
        <div 
          class="date-pill" 
          *ngFor="let d of dateStrip" 
          [class.active]="d.isToday" 
          [class.selected]="selectedDate && d.date.toDateString() === selectedDate.toDateString()"
          (click)="selectDate(d.date)">
          <div class="weekday">{{ d.label }}</div>
          <div class="daynum">{{ d.dayNum }}</div>
        </div>
      </div>
    </div>

    <!-- Students/Tutors Grid (for selected date) -->
    <div class="tutors-section" *ngIf="isTutor()">
      <div class="tutors-grid fade-in" *ngIf="getStudentsForDate().length > 0; else noStudentsForDate">
        <div class="tutor-card" *ngFor="let student of getStudentsForDate()">
          <div class="next-class-badge" *ngIf="student.isNextClass">
            <span>NEXT CLASS</span>
          </div>
          <div class="tutor-card-content">
            <ion-avatar class="tutor-avatar">
              <img [src]="student.profilePicture || student.picture || 'assets/avatar.png'" alt="{{ student.name }}">
              <div class="presence-indicator" *ngIf="hasParticipantJoinedById(student.lessonId)">
                <ion-icon name="checkmark-circle" class="presence-icon"></ion-icon>
              </div>
            </ion-avatar>
            <div class="rating-badge">
              <ion-icon name="star"></ion-icon>
              <span>{{ student.rating || '4.5' }}</span>
            </div>
          </div>
          <div class="tutor-info">
            <h3>{{ student.name }}</h3>
            <p class="subject">{{ student.subject }}</p>
            <p class="lesson-time" *ngIf="student.lessonTime">
              <ion-icon name="time-outline"></ion-icon>
              {{ student.lessonTime }}
            </p>
            <!-- Presence indicator text for student card -->
            <div class="presence-text" *ngIf="hasParticipantJoinedById(student.lessonId)">
              <ion-icon name="person-circle-outline" class="presence-icon-small"></ion-icon>
              <span>{{ getPresenceDataById(student.lessonId)?.participantName || 'Student' }} has joined lesson</span>
            </div>
            <div class="student-card-actions" *ngIf="student.lessonId">
              <ion-button fill="clear" size="small" class="action-icon-btn message">
                <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
              </ion-button>
              <ion-button 
                size="small" 
                class="join-btn-small" 
                [class.is-next-class]="student.isNextClass"
                [class.not-next-class]="!student.isNextClass"
                [disabled]="!canJoinStudentLesson(student)"
                (click)="joinStudentLesson(student)">
                <ion-icon name="call-outline" slot="start"></ion-icon>
                {{ getStudentJoinLabel(student) }}
              </ion-button>
            </div>
          </div>
        </div>
      </div>
      <ng-template #noStudentsForDate>
        <ion-card class="empty-inline-card fade-in">
          <ion-card-content>
            <div class="empty-inline">
              <ion-icon name="calendar-outline" class="empty-inline-icon" [class.hidden]="availabilityHeadline"></ion-icon>
              <div class="empty-inline-text">
                <h3>No lessons for <span>{{ isToday(selectedDate) ? 'Today' : (selectedDate | date:'MMM d, y') }}</span></h3>
                  <ng-container *ngIf="availabilityHeadline; else defaultNoLessonsCta">
                    <div class="availability-feedback">
                      <div class="availability-summary">
                        <div class="availability-icon">
                          <ion-icon name="calendar-outline"></ion-icon>
                        </div>
                        <div class="availability-text">
                          <p class="availability-headline">{{ availabilityHeadline }}</p>
                          <p class="availability-detail" *ngIf="availabilityDetail">{{ availabilityDetail }}</p>
                        </div>
                      </div>
                      <ion-button fill="outline" size="small" class="availability-cta" (click)="openAvailabilitySetup()">
                        <ion-icon slot="start" name="settings-outline"></ion-icon>
                        Set up availability
                      </ion-button>
                    </div>
                  </ng-container>
                  <ng-template #defaultNoLessonsCta>
                    <p>Pick another date, or invite a student.</p>
                  </ng-template>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </ng-template>
    </div>

    <!-- Featured Tutors (for students) -->
    <div class="tutors-grid" *ngIf="!isTutor()">
      <div class="tutor-card" *ngFor="let tutor of featuredTutors">
        <div class="tutor-card-content">
          <ion-avatar class="tutor-avatar">
            <img [src]="tutor.profilePicture || 'assets/avatar.png'" alt="{{ tutor.name }}">
          </ion-avatar>
          <div class="rating-badge">
            <ion-icon name="star"></ion-icon>
            <span>{{ tutor.rating }}</span>
          </div>
        </div>
        <div class="tutor-info">
          <h3>{{ tutor.name }}</h3>
          <p>{{ tutor.specialty }}</p>
        </div>
      </div>
    </div>

    <!-- Upcoming Lesson Card -->
    <ion-card class="upcoming-lesson-card" *ngIf="upcomingLesson">
      <ion-card-content>
        <div class="upcoming-lesson-row">
          <ion-avatar class="lesson-avatar-large">
            <img [src]="upcomingLesson ? getPresenceAvatar(upcomingLesson) : 'assets/avatar.png'" alt="Avatar" />
            <div class="presence-indicator" *ngIf="hasParticipantJoined(upcomingLesson)">
              <ion-icon name="checkmark-circle" class="presence-icon"></ion-icon>
            </div>
          </ion-avatar>
          <div class="lesson-details">
            <h3>{{ upcomingLesson ? getOtherParticipantName(upcomingLesson) : '' }}</h3>
            <p class="lesson-specialty">{{ upcomingLesson ? getOtherParticipantSpecialty(upcomingLesson) : '' }}</p>
            <div class="lesson-datetime">
              <ion-icon name="calendar-outline"></ion-icon>
              <span>{{ upcomingLesson ? formatLessonTime(upcomingLesson) : '' }}</span>
              <span class="status-badge in-progress" *ngIf="upcomingLesson && isLessonInProgress(upcomingLesson)">In progress</span>
            </div>
            <!-- Presence indicator text -->
            <div class="presence-text" *ngIf="hasParticipantJoined(upcomingLesson)">
              <ion-icon name="person-circle-outline" class="presence-icon-small"></ion-icon>
              <span *ngIf="isTutor()">{{ getPresenceData(upcomingLesson)?.participantName || 'Student' }} has joined lesson</span>
              <span *ngIf="!isTutor()">{{ getPresenceData(upcomingLesson)?.participantName || 'Tutor' }} has joined lesson</span>
            </div>
          </div>
          <div class="lesson-actions">
            <ion-button fill="clear" class="action-icon-btn message">
              <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
            </ion-button>
            <ion-button class="join-btn" color="success" [disabled]="!canJoinUpcoming()" (click)="joinUpcomingLesson()">
              <ion-icon name="call-outline" slot="start"></ion-icon>
              {{ upcomingJoinLabel() }}
            </ion-button>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Other Upcoming Lessons -->
    <ng-container *ngIf="!isLoadingLessons">
      <div class="lessons-list-new" *ngIf="getUpcomingLessons().length > 1">
        <ion-card class="lesson-card-compact" *ngFor="let lesson of getUpcomingLessons().slice(1, 3)">
          <ion-card-content>
            <div class="lesson-row-compact">
              <ion-avatar class="lesson-avatar-small">
                <img [src]="getOtherParticipantAvatar(lesson) || 'assets/avatar.png'" alt="Avatar" />
              </ion-avatar>
              <div class="lesson-meta-compact">
                <h4>{{ getOtherParticipantName(lesson) }}</h4>
                <p>{{ getOtherParticipantSpecialty(lesson) }}</p>
                <div class="lesson-time-compact">
                  <ion-icon name="time-outline"></ion-icon>
                  <span>{{ formatLessonTime(lesson) }}</span>
                </div>
              </div>
              <div class="lesson-actions-compact">
                <ion-button fill="clear" size="small" class="action-icon-btn message">
                  <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
                </ion-button>
                <ion-button size="small" class="action-icon-btn call">
                  <ion-icon name="call"></ion-icon>
                </ion-button>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- No Lessons State -->
      <ion-card class="empty-state-card" *ngIf="!isLoadingLessons && getUpcomingLessons().length === 0 && !isTutor()">
        <ion-card-content>
          <div class="empty-state">
            <ion-icon name="calendar-outline" class="empty-icon"></ion-icon>
            <h3>No upcoming lessons</h3>
            <p *ngIf="!isTutor()">Find a tutor to start learning</p>
            <p *ngIf="isTutor()">Your schedule is clear</p>
            
            <!-- Past Tutors Section (Student only, only if past tutors exist) - Now at top -->
            <div *ngIf="!isTutor() && pastTutors && pastTutors.length > 0" class="past-tutors-section">
              <p class="continue-working-text">Continue working with</p>
              <div class="stacked-avatars">
                <div 
                  class="stacked-avatar" 
                  *ngFor="let tutor of pastTutors.slice(0, 5); trackBy: trackByTutorId">
                  <img 
                    [src]="tutor.picture || 'assets/avatar.png'" 
                    [alt]="tutor.name"
                    (error)="$event.target.src='assets/avatar.png'">
                </div>
              </div>
              <p class="past-tutors-label">Or</p>
            </div>
            
            <!-- Find a Tutor Button - Now at bottom -->
            <ion-button 
              *ngIf="!isTutor()" 
              (click)="openSearchTutors()"
              class="find-tutor-btn">
              Find a Tutor
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </ng-container>

    <div class="section-header-new">
      <h2>{{ isTutor() ? 'Enhance Your Lessons' : 'Upcoming Lessons' }}</h2>
      <ion-button fill="clear" class="see-all-btn" routerLink="/lessons">See All</ion-button>
    </div>

    <!-- Category Tabs (moved below lessons for mobile student view) -->
    <div class="category-tabs" *ngIf="isTutor()">
      <div class="tab-item">
        <div class="tab-icon kids">
          <ion-icon name="create"></ion-icon>
        </div>
        <span>Create Material</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon hospital">
          <ion-icon name="briefcase"></ion-icon>
        </div>
        <span>Business</span>
      </div>
      <div class="tab-item">
        <div class="tab-icon consultant">
          <ion-icon name="people"></ion-icon>
        </div>
        <span>Conversation</span>
      </div>
    </div>

  </div>
</ion-content>