<ion-header [translucent]="true">
  <ion-toolbar>
    <div class="header-content">
      <ion-title>Video Class</ion-title>
      <div class="trial-badge" *ngIf="isTrialLesson">
        <ion-icon name="star"></ion-icon>
        <span>Trial</span>
      </div>
    </div>
    <ion-buttons slot="end">
      <ion-button (click)="endCall()" color="danger">
        <ion-icon name="call-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="video-call-wrapper" [class.whiteboard-open]="showWhiteboard" [class.chat-open]="showChat">
    <!-- Main Content Area (above controls) -->
    <div class="main-content-area">
    <!-- Whiteboard Panel (Left Side) -->
    <div class="whiteboard-panel" *ngIf="showWhiteboard">
      <div class="whiteboard-fixed">
        <div class="whiteboard-header-fixed">
          <div class="header-left">
            <h3>Whiteboard</h3>
            
            <!-- Compact toolbar in header -->
            <div class="header-toolbar">
              <!-- Tool Selection -->
              <button class="tool-btn" [class.active]="currentTool === 'draw'" (click)="setTool('draw')" title="Draw">
                <ion-icon name="brush-outline"></ion-icon>
              </button>
              <button class="tool-btn" [class.active]="currentTool === 'text'" (click)="setTool('text')" title="Text Tool: Click to add text, Enter to finish, Shift+Enter for new line">
                <ion-icon name="text-outline"></ion-icon>
              </button>
              <button class="tool-btn" [class.active]="currentTool === 'move'" (click)="setTool('move')" title="Move">
                <ion-icon name="move-outline"></ion-icon>
              </button>
              
              <div class="tool-divider"></div>
              
              <!-- Brush Size (for draw tool) -->
              <div class="brush-size-mini" *ngIf="currentTool === 'draw'">
                <button class="size-btn" [class.active]="currentBrushSize === 2" (click)="setBrushSize(2)" title="Small">
                  <div class="size-preview" style="width: 4px; height: 4px;"></div>
                </button>
                <button class="size-btn" [class.active]="currentBrushSize === 5" (click)="setBrushSize(5)" title="Medium">
                  <div class="size-preview" style="width: 8px; height: 8px;"></div>
                </button>
                <button class="size-btn" [class.active]="currentBrushSize === 10" (click)="setBrushSize(10)" title="Large">
                  <div class="size-preview" style="width: 12px; height: 12px;"></div>
                </button>
              </div>
              
              <!-- Text Size (for text tool) -->
              <select class="text-size-mini" *ngIf="currentTool === 'text'" [(ngModel)]="currentTextSize" (mousedown)="$event.preventDefault()" (change)="setTextSize(currentTextSize)">
                <option [value]="12">Small</option>
                <option [value]="16">Normal</option>
                <option [value]="24">Large</option>
                <option [value]="32">XL</option>
              </select>
              
              <!-- Text Formatting (for text tool) -->
              <div class="text-formatting" *ngIf="currentTool === 'text'">
                <button class="format-btn" [class.active]="textBold" (mousedown)="$event.preventDefault()" (click)="toggleTextBold()" title="Bold">
                  <strong>B</strong>
                </button>
                <button class="format-btn" [class.active]="textItalic" (mousedown)="$event.preventDefault()" (click)="toggleTextItalic()" title="Italic">
                  <em>I</em>
                </button>
                <button class="format-btn" [class.active]="textUnderline" (mousedown)="$event.preventDefault()" (click)="toggleTextUnderline()" title="Underline">
                  <span style="text-decoration: underline;">U</span>
                </button>
              </div>
              
              <!-- Text Alignment (for text tool) -->
              <div class="text-alignment" *ngIf="currentTool === 'text'">
                <button class="align-btn" [class.active]="textAlign === 'left'" (mousedown)="$event.preventDefault()" (click)="setTextAlign('left')" title="Align Left">
                  <ion-icon name="text-outline"></ion-icon>
                </button>
                <button class="align-btn" [class.active]="textAlign === 'center'" (mousedown)="$event.preventDefault()" (click)="setTextAlign('center')" title="Center">
                  <ion-icon name="reorder-three-outline" style="transform: rotate(90deg);"></ion-icon>
                </button>
                <button class="align-btn" [class.active]="textAlign === 'right'" (mousedown)="$event.preventDefault()" (click)="setTextAlign('right')" title="Align Right">
                  <ion-icon name="text-outline" style="transform: scaleX(-1);"></ion-icon>
                </button>
              </div>
              
              <div class="tool-divider" *ngIf="currentTool === 'text'"></div>
              
              <div class="tool-divider" *ngIf="currentTool === 'draw'"></div>
              
              <!-- Colors -->
              <div class="colors-mini">
                <button class="color-mini" [class.active]="currentColor === '#000000'" (mousedown)="$event.preventDefault()" (click)="setBrushColor('#000000')" style="background: #000000" title="Black"></button>
                <button class="color-mini" [class.active]="currentColor === '#ff0000'" (mousedown)="$event.preventDefault()" (click)="setBrushColor('#ff0000')" style="background: #ff0000" title="Red"></button>
                <button class="color-mini" [class.active]="currentColor === '#2196F3'" (mousedown)="$event.preventDefault()" (click)="setBrushColor('#2196F3')" style="background: #2196F3" title="Blue"></button>
                <button class="color-mini" [class.active]="currentColor === '#4CAF50'" (mousedown)="$event.preventDefault()" (click)="setBrushColor('#4CAF50')" style="background: #4CAF50" title="Green"></button>
              </div>
              
              <div class="tool-divider"></div>
              
              <!-- Undo/Redo -->
              <button class="tool-btn" (click)="undo()" [disabled]="!canUndo()" title="Undo">
                <ion-icon name="arrow-undo-outline"></ion-icon>
              </button>
              <button class="tool-btn" (click)="redo()" [disabled]="!canRedo()" title="Redo">
                <ion-icon name="arrow-redo-outline"></ion-icon>
              </button>
              
              <div class="tool-divider"></div>
              
              <!-- Clear -->
              <button class="tool-btn danger" (click)="clearWhiteboard()" title="Clear All">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>
          </div>
          <div class="whiteboard-controls">
            <ion-button (click)="toggleWhiteboard()" size="small" fill="clear" title="Close">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
        
        <div class="whiteboard-content-fixed">
          <div class="canvas-container">
            <canvas 
              #whiteboardCanvas 
              [width]="canvasWidth"
              [height]="canvasHeight"
              [class.text-cursor]="currentTool === 'text'"
              [class.move-cursor]="currentTool === 'move'"
              (mousedown)="handleCanvasClick($event)"
              (mousemove)="handleCanvasMove($event)"
              (mouseup)="handleCanvasMouseUp($event)"
              (mouseleave)="handleCanvasMouseLeave($event)">
            </canvas>
            
            <!-- Inline text input - Rich text editor -->
            <div 
              #textInput
              *ngIf="showInlineTextInput"
              contenteditable="true"
              [style.left.px]="textInputX"
              [style.top.px]="textInputY"
              [style.font-size.px]="currentTextSize"
              [style.text-align]="textAlign"
              class="inline-text-input rich-text-input"
              [attr.data-placeholder]="'Type text here...'"
              (input)="onRichTextInput($event)"
              (blur)="onTextInputBlur()"
              (keydown)="handleTextInputKeydown($event)"
              (mouseup)="updateFormattingState()"
              (keyup)="updateFormattingState()"
              spellcheck="false"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="video-container">
        <!-- Debug info -->
        <!-- <div class="debug-info" *ngIf="isConnected">
          <p>Channel: {{channelName}} | Remote Users: {{remoteUserCount}} | Role: {{userRole}}</p>
          <div style="display: flex; gap: 4px; margin-top: 4px;">
            <button (click)="debugConnectionStatus()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">Debug</button>
            <button (click)="testMuteSync()" style="background: rgba(255,165,0,0.7); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">Test Mute</button>
          </div>
        </div> -->

    <!-- Speaker View Toggle -->
    <!-- <div class="speaker-view-toggle">
      <ion-icon name="people"></ion-icon>
      <span>Speaker View</span>
    </div> -->

    <!-- Main video area (fullscreen) -->
    <!-- 1:1 Lesson View - UNCHANGED from original -->
    <div class="main-video" *ngIf="!isClass">
      <div #remoteVideo class="video-container-remote" *ngIf="isConnected && remoteUserCount > 0; else remoteMainPlaceholder">
        <!-- Remote video will be displayed here -->
        
        <!-- Camera Off placeholder for main view -->
        <div class="video-placeholder" *ngIf="getRemoteUserVideoOffState()">
          <ion-avatar class="avatar-placeholder">
            <img *ngIf="remoteParticipantProfilePicture" [src]="remoteParticipantProfilePicture" alt="Remote participant" referrerpolicy="no-referrer">
            <ion-icon *ngIf="!remoteParticipantProfilePicture" name="person" class="avatar-icon"></ion-icon>
          </ion-avatar>
          <p>Camera Off</p>
        </div>
        
        <!-- Remote user mute indicator (overlay on main video) -->
        <div class="remote-user-info" *ngIf="remoteUserCount > 0">
          <div class="remote-user-label">
            <ion-icon [name]="getRemoteUserMuteState() ? 'mic-off-outline' : 'mic-outline'" 
                      [class.muted]="getRemoteUserMuteState()"></ion-icon>
            <span>{{getRemoteParticipantLabel()}}</span>
          </div>
        </div>
      </div>
      <ng-template #remoteMainPlaceholder>
        <div class="video-placeholder">
          <ion-icon name="person"></ion-icon>
          <p>Waiting for other participants...</p>
        </div>
      </ng-template>
    </div>

    <!-- Class View - Different layouts for tutor vs students -->
    <div class="main-video" *ngIf="isClass && !showWhiteboard">
      <!-- TUTOR VIEW: Grid of all participants -->
      <ng-container *ngIf="userRole === 'tutor'">
        <div class="tutor-gallery-view" [class.grid-2]="allParticipants.length === 2"
                                         [class.grid-3]="allParticipants.length === 3"
                                         [class.grid-4]="allParticipants.length === 4"
                                         [class.grid-5-plus]="allParticipants.length >= 5">
          <div class="gallery-tile" 
               *ngFor="let participant of allParticipants"
               [class.local-tile]="participant.isLocal"
               [class.remote-tile]="!participant.isLocal"
               [class.speaking]="participant.isSpeaking"
               [attr.data-gallery-uid]="participant.uid">
            
            <!-- Video container for local participant -->
            <div *ngIf="participant.isLocal" class="gallery-video">
              <div #localVideoGallery class="video-display"></div>
              <!-- Video placeholder shown only when video is off -->
              <div class="video-placeholder" *ngIf="isVideoOff">
                <ion-avatar class="avatar-placeholder">
                  <img *ngIf="participant.profilePicture" [src]="participant.profilePicture" alt="{{ participant.name }}" referrerpolicy="no-referrer">
                  <ion-icon *ngIf="!participant.profilePicture" name="person" class="avatar-icon"></ion-icon>
                </ion-avatar>
                <p>Camera Off</p>
              </div>
            </div>
            
            <!-- Video container for remote participants -->
            <div *ngIf="!participant.isLocal" class="gallery-video">
              <div class="video-display" [attr.id]="'gallery-video-' + participant.uid"></div>
              <!-- Video placeholder shown only when video is off -->
              <div class="video-placeholder" *ngIf="participant.isVideoOff">
                <ion-avatar class="avatar-placeholder">
                  <img *ngIf="participant.profilePicture" [src]="participant.profilePicture" alt="{{ participant.name }}" referrerpolicy="no-referrer">
                  <ion-icon *ngIf="!participant.profilePicture" name="person" class="avatar-icon"></ion-icon>
                </ion-avatar>
                <p>Camera Off</p>
              </div>
            </div>
            
            <!-- Participant label -->
            <div class="gallery-label">
              <ion-icon [name]="(participant.isLocal ? isMuted : participant.isMuted) ? 'mic-off-outline' : 'mic-outline'" 
                        [class.muted]="participant.isLocal ? isMuted : participant.isMuted"></ion-icon>
              <span>{{ participant.isLocal ? 'You' : participant.name }}</span>
            </div>
          </div>
        </div>
      </ng-container>
      
      <!-- STUDENT VIEW: Show tutor on big screen -->
      <ng-container *ngIf="userRole === 'student'">
        <div class="tutor-main-container" *ngIf="isConnected && tutorParticipant; else tutorMainPlaceholder">
          <!-- Video container -->
          <div #tutorMainVideo class="video-container-remote" *ngIf="!tutorParticipant?.isVideoOff">
            <!-- Tutor video will be displayed here -->
          </div>
          
          <!-- Camera Off placeholder for tutor main view -->
          <div class="video-placeholder" *ngIf="tutorParticipant?.isVideoOff">
            <ion-avatar class="avatar-placeholder">
              <img *ngIf="tutorParticipant?.profilePicture" [src]="tutorParticipant?.profilePicture" alt="{{ tutorParticipant?.name }}" referrerpolicy="no-referrer">
              <ion-icon *ngIf="!tutorParticipant?.profilePicture" name="person" class="avatar-icon"></ion-icon>
            </ion-avatar>
            <p>Camera Off</p>
          </div>
          
          <!-- Tutor info overlay (always visible, shows on top of video or placeholder) -->
          <div class="remote-user-info">
            <div class="remote-user-label">
              <ion-icon [name]="tutorParticipant?.isMuted ? 'mic-off-outline' : 'mic-outline'" 
                        [class.muted]="tutorParticipant?.isMuted"></ion-icon>
              <span>{{tutorParticipant?.name || 'Tutor'}}</span>
            </div>
          </div>
        </div>
        <ng-template #tutorMainPlaceholder>
          <div class="video-placeholder">
            <ion-icon name="person"></ion-icon>
            <p>Waiting for tutor...</p>
          </div>
        </ng-template>
      </ng-container>
    </div>

    <!-- Virtual Background Controls Panel -->
    <div class="virtual-bg-controls" *ngIf="showVirtualBackgroundControls">
      <div class="controls-header">
        <h3>Virtual Background</h3>
        <ion-button fill="clear" size="small" (click)="toggleVirtualBackgroundControls()">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </div>
      
      <div class="bg-options">
        <button 
          class="bg-option-btn blur-option"
          (click)="setBackgroundBlur()">
          <ion-icon name="blur"></ion-icon>
          <span>Enable Blur</span>
        </button>
        
        <button 
          class="bg-option-btn black-option"
          (click)="setBackgroundColor('#000000')">
          <div class="color-preview black"></div>
          <span>Black Background</span>
        </button>
        
        <button 
          class="bg-option-btn normal-option"
          (click)="disableVirtualBackground()">
          <ion-icon name="videocam-outline"></ion-icon>
          <span>Normal</span>
        </button>
        
        <button 
          class="bg-option-btn debug-option"
          (click)="debugForceRestore()">
          <ion-icon name="refresh-outline"></ion-icon>
          <span>Force Restore</span>
        </button>
      </div>
      
      <div class="status-info" *ngIf="isVirtualBackgroundEnabled">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
        <span>Virtual background active</span>
      </div>
    </div>

    <!-- Participants Grid (positioned in top-right corner) -->
    <!-- Hide when tutor is viewing gallery (isClass && userRole==='tutor' && !showWhiteboard) -->
    <div class="participants-grid" *ngIf="isConnected && !shouldShowTutorGallery()">
      <!-- For classes: show students only when whiteboard is closed, all participants when whiteboard is open -->
      <ng-container *ngIf="isClass">
        <!-- Iterate through filtered participants -->
        <div class="participant-tile" 
             *ngFor="let participant of filteredParticipants"
             [class.local-participant]="participant.isLocal"
             [class.remote-participant]="!participant.isLocal"
             [class.speaking]="participant.isSpeaking"
             [attr.data-participant-uid]="participant.uid">
          
          <!-- Video container for local participant -->
          <div *ngIf="participant.isLocal" #localVideo class="participant-video">
            <!-- Local video will be displayed here -->
            <!-- Video placeholder shown only when video is off -->
            <div class="video-placeholder small" *ngIf="isVideoOff">
              <ion-avatar class="avatar-placeholder small">
                <img *ngIf="participant.profilePicture" [src]="participant.profilePicture" alt="{{ participant.name }}" referrerpolicy="no-referrer">
                <ion-icon *ngIf="!participant.profilePicture" name="person" class="avatar-icon"></ion-icon>
              </ion-avatar>
              <p>Camera Off</p>
            </div>
          </div>
          
          <!-- Video container for remote participants -->
          <div *ngIf="!participant.isLocal" class="participant-video" [attr.id]="'remote-video-' + participant.uid">
            <!-- Remote video will be displayed here -->
            <!-- Video placeholder shown only when video is off -->
            <div class="video-placeholder small" *ngIf="participant.isVideoOff">
              <ion-avatar class="avatar-placeholder small">
                <img *ngIf="participant.profilePicture" [src]="participant.profilePicture" alt="{{ participant.name }}" referrerpolicy="no-referrer">
                <ion-icon *ngIf="!participant.profilePicture" name="person" class="avatar-icon"></ion-icon>
              </ion-avatar>
              <p>Camera Off</p>
            </div>
          </div>
          
          <!-- Participant label -->
          <div class="participant-label">
            <ion-icon [name]="(participant.isLocal ? isMuted : participant.isMuted) ? 'mic-off-outline' : 'mic-outline'" 
                      [class.muted]="participant.isLocal ? isMuted : participant.isMuted"></ion-icon>
            <span>{{ participant.isLocal ? 'You' : participant.name }}</span>
          </div>
        </div>
      </ng-container>
      
      <!-- For 1:1 lessons: show remote participant (when whiteboard is open) and local participant -->
      <ng-container *ngIf="!isClass">
        <!-- Remote participant tile (only show when whiteboard is open) -->
        <div class="participant-tile remote-participant" *ngIf="remoteUserCount > 0 && showWhiteboard">
          <div #remoteVideoTile class="participant-video" *ngIf="!getRemoteUserVideoOffState()">
            <!-- Remote video will be cloned here when whiteboard is open -->
          </div>
          <div class="video-placeholder small" *ngIf="getRemoteUserVideoOffState()">
            <ion-avatar class="avatar-placeholder small">
              <img *ngIf="remoteParticipantProfilePicture" [src]="remoteParticipantProfilePicture" alt="Remote participant" referrerpolicy="no-referrer">
              <ion-icon *ngIf="!remoteParticipantProfilePicture" name="person" class="avatar-icon"></ion-icon>
            </ion-avatar>
            <p>Camera Off</p>
          </div>
          <div class="participant-label">
            <ion-icon [name]="getRemoteUserMuteState() ? 'mic-off-outline' : 'mic-outline'" 
                      [class.muted]="getRemoteUserMuteState()"></ion-icon>
            <span>{{getRemoteParticipantLabel()}}</span>
          </div>
        </div>
        
        <!-- Local participant tile (always show) -->
        <div class="participant-tile local-participant">
          <div #localVideo class="participant-video" [class.hidden]="isVideoOff">
            <!-- Local video will be displayed here -->
          </div>
          <div class="video-placeholder small" *ngIf="isVideoOff">
            <ion-avatar class="avatar-placeholder small">
              <img *ngIf="myProfilePicture" [src]="myProfilePicture" alt="You" referrerpolicy="no-referrer">
              <ion-icon *ngIf="!myProfilePicture" name="person" class="avatar-icon"></ion-icon>
            </ion-avatar>
            <p>Camera Off</p>
          </div>
          <div class="participant-label">
            <ion-icon [name]="isMuted ? 'mic-off-outline' : 'mic-outline'"></ion-icon>
            <span>You</span>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Note: Whiteboard will appear as overlay, positioned via CSS -->
    </div>
    
    <!-- Chat Panel -->
    <div class="chat-panel" *ngIf="showChat">
      <div class="chat-header">
        <h3>Chat with {{getRemoteParticipantLabel()}}</h3>
        <ion-button (click)="toggleChat()" size="small" fill="clear">
          <ion-icon name="close-outline"></ion-icon>
        </ion-button>
      </div>
      
      <div class="chat-messages" #chatMessagesContainer>
        <!-- Loading state -->
        <div *ngIf="isLoadingMessages" class="loading-state">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Loading messages...</p>
        </div>
        
        <!-- Empty state -->
        <div *ngIf="!isLoadingMessages && chatMessages.length === 0" class="empty-state">
          <ion-icon name="chatbubbles-outline"></ion-icon>
          <p>No messages yet</p>
        </div>
        
        <!-- Messages -->
        <div *ngFor="let message of chatMessages" class="chat-message" 
             [class.own-message]="isMyMessage(message)"
             [class.system-message]="message.type === 'system' || message.isSystemMessage"
             [attr.data-message-id]="message.id">
          <div class="message-content"
               (mousedown)="message.type !== 'system' && !message.isSystemMessage && onMessagePressStart(message, $event)"
               (touchstart)="message.type !== 'system' && !message.isSystemMessage && onMessagePressStart(message, $event)"
               (mouseup)="onMessagePressEnd($event)"
               (touchend)="onMessagePressEnd($event)"
               (mouseleave)="onMessagePressEnd($event)"
               (touchcancel)="onMessagePressEnd($event)">
            <!-- Reply preview -->
            <div *ngIf="message.replyTo" class="reply-to-preview">
              <div class="reply-to-line"></div>
              <div class="reply-to-content">
                <span class="reply-to-sender">{{ message.replyTo.senderName }}</span>
                <span class="reply-to-text" *ngIf="message.replyTo.type === 'text'">{{ message.replyTo.content }}</span>
                <span class="reply-to-text" *ngIf="message.replyTo.type === 'image'">ðŸ“· Photo</span>
                <span class="reply-to-text" *ngIf="message.replyTo.type === 'file'">ðŸ“„ {{ message.replyTo.fileName }}</span>
                <span class="reply-to-text" *ngIf="message.replyTo.type === 'voice'">ðŸŽ¤ Voice message</span>
              </div>
            </div>
            
            <!-- Text message content -->
            <p class="message-text" *ngIf="message.content">{{message.content}}</p>
            
            <!-- Image message -->
            <div *ngIf="message.type === 'image'" class="message-image">
              <img [src]="message.fileUrl" [alt]="message.fileName" />
              <p *ngIf="message.content" class="image-caption">{{ message.content }}</p>
            </div>
            
            <!-- File message -->
            <div *ngIf="message.type === 'file'" class="message-file">
              <div class="file-info" (click)="downloadFile(message, $event)">
                <ion-icon [name]="getFileIcon(message.fileType!)" class="file-icon"></ion-icon>
                <div class="file-details">
                  <p class="file-name">{{ message.fileName }}</p>
                  <p class="file-size">{{ formatFileSize(message.fileSize!) }}</p>
                </div>
                <ion-icon name="download-outline" class="download-icon" (click)="downloadFile(message, $event)"></ion-icon>
              </div>
              <p *ngIf="message.content" class="file-caption">{{ message.content }}</p>
            </div>
            
            <!-- Voice message -->
            <div *ngIf="message.type === 'voice'" class="message-voice">
              <ion-icon name="play-circle" class="voice-icon"></ion-icon>
              <audio [src]="message.fileUrl" controls class="voice-player"></audio>
              <span class="voice-duration" *ngIf="message.duration">{{ message.duration }}s</span>
            </div>
            
            <span class="message-time">{{formatMessageTime(message.createdAt)}}</span>
          </div>
        </div>
      </div>
      
      <!-- Context Menu (Long-press) -->
      <div *ngIf="showContextMenu && contextMenuPosition" 
           class="message-context-menu"
           [class.show-below]="contextMenuPosition.showBelow"
           [style.top.px]="contextMenuPosition.top"
           [style.left.px]="contextMenuPosition.left">
        <div class="context-menu-arrow" 
             [class.arrow-top]="contextMenuPosition.showBelow"
             [class.arrow-bottom]="!contextMenuPosition.showBelow"
             [style.left.px]="contextMenuPosition.arrowOffset"></div>
        <div class="context-menu-content">
          <button class="context-menu-item" (click)="onContextMenuAction('reply')">
            <ion-icon name="arrow-undo-outline"></ion-icon>
            <span>Reply</span>
          </button>
          <button class="context-menu-item" (click)="onContextMenuAction('copy')" *ngIf="contextMenuMessage?.content">
            <ion-icon name="copy-outline"></ion-icon>
            <span>Copy</span>
          </button>
        </div>
      </div>
      
      <!-- Context Menu Backdrop -->
      <div *ngIf="showContextMenu" class="context-menu-backdrop" (click)="closeContextMenu()"></div>
      
      <!-- Reply Preview -->
      <div *ngIf="replyingToMessage" class="replying-to-container">
        <div class="replying-to-header">
          <ion-icon name="arrow-undo-outline" class="reply-icon"></ion-icon>
          <span class="replying-to-label">Replying to {{ isMyMessage(replyingToMessage) ? 'yourself' : getRemoteParticipantLabel() }}</span>
          <ion-icon name="close-outline" class="close-reply-icon" (click)="clearReply()"></ion-icon>
        </div>
        <div class="replying-to-preview">
          <span *ngIf="replyingToMessage.type === 'text'">{{ replyingToMessage.content }}</span>
          <span *ngIf="replyingToMessage.type === 'image'">ðŸ“· Photo</span>
          <span *ngIf="replyingToMessage.type === 'file'">ðŸ“„ {{ replyingToMessage.fileName }}</span>
          <span *ngIf="replyingToMessage.type === 'voice'">ðŸŽ¤ Voice message</span>
        </div>
      </div>
      
      <!-- Pending Voice Note Preview -->
      <div *ngIf="pendingVoiceNote" class="voice-preview">
        <div class="voice-preview-header">
          <ion-icon name="mic-circle"></ion-icon>
          <span class="voice-preview-label">Voice note {{ pendingVoiceNote.duration }}s</span>
        </div>
        <audio [src]="pendingVoiceNote.url" controls></audio>
        <div class="voice-preview-actions">
          <ion-button fill="clear" size="small" color="medium" (click)="clearPendingVoiceNote()">
            <ion-icon slot="start" name="trash-outline"></ion-icon>
            Discard
          </ion-button>
          <ion-button size="small" (click)="sendPendingVoiceNote()" [disabled]="isUploading">
            <ion-icon slot="start" name="send"></ion-icon>
            Send
          </ion-button>
        </div>
      </div>
      
      <div class="chat-input">
        <!-- File attachment buttons -->
        <ion-button fill="clear" size="small" (click)="triggerFileInput()" [disabled]="isUploading || isRecording">
          <ion-icon name="attach-outline"></ion-icon>
        </ion-button>
        
        <!-- Voice recording button -->
        <ion-button fill="clear" size="small" (click)="toggleVoiceRecording()" [disabled]="isUploading">
          <ion-icon [name]="isRecording ? 'stop-circle' : 'mic-outline'" [color]="isRecording ? 'danger' : ''"></ion-icon>
        </ion-button>
        
        <ion-input 
          [(ngModel)]="newMessage" 
          placeholder="Write your message..."
          (keyup.enter)="sendMessage()"
          class="message-input"
          [disabled]="isUploading || isRecording">
        </ion-input>
        
        <ion-button (click)="sendMessage()" class="send-button" fill="solid" 
                    [disabled]="!newMessage.trim() || isSending || isUploading || isRecording">
          <ion-icon name="send"></ion-icon>
        </ion-button>
        
        <!-- Upload progress indicator -->
        <div *ngIf="isUploading" class="upload-progress">
          <ion-spinner name="crescent"></ion-spinner>
          <span>Uploading...</span>
        </div>
        
        <!-- Recording indicator -->
        <div *ngIf="isRecording" class="recording-indicator">
          <ion-icon name="radio-button-on" color="danger"></ion-icon>
          <span>Recording... {{formatRecordingDuration()}}</span>
        </div>
      </div>
    </div>
    </div> <!-- End of main-content-area -->
    
    <!-- Bottom Controls (Separate from main content) -->
    <div class="video-controls">
      <ion-button (click)="toggleMute()" [color]="isMuted ? 'danger' : 'medium'" fill="clear" title="Microphone">
        <ion-icon [name]="isMuted ? 'mic-off-outline' : 'mic-outline'"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleVideo()" [color]="isVideoOff ? 'danger' : 'medium'" fill="clear" title="Camera">
        <ion-icon [name]="isVideoOff ? 'videocam-off-outline' : 'videocam-outline'"></ion-icon>
      </ion-button>
      
      <ion-button (click)="shareScreen()" color="medium" fill="clear" title="Share Screen">
        <ion-icon name="desktop-outline"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleVirtualBackgroundControls()" [color]="showVirtualBackgroundControls ? 'primary' : 'medium'" fill="clear" title="Virtual Background">
        <ion-icon name="color-filter-outline"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleWhiteboard()" [color]="showWhiteboard ? 'primary' : 'medium'" fill="clear" title="Whiteboard">
        <ion-icon name="create-outline"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleChat()" [color]="showChat ? 'primary' : 'medium'" fill="clear" title="Chat">
        <ion-icon name="chatbubbles-outline"></ion-icon>
      </ion-button>
      
      <ion-button (click)="endCall()" color="danger" fill="solid" title="End Call">
        <ion-icon name="call-outline"></ion-icon>
      </ion-button>
    </div>

  </div>
</ion-content>