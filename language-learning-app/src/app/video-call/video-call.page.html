<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Video Class</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="endCall()" color="danger">
        <ion-icon name="call"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="video-container">
        <!-- Debug info -->
        <!-- <div class="debug-info" *ngIf="isConnected">
          <p>Channel: {{channelName}} | Remote Users: {{remoteUserCount}} | Role: {{userRole}}</p>
          <div style="display: flex; gap: 4px; margin-top: 4px;">
            <button (click)="debugConnectionStatus()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">Debug</button>
            <button (click)="testMuteSync()" style="background: rgba(255,165,0,0.7); border: none; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px;">Test Mute</button>
          </div>
        </div> -->

    <!-- Speaker View Toggle -->
    <!-- <div class="speaker-view-toggle">
      <ion-icon name="people"></ion-icon>
      <span>Speaker View</span>
    </div> -->

    <!-- Main video area (fullscreen) -->
    <div class="main-video">
      <div #remoteVideo class="video-container-remote" *ngIf="isConnected && remoteUserCount > 0; else remoteMainPlaceholder">
        <!-- Remote video will be displayed here -->
        
        <!-- Remote user mute indicator (overlay on main video) -->
        <div class="remote-user-info" *ngIf="remoteUserCount > 0">
          <div class="remote-user-label">
            <ion-icon [name]="getRemoteUserMuteState() ? 'mic-off' : 'mic'" 
                      [class.muted]="getRemoteUserMuteState()"></ion-icon>
            <span>{{getRemoteParticipantLabel()}}</span>
          </div>
        </div>
      </div>
      <ng-template #remoteMainPlaceholder>
        <div class="video-placeholder">
          <ion-icon name="person"></ion-icon>
          <p>Waiting for other participants...</p>
        </div>
      </ng-template>
    </div>

    <!-- Participants Grid (top-right) -->
    <div class="participants-grid">
      <!-- Local participant tile (only show yourself in small tile) -->
      <div class="participant-tile local-participant" *ngIf="isConnected">
        <div #localVideo class="participant-video" *ngIf="!isVideoOff">
          <!-- Local video will be displayed here -->
        </div>
        <div class="video-placeholder small" *ngIf="isVideoOff">
          <ion-icon name="videocam-off"></ion-icon>
          <p>Camera Off</p>
        </div>
        <div class="participant-label">
          <ion-icon [name]="isMuted ? 'mic-off' : 'mic'"></ion-icon>
          <span>You</span>
        </div>
      </div>
      
      <!-- Note: Remote user appears in main video area, not here -->
    </div>

    <!-- Bottom Controls -->
    <div class="video-controls">
      <ion-button (click)="toggleMute()" [color]="isMuted ? 'danger' : 'medium'" fill="clear" title="Microphone">
        <ion-icon [name]="isMuted ? 'mic-off' : 'mic'"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleVideo()" [color]="isVideoOff ? 'danger' : 'medium'" fill="clear" title="Camera">
        <ion-icon [name]="isVideoOff ? 'videocam-off' : 'videocam'"></ion-icon>
      </ion-button>
      
      <ion-button (click)="shareScreen()" color="medium" fill="clear" title="Share Screen">
        <ion-icon name="desktop"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleVirtualBackgroundControls()" [color]="showVirtualBackgroundControls ? 'primary' : 'medium'" fill="clear" title="Virtual Background">
        <ion-icon name="color-filter-outline"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleWhiteboard()" [color]="showWhiteboard ? 'primary' : 'medium'" fill="clear" title="Whiteboard">
        <ion-icon name="create"></ion-icon>
      </ion-button>
      
      <ion-button (click)="toggleChat()" [color]="showChat ? 'primary' : 'medium'" fill="clear" title="Chat">
        <ion-icon name="chatbubbles"></ion-icon>
      </ion-button>
      
      <ion-button (click)="endCall()" color="danger" fill="solid" title="End Call">
        <ion-icon name="call"></ion-icon>
      </ion-button>
    </div>

    <!-- Virtual Background Controls Panel -->
    <div class="virtual-bg-controls" *ngIf="showVirtualBackgroundControls">
      <div class="controls-header">
        <h3>Virtual Background</h3>
        <ion-button fill="clear" size="small" (click)="toggleVirtualBackgroundControls()">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="bg-options">
        <ion-button 
          fill="outline" 
          size="small"
          color="primary"
          (click)="setBackgroundBlur()">
          <ion-icon name="blur" slot="start"></ion-icon>
          Enable Blur
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          color="success"
          (click)="setBackgroundColor('#00ff00')">
          <ion-icon name="square-outline" slot="start"></ion-icon>
          Green Background
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          color="danger"
          (click)="setBackgroundColor('#ff0000')">
          <ion-icon name="square-outline" slot="start"></ion-icon>
          Red Background
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          color="medium"
          (click)="disableVirtualBackground()">
          <ion-icon name="videocam-outline" slot="start"></ion-icon>
          Normal
        </ion-button>
        
        <ion-button 
          fill="outline" 
          size="small"
          color="warning"
          (click)="debugForceRestore()">
          <ion-icon name="refresh-outline" slot="start"></ion-icon>
          Force Restore
        </ion-button>
      </div>
      
      <div class="status-info" *ngIf="isVirtualBackgroundEnabled">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
        <span>Virtual background active</span>
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" *ngIf="showChat">
      <div class="chat-header">
        <h3>Chat</h3>
        <ion-button (click)="toggleChat()" size="small" fill="clear">
          <ion-icon name="close"></ion-icon>
        </ion-button>
      </div>
      
      <div class="chat-participants">
        <div class="participant-avatar">
          <div class="avatar group">
            <span>ðŸ‘¥</span>
          </div>
          <span class="participant-name">Group</span>
        </div>
        <div class="participant-avatar">
          <div class="avatar">
            <span>You</span>
          </div>
          <span class="participant-name">You</span>
        </div>
        <div class="participant-avatar" *ngIf="remoteUserCount > 0">
          <div class="avatar">
            <span>{{getRemoteParticipantLabel().charAt(0)}}</span>
            <div class="notification-badge" *ngIf="chatMessages.length > 0">{{chatMessages.length}}</div>
          </div>
          <span class="participant-name">{{getRemoteParticipantLabel()}}</span>
        </div>
      </div>
      
      <div class="chat-messages" #chatMessagesContainer>
        <div *ngFor="let message of chatMessages" class="chat-message" [class.own-message]="message.isOwn">
          <div class="message-avatar">
            <span>{{ message.isOwn ? 'Y' : getRemoteParticipantLabel().charAt(0) }}</span>
          </div>
          <div class="message-content">
            <span class="sender-name">{{message.sender}}</span>
            <p class="message-text">{{message.text}}</p>
            <span class="message-time">{{message.timestamp | date:'short'}}</span>
          </div>
        </div>
      </div>
      
      <div class="chat-input">
        <ion-button class="emoji-button" fill="clear" size="small">
          <ion-icon name="happy-outline"></ion-icon>
        </ion-button>
        <ion-input 
          [(ngModel)]="newMessage" 
          placeholder="Write your message..."
          (keyup.enter)="sendMessage()"
          class="message-input">
        </ion-input>
        <ion-button (click)="sendMessage()" class="send-button" fill="solid">
          <ion-icon name="send"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Whiteboard -->
    <div class="whiteboard" 
         [class.fullscreen]="isWhiteboardFullscreen"
         [class.dragging]="isWhiteboardDragging"
         [style.width.px]="whiteboardWidth"
         [style.height.px]="whiteboardHeight"
         [style.left.px]="whiteboardX"
         [style.top.px]="whiteboardY"
         *ngIf="showWhiteboard">
      <div class="whiteboard-header" 
           (mousedown)="startWhiteboardDrag($event)"
           [class.dragging]="isWhiteboardDragging">
        <h3>Whiteboard</h3>
        <div class="whiteboard-controls">
          <ion-button (click)="toggleFullscreen()" size="small" fill="clear" title="Fullscreen">
            <ion-icon [name]="isWhiteboardFullscreen ? 'contract' : 'expand'"></ion-icon>
          </ion-button>
          <ion-button (click)="clearWhiteboard()" size="small" fill="clear" title="Clear">
            <ion-icon name="trash"></ion-icon>
          </ion-button>
          <ion-button (click)="toggleWhiteboard()" size="small" fill="clear" title="Close">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </div>
      </div>
      
      <div class="whiteboard-content">
        <div class="canvas-container">
          <canvas 
            #whiteboardCanvas 
            [width]="canvasWidth"
            [height]="canvasHeight"
            [class.text-cursor]="currentTool === 'text'"
            [class.move-cursor]="currentTool === 'move'"
            (mousedown)="handleCanvasClick($event)"
            (mousemove)="handleCanvasMove($event)"
            (mouseup)="handleCanvasMouseUp($event)"
            (mouseleave)="handleCanvasMouseLeave($event)">
          </canvas>
          
          <!-- Inline text input -->
          <input 
            #textInput
            *ngIf="showInlineTextInput"
            type="text"
            [(ngModel)]="inlineTextValue"
            [style.left.px]="textInputX"
            [style.top.px]="textInputY"
            [style.color]="currentTextColor"
            [style.font-size.px]="currentTextSize"
            class="inline-text-input"
            (blur)="finishTextInput()"
            (keyup.enter)="finishTextInput()"
            (keyup.escape)="cancelTextInput()"
            autofocus>
        </div>
      </div>
      
      <div class="whiteboard-tools">
        <!-- Tool Selection -->
        <div class="tool-selection">
          <div class="tool-button" 
               [class.active]="currentTool === 'draw'"
               (click)="setTool('draw')"
               title="Draw">
            <ion-icon name="brush"></ion-icon>
            <span>Draw</span>
          </div>
          <div class="tool-button" 
               [class.active]="currentTool === 'text'"
               (click)="setTool('text')"
               title="Add Text">
            <ion-icon name="text"></ion-icon>
            <span>Text</span>
          </div>
          <div class="tool-button" 
               [class.active]="currentTool === 'move'"
               (click)="setTool('move')"
               title="Move Elements">
            <ion-icon name="move"></ion-icon>
            <span>Move</span>
          </div>
        </div>
        
        <!-- Color Picker -->
        <div class="color-picker-section">
          <div class="section-label">Color</div>
          <div class="color-picker">
            <div class="color-option" 
                 [class.active]="currentColor === '#000000'"
                 (click)="setBrushColor('#000000')"
                 style="background-color: #000000"></div>
            <div class="color-option" 
                 [class.active]="currentColor === '#ff0000'"
                 (click)="setBrushColor('#ff0000')"
                 style="background-color: #ff0000"></div>
            <div class="color-option" 
                 [class.active]="currentColor === '#2196F3'"
                 (click)="setBrushColor('#2196F3')"
                 style="background-color: #2196F3"></div>
            <div class="color-option" 
                 [class.active]="currentColor === '#4CAF50'"
                 (click)="setBrushColor('#4CAF50')"
                 style="background-color: #4CAF50"></div>
            <div class="color-option" 
                 [class.active]="currentColor === '#ffeb3b'"
                 (click)="setBrushColor('#ffeb3b')"
                 style="background-color: #ffeb3b"></div>
            <div class="color-option" 
                 [class.active]="currentColor === '#ff9800'"
                 (click)="setBrushColor('#ff9800')"
                 style="background-color: #ff9800"></div>
            <div class="color-option" 
                 [class.active]="currentColor === '#9c27b0'"
                 (click)="setBrushColor('#9c27b0')"
                 style="background-color: #9c27b0"></div>
            <div class="color-option" 
                 [class.active]="currentColor === '#795548'"
                 (click)="setBrushColor('#795548')"
                 style="background-color: #795548"></div>
          </div>
        </div>
        
        <!-- Brush Size -->
        <div class="brush-size-section" *ngIf="currentTool === 'draw'">
          <div class="section-label">Brush Size</div>
          <div class="brush-sizes">
            <div class="brush-option" 
                 [class.active]="currentBrushSize === 2"
                 (click)="setBrushSize(2)">
              <div class="brush-preview" style="width: 4px; height: 4px;"></div>
            </div>
            <div class="brush-option" 
                 [class.active]="currentBrushSize === 5"
                 (click)="setBrushSize(5)">
              <div class="brush-preview" style="width: 8px; height: 8px;"></div>
            </div>
            <div class="brush-option" 
                 [class.active]="currentBrushSize === 10"
                 (click)="setBrushSize(10)">
              <div class="brush-preview" style="width: 12px; height: 12px;"></div>
            </div>
            <div class="brush-option" 
                 [class.active]="currentBrushSize === 15"
                 (click)="setBrushSize(15)">
              <div class="brush-preview" style="width: 16px; height: 16px;"></div>
            </div>
          </div>
        </div>
        
        <!-- Text Size -->
        <div class="text-size-section" *ngIf="currentTool === 'text'">
          <div class="section-label">Text Size</div>
          <div class="text-sizes">
            <div class="text-option" 
                 [class.active]="currentTextSize === 16"
                 (click)="setTextSize(16)"
                 style="font-size: 14px;">A</div>
            <div class="text-option" 
                 [class.active]="currentTextSize === 24"
                 (click)="setTextSize(24)"
                 style="font-size: 18px;">A</div>
            <div class="text-option" 
                 [class.active]="currentTextSize === 32"
                 (click)="setTextSize(32)"
                 style="font-size: 22px;">A</div>
            <div class="text-option" 
                 [class.active]="currentTextSize === 48"
                 (click)="setTextSize(48)"
                 style="font-size: 26px;">A</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content>